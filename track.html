<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ØªØªØ¨Ø¹ Ø·Ù„Ø¨Ùƒ - Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: "Tajawal", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f6f4f0;
      color: #3e2420;
    }
    .page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 24px 12px 40px;
    }
    .card {
      width: 100%;
      max-width: 720px;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      padding: 20px 18px 24px;
      box-sizing: border-box;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 18px;
    }
    .brand-mark {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: linear-gradient(135deg, #3e2420, #bc8f74);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 700;
      font-size: 20px;
    }
    .brand-text-title {
      font-weight: 700;
      font-size: 18px;
      color: #3e2420;
    }
    .brand-text-sub {
      font-size: 13px;
      color: #7b6a63;
    }
    .search-section {
      margin-bottom: 18px;
      background: #fff8ef;
      border-radius: 12px;
      padding: 12px 14px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    .search-section label {
      font-size: 13px;
      color: #5b4035;
      font-weight: 600;
    }
    .search-input-wrap {
      flex: 1 1 200px;
      display: flex;
      gap: 8px;
    }
    .search-input-wrap input {
      flex: 1;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #d4c4b8;
      font-size: 14px;
      outline: none;
    }
    .search-input-wrap input:focus {
      border-color: #bc8f74;
      box-shadow: 0 0 0 2px rgba(188,143,116,0.25);
    }
    .btn {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.2s;
    }
    .btn-primary {
      background: linear-gradient(135deg, #3e2420, #bc8f74);
      color: #fff;
      box-shadow: 0 4px 14px rgba(62,36,32,0.35);
    }
    .btn-primary:active {
      transform: translateY(1px);
      box-shadow: 0 2px 8px rgba(62,36,32,0.35);
    }
    .status-bar {
      margin-top: 4px;
      font-size: 13px;
      color: #7b6a63;
      min-height: 18px;
    }
    .section-title {
      font-size: 15px;
      font-weight: 700;
      margin: 14px 0 8px;
      display: flex;
      align-items: center;
      gap: 6px;
      color: #3e2420;
    }
    .section-title span.icon-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #bc8f74;
      display: inline-block;
    }
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 8px 12px;
      margin-bottom: 6px;
    }
    .info-item {
      padding: 8px 10px;
      border-radius: 10px;
      background: #faf3ea;
      border: 1px solid #e4d6c8;
    }
    .info-label {
      font-size: 11px;
      color: #7b6a63;
      margin-bottom: 3px;
    }
    .info-value {
      font-size: 13px;
      font-weight: 600;
      color: #3e2420;
      word-break: break-word;
    }
    .car-box {
      margin-top: 8px;
      border-radius: 12px;
      background: linear-gradient(135deg, #3e2420 0%, #5b4035 45%, #bc8f74 100%);
      padding: 12px 14px;
      color: #fff;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    .car-main {
      font-size: 14px;
      font-weight: 700;
    }
    .car-meta {
      font-size: 12px;
      opacity: 0.9;
    }
    .timeline {
      margin-top: 10px;
      padding-top: 8px;
      border-top: 1px solid #e5d6c7;
    }
    .timeline-title {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 6px;
    }
    .timeline-steps {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .timeline-step {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 8px 0;
    }
    .timeline-step:not(:last-child) {
      border-bottom: 1px dashed #e0d0c2;
    }
    .step-icon {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 2px solid #bc8f74;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      flex-shrink: 0;
    }
    .step-icon.done {
      background: #16a34a;
      border-color: #16a34a;
      color: #fff;
    }
    .step-body {
      flex: 1;
    }
    .step-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 2px;
    }
    .step-sub {
      font-size: 11px;
      color: #7b6a63;
    }
    .empty-state {
      padding: 14px 10px 6px;
      font-size: 13px;
      color: #7b6a63;
    }
    .cars-tabs {
      margin: 6px 0 4px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .car-tab {
      border-radius: 999px;
      border: 1px solid #e4d6c8;
      background: #f9f2ea;
      color: #5b4035;
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer;
      font-family: inherit;
      transition: background 0.15s ease, color 0.15s.ease, border-color 0.15s ease;
    }
    .car-tab.active {
      background: #3e2420;
      color: #fff;
      border-color: #3e2420;
    }
    .status-summary {
      font-size: 12px;
      color: #7b6a63;
      margin-top: 4px;
      margin-bottom: 8px;
      line-height: 1.6;
    }
    .status-summary strong {
      color: #3e2420;
    }
    .progress-wrapper {
      margin: 4px 0 10px;
    }
    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: #5b4035;
      margin-bottom: 4px;
    }
    .progress-percent-strong {
      font-weight: 700;
    }
    .progress-bar {
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: #f0e3d6;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, #bc8f74, #3e2420);
      width: 0%;
      transition: width 0.3s ease;
    }
    @media (max-width: 480px) {
      .card { padding: 16px 14px 20px; }
      .brand-text-title { font-size: 16px; }
      .search-section { padding: 10px 10px; }
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="card">
      <div class="brand">
        <div class="brand-mark">â˜…</div>
        <div>
          <div class="brand-text-title">ØªØªØ¨Ø¹ Ø·Ù„Ø¨Ùƒ</div>
          <div class="brand-text-sub">Ù…Ø¹ Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øªâ€¦ Ø£Ù†Øª Ù†Ø¬Ù… Ø§Ù„Ø·Ø±ÙŠÙ‚ âœ¨</div>
        </div>
      </div>

      <div class="search-section">
        <div><label for="vinInput">Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ (Ø§Ù„Ø´Ø§ØµÙŠ):</label></div>
        <div class="search-input-wrap">
          <input id="vinInput" type="text" placeholder="Ù…Ø«Ø§Ù„: KMHXXXXXXXXXXXXX" />
          <button id="searchBtn" class="btn btn-primary">ğŸ” ØªØªØ¨Ø¹</button>
        </div>
        <div class="status-bar" id="statusBar"></div>
      </div>

      <div id="resultContainer">
        <div class="empty-state">
          Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ ÙˆØ§Ø¶ØºØ· "ØªØªØ¨Ø¹" Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø·Ù„Ø¨Ùƒ ÙˆØ­Ø§Ù„Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©.
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    console.log("TRACK v3 merged-stages 2025-12-07");

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
    import {
      getFirestore,
      doc,
      getDoc,
      collection,
      query,
      where,
      getDocs
    } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCorGtT5_Z68jCtLODvqnv0Fb7QW5eR6MQ",
      authDomain: "mzj-tracking.firebaseapp.com",
      projectId: "mzj-tracking",
      storageBucket: "mzj-tracking.appspot.com",
      messagingSenderId: "655452217491",
      appId: "1:655452217491:web:9348d172c47bdd411fad66"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    const vinInput        = document.getElementById("vinInput");
    const searchBtn       = document.getElementById("searchBtn");
    const statusBar       = document.getElementById("statusBar");
    const resultContainer = document.getElementById("resultContainer");

    function setStatus(msg, isError = false) {
      statusBar.textContent = msg || "";
      statusBar.style.color = isError ? "#b00020" : "#7b6a63";
    }

    function renderEmptyState() {
      resultContainer.innerHTML = `
        <div class="empty-state">
          Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ ÙˆØ§Ø¶ØºØ· "ØªØªØ¨Ø¹" Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø·Ù„Ø¨Ùƒ ÙˆØ­Ø§Ù„Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©.
        </div>
      `;
    }

    const STAGES = [
      { title: "1) Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡. (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)", sub: "ÙŠØªÙ… ØªÙ‚Ø¯ÙŠÙ… Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¡ Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ù…Ù† Ø®Ù„Ø§Ù„ Ø§Ù„Ù…Ø¹Ø±Ø¶ Ø£Ùˆ Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©." },
      { title: "2) Ø¥ÙŠØµØ§Ù„ Ø§Ù„Ø¯ÙØ¹. (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)", sub: "ÙŠØªÙ… Ø¥ØµØ¯Ø§Ø± Ø£Ùˆ Ø§Ø³ØªÙ„Ø§Ù… Ø¥ÙŠØµØ§Ù„ Ø§Ù„Ø¯ÙØ¹ (ØªØ­ÙˆÙŠÙ„ / Ø´Ø¨ÙƒØ© / ÙƒØ§Ø´) ÙˆØ±Ø¨Ø·Ù‡ Ø¨Ø§Ù„Ø·Ù„Ø¨." },
      { title: "3) Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ù† Ù‚ÙØ¨Ù„ Ù…Ù…Ø«Ù„ÙŠ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø¨Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¬Ø±ÙƒÙŠØ©. (Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø¹Ø±Ø¶)", sub: "ÙŠØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ ÙØ±ÙŠÙ‚ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ù„Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¬Ø±ÙƒÙŠØ©." },
      { title: "4) Ø³Ø¯Ø§Ø¯ Ø±Ø³ÙˆÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„. (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)", sub: "ØªØ³Ø¯ÙŠØ¯ Ø±Ø³ÙˆÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø±Ø³Ù…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ø¥ØªÙ…Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©." },
      { title: "5) Ø§Ù„ØªØ£Ù…ÙŠÙ† - Ø´Ø±Ø· Ø§Ù„Ø±Ø¨Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ³ØªÙ…. (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)", sub: "Ø§Ø®ØªÙŠØ§Ø± Ø´Ø±ÙƒØ© Ø§Ù„ØªØ£Ù…ÙŠÙ† ÙˆØ¥ØµØ¯Ø§Ø± Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© ÙˆØ±Ø¨Ø·Ù‡Ø§ Ø¨Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±ÙˆØ±." },
      { title: "6) Ø¥Ø³ØªÙŠÙØ§Ø¡ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©. (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)", sub: "Ø³Ø¯Ø§Ø¯ Ø£ÙŠ Ù…Ø¨Ø§Ù„Øº Ù…ØªØ¨Ù‚ÙŠØ© Ø¹Ù„Ù‰ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø¨Ø­Ø³Ø¨ Ø§Ù„Ø§ØªÙØ§Ù‚." },
      { title: "7) Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù„ÙˆØ­Ø§Øª Ø£Ùˆ Ù†Ù‚Ù„ Ø§Ù„Ù…Ù„ÙƒÙŠØ©. (Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø¹Ø±Ø¶)", sub: "Ø¥ØµØ¯Ø§Ø± Ù„ÙˆØ­Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù…Ø±ÙƒØ¨Ø© Ø£Ùˆ Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ù†Ù‚Ù„ Ø§Ù„Ù…Ù„ÙƒÙŠØ©." },
      { title: "8) Ø¥Ø³ØªÙŠÙØ§Ø¡ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©. (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)", sub: "Ø§Ø³ØªÙƒÙ…Ø§Ù„ ÙˆØªØ³Ù„ÙŠÙ… Ø£ÙŠ Ø£ÙˆØ±Ø§Ù‚ Ø£Ùˆ Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù…Ø·Ù„ÙˆØ¨Ø©." },
      { title: "9) Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ù„Ù„Ø¥Ø³ØªÙ„Ø§Ù…. (Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø¹Ø±Ø¶)", sub: "ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ù„Ù„ØªØ³Ù„ÙŠÙ… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø£Ùˆ Ù„Ù„Ø´Ø­Ù† Ø­Ø³Ø¨ Ø§Ø®ØªÙŠØ§Ø±Ùƒ." },
      { title: "10) Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­.", sub: "ØªÙ… ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ù„Ùƒ Ø¨Ù†Ø¬Ø§Ø­ ÙˆØ¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø·Ù„Ø¨. Ù†ØªÙ…Ù†Ù‰ Ù„Ùƒ Ø±Ø­Ù„Ø© Ø¢Ù…Ù†Ø© ÙˆØ³Ø¹ÙŠØ¯Ø©." }
    ];

    function parseAmountFront(value) {
      if (value === null || value === undefined || value === "-") return null;
      if (typeof value === "number") return value;
      const s = String(value).replace(/[^\d.,\-]/g, "").replace(/,/g, "");
      const n = parseFloat(s);
      return isNaN(n) ? null : n;
    }

    function formatAmount(val) {
      if (val === null || val === undefined || val === "") return "-";
      if (typeof val === "number") {
        return val.toLocaleString("ar-SA", { minimumFractionDigits: 2 });
      }
      const n = parseAmountFront(val);
      if (n === null) return val;
      return n.toLocaleString("ar-SA", { minimumFractionDigits: 2 });
    }

    // Ø¯Ù…Ø¬ Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ø¯ÙˆÙƒÙŠÙˆÙ…Ù†Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ + public/status + legacy
    async function fetchMergedStatus(orderBase, itemNo, rawVin) {
      if (!orderBase) return null;

      const docIds = [];
      if (orderBase.includes("_")) {
        // orderBase Ù†ÙØ³Ù‡ ÙÙŠÙ‡ _1
        docIds.push(orderBase);
      } else {
        // Ø¨Ø¯ÙˆÙ† _ â†’ Ù†Ø¨Ù†ÙŠ {orderBase}_{itemNo}
        docIds.push(`${orderBase}_${itemNo || 1}`);
      }
      // ÙƒÙ…Ø§Ù† Ù†Ø¬Ø±Ø¨ Ø§Ù„Ø¯ÙˆÙƒÙŠÙˆÙ…Ù†Øª Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¨Ø¯ÙˆÙ† _1
      if (!docIds.includes(orderBase)) {
        docIds.push(orderBase);
      }

      const merged = { stages: {} };

      // 1) Ø§Ù„Ø¯ÙˆÙƒÙŠÙˆÙ…Ù†Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ orders/{docId}
      for (const dId of docIds) {
        try {
          const rootRef  = doc(db, "orders", dId);
          const rootSnap = await getDoc(rootRef);
          if (rootSnap.exists()) {
            const d = rootSnap.data();
            if (d.currentStage) merged.currentStage = d.currentStage;
            if (d.updatedAt)    merged.updatedAt    = d.updatedAt;
            if (d.stages)       merged.stages       = { ...merged.stages, ...d.stages };
          }
        } catch (e) {
          console.error("Error reading root order doc", dId, e);
        }
      }

      // 2) public/status Ù„ÙƒÙ„ docId
      for (const dId of docIds) {
        try {
          const stRef  = doc(db, "orders", dId, "public", "status");
          const stSnap = await getDoc(stRef);
          if (stSnap.exists()) {
            const s = stSnap.data();
            if (s.currentStage) merged.currentStage = s.currentStage;
            if (s.updatedAt)    merged.updatedAt    = s.updatedAt;
            if (s.stages)       merged.stages       = { ...merged.stages, ...s.stages };
          }
        } catch (e2) {
          console.error("Error reading public/status", dId, e2);
        }
      }

      // 3) legacy: orders/{orderBase}/public/{vin} + /public/status
      try {
        const vinRef  = doc(db, "orders", orderBase, "public", rawVin);
        const vinSnap = await getDoc(vinRef);
        if (vinSnap.exists()) {
          const v = vinSnap.data();
          if (v.currentStage && !merged.currentStage) merged.currentStage = v.currentStage;
          if (v.updatedAt && !merged.updatedAt)       merged.updatedAt    = v.updatedAt;
          if (v.stages) merged.stages = { ...merged.stages, ...v.stages };
        }
        const fbRef  = doc(db, "orders", orderBase, "public", "status");
        const fbSnap = await getDoc(fbRef);
        if (fbSnap.exists()) {
          const f = fbSnap.data();
          if (f.currentStage && !merged.currentStage) merged.currentStage = f.currentStage;
          if (f.updatedAt && !merged.updatedAt)       merged.updatedAt    = f.updatedAt;
          if (f.stages) merged.stages = { ...merged.stages, ...f.stages };
        }
      } catch (e3) {
        console.error("Error reading legacy status", e3);
      }

      return merged;
    }

    function buildTimelineHtml(statusData) {
      const track        = statusData || {};
      const currentStage = track.currentStage || 0;
      const stagesMap    = track.stages || {};
      const updatedAt    = track.updatedAt
        ? new Date(track.updatedAt.toDate ? track.updatedAt.toDate() : track.updatedAt).toLocaleString("ar-SA")
        : "";

      let doneCount = 0;
      for (let i = 1; i <= STAGES.length; i++) {
        if (stagesMap["s" + i]) doneCount++;
      }
      const progress      = doneCount * (100 / STAGES.length);
      const progressFixed = Math.round(progress);

      let currentStageLabel;
      if (currentStage > 0 && currentStage <= STAGES.length) {
        currentStageLabel = STAGES[currentStage - 1].title;
      } else if (currentStage === 0) {
        currentStageLabel = "Ù„Ù… ÙŠØ¨Ø¯Ø£ Ø¨Ø¹Ø¯";
      } else {
        currentStageLabel = "Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ø¯ÙŠØ«";
      }

      return `
        <div class="status-summary">
          <div>Ø­Ø§Ù„Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <strong>${currentStageLabel}</strong></div>
          <div>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« Ù„Ù„Ø­Ø§Ù„Ø©: <span>${updatedAt || "-"}</span></div>
        </div>
        <div class="progress-wrapper">
          <div class="progress-header">
            <span>Ù†Ø³Ø¨Ø© Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</span>
            <span class="progress-percent-strong">${progressFixed}%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" style="width:${progressFixed}%;"></div>
          </div>
        </div>
        <div class="timeline">
          <div class="timeline-title">Ù…Ø±Ø§Ø­Ù„ Ø·Ù„Ø¨Ùƒ Ù…Ù† Ø£ÙˆÙ„ Ø­Ø¬Ø² Ø­ØªÙ‰ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©</div>
          <ul class="timeline-steps">
            ${STAGES.map((step, idx) => {
              const stepIndex = idx + 1;
              const doneTs    = stagesMap["s" + stepIndex];
              const isDone    = !!doneTs;
              const tsLabel   = doneTs
                ? new Date(doneTs.toDate ? doneTs.toDate() : doneTs).toLocaleString("ar-SA")
                : "";
              return `
                <li class="timeline-step">
                  <div class="step-icon ${isDone ? "done" : ""}">
                    ${isDone ? "âœ“" : stepIndex}
                  </div>
                  <div class="step-body">
                    <div class="step-title">${step.title}</div>
                    <div class="step-sub">
                      ${step.sub}
                      ${tsLabel ? " â€” <span>ØªÙ… ÙÙŠ: ${tsLabel}</span>" : ""}
                    </div>
                  </div>
                </li>
              `;
            }).join("")}
          </ul>
        </div>
      `;
    }

    function updateStatusUIForCar(statusData) {
      const timelineArea = resultContainer.querySelector("#timelineArea");
      if (timelineArea) {
        timelineArea.innerHTML = buildTimelineHtml(statusData || {});
      }
    }

    function renderSingleCar(vinData, statusData) {
      const lastOrderNo = vinData.lastOrderNo || "";
      const payload     = vinData.lastData || {};
      const customerName = payload.customerName || "";
      const branch       = payload.branch || "";

      const item     = payload.item || {};
      const carType  = item.type || "";
      const carCat   = item.category || "";
      const carModel = item.model || "";
      const extColor = item.exteriorColor || item.extColor || "";
      const intColor = item.interiorColor || item.intColor || "";
      const dealer   = item.dealer || "";
      const vin      = item.vin || "";

      const totals        = payload.totals || {};
      const subtotalExcl  = totals.subtotalExclVAT || totals.SubtotalExclVAT || "";
      const taxName       = totals.taxName || totals.TaxName || "";
      const taxValue      = totals.taxValue || totals.TaxValue || "";
      const totalInclVAT  = totals.orderTotalInclVAT || totals.totalInclVAT || totals.TotalInclVAT || "";

      resultContainer.innerHTML = `
        <div>
          <div class="section-title"><span class="icon-dot"></span><span>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨</span></div>
          <div class="info-grid">
            <div class="info-item"><div class="info-label">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</div><div class="info-value">${lastOrderNo || "-"}</div></div>
            <div class="info-item"><div class="info-label">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</div><div class="info-value">${customerName || "-"}</div></div>
            <div class="info-item"><div class="info-label">Ø§Ù„ÙØ±Ø¹</div><div class="info-value">${branch || "-"}</div></div>
            <div class="info-item">
              <div class="info-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø·Ù„Ø¨ (Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)</div>
              <div class="info-value">${totalInclVAT ? formatAmount(totalInclVAT) + " Ø±.Ø³" : "-"}</div>
            </div>
          </div>

          <div class="section-title"><span class="icon-dot"></span><span>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø©</span></div>
          <div class="car-box">
            <div class="car-main">${carType || "-"} ${carCat || ""} ${carModel || ""}</div>
            <div class="car-meta">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„: ${vin || "-"}</div>
            <div class="car-meta">Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ: ${extColor || "-"} â€“ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ: ${intColor || "-"}</div>
            <div class="car-meta">Ø§Ù„ÙˆÙƒÙŠÙ„: ${dealer || "-"}</div>
            <div class="car-meta">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©: ${subtotalExcl || "-"}</div>
            <div class="car-meta">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©${taxName ? " (" + taxName + ")" : ""}: ${taxValue || "-"}</div>
            <div class="car-meta">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©: ${totalInclVAT ? formatAmount(totalInclVAT) + " Ø±.Ø³" : "-"}</div>
          </div>

          <div class="section-title"><span class="icon-dot"></span><span>Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</span></div>
          <div id="timelineArea">
            ${buildTimelineHtml(statusData || {})}
          </div>
        </div>
      `;
    }

    function renderMultiResult(orderInfo, cars, activeIndex) {
      if (!cars || !cars.length) { renderEmptyState(); return; }
      if (activeIndex < 0 || activeIndex >= cars.length) activeIndex = 0;

      function renderCarBox(car) {
        return `
          <div class="car-box">
            <div class="car-main">${car.label || "-"}</div>
            <div class="car-meta">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„: ${car.vin || "-"}</div>
            <div class="car-meta">Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ: ${car.extColor || "-"} â€“ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ: ${car.intColor || "-"}</div>
            <div class="car-meta">Ø§Ù„ÙˆÙƒÙŠÙ„: ${car.dealer || "-"}</div>
            <div class="car-meta">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©: ${formatAmount(car.subtotal)} Ø±.Ø³</div>
            <div class="car-meta">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©${car.taxName ? " (" + car.taxName + ")" : ""}: ${formatAmount(car.taxValue)} Ø±.Ø³</div>
            <div class="car-meta">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©: ${formatAmount(car.total)} Ø±.Ø³</div>
          </div>
        `;
      }

      const orderTotal = cars.reduce((sum, car) => {
        const v = parseAmountFront(car.total);
        return sum + (v || 0);
      }, 0);

      const orderHeaderHtml = `
        <div class="section-title"><span class="icon-dot"></span><span>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨</span></div>
        <div class="info-grid">
          <div class="info-item"><div class="info-label">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</div><div class="info-value">${orderInfo.orderNo || "-"}</div></div>
          <div class="info-item"><div class="info-label">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</div><div class="info-value">${orderInfo.customerName || "-"}</div></div>
          <div class="info-item"><div class="info-label">Ø§Ù„ÙØ±Ø¹</div><div class="info-value">${orderInfo.branch || "-"}</div></div>
          <div class="info-item">
            <div class="info-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø·Ù„Ø¨ (Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)</div>
            <div class="info-value">${orderTotal ? formatAmount(orderTotal) + " Ø±.Ø³" : "-"}</div>
          </div>
        </div>
      `;

      const tabsHtml = `
        <div class="section-title"><span class="icon-dot"></span><span>Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨</span></div>
        <div class="cars-tabs">
          ${cars.map((car, idx) => `
            <button class="car-tab ${idx === activeIndex ? "active" : ""}" data-idx="${idx}">
              Ø³ÙŠØ§Ø±Ø© ${idx + 1} â€“ ${(car.label || car.vin || "").slice(0, 40)}
            </button>
          `).join("")}
        </div>
        <div id="carDetailsArea">${renderCarBox(cars[activeIndex])}</div>
      `;

      const timelineWrapper = `
        <div class="section-title"><span class="icon-dot"></span><span>Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</span></div>
        <div id="timelineArea"></div>
      `;

      resultContainer.innerHTML = `<div>${orderHeaderHtml}${tabsHtml}${timelineWrapper}</div>`;

      const tabs = resultContainer.querySelectorAll(".car-tab");
      const carDetailsArea = resultContainer.querySelector("#carDetailsArea");
      updateStatusUIForCar(cars[activeIndex].statusData || {});

      tabs.forEach(tab => {
        tab.addEventListener("click", () => {
          const idx = parseInt(tab.getAttribute("data-idx"), 10);
          tabs.forEach(t => t.classList.remove("active"));
          tab.classList.add("active");
          carDetailsArea.innerHTML = renderCarBox(cars[idx]);
          updateStatusUIForCar(cars[idx].statusData || {});
        });
      });
    }

    async function handleSearch() {
      const rawVin = (vinInput.value || "").trim();
      if (!rawVin) {
        setStatus("Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø£ÙˆÙ„Ø§Ù‹.", true);
        renderEmptyState();
        return;
      }

      setStatus("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø±ØªØ¨Ø· Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…â€¦");

      try {
        const vinDocRef = doc(db, "erp_vins", rawVin);
        const vinSnap   = await getDoc(vinDocRef);
        if (!vinSnap.exists()) {
          setStatus("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø·Ù„Ø¨ Ù…Ø±ØªØ¨Ø· Ø¨Ù‡Ø°Ø§ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„.", true);
          renderEmptyState();
          return;
        }

        const vinData      = vinSnap.data();
        const orderBase    = vinData.lastOrderNo || vinData.orderNo || "";
        const itemNoForVin = vinData.lastItemNo || vinData.itemNo || 1;

        if (!orderBase) {
          setStatus("ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ§Ø±Ø©ØŒ Ù„ÙƒÙ† Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…Ø³Ø¬Ù„.", true);
          renderEmptyState();
          return;
        }

        // Ø­Ø§Ù„Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ù…ÙØ¯Ù…Ø¬Ø© Ù…Ù† ÙƒÙ„ Ø§Ù„Ù…ØµØ§Ø¯Ø±)
        const statusForVin = await fetchMergedStatus(orderBase, itemNoForVin, rawVin);

        // Ù‡Ù„ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠÙ‡ Ø£ÙƒØ«Ø± Ù…Ù† Ø³ÙŠØ§Ø±Ø©ØŸ
        let handledMulti = false;
        try {
          const vinsCol = collection(db, "erp_vins");
          const q = query(vinsCol, where("lastOrderNo", "==", orderBase));
          const qsnap = await getDocs(q);

          if (!qsnap.empty && qsnap.docs.length > 1) {
            const vinDocs = qsnap.docs.map(d => ({ id: d.id, data: d.data() }));
            const first   = vinDocs[0].data;
            const firstPayload = first.lastData || {};
            const orderInfo = {
              orderNo: first.lastOrderNo || first.orderNo || "",
              customerName: firstPayload.customerName || "",
              branch: firstPayload.branch || ""
            };

            const cars = [];
            for (const row of vinDocs) {
              const d       = row.data;
              const payload = d.lastData || {};
              const item    = payload.item || {};
              const totals  = payload.totals || {};

              const vin      = row.id;
              const itemNo   = d.lastItemNo || payload.itemNo || 1;
              const carType  = item.type || "";
              const carCat   = item.category || "";
              const carModel = item.model || "";
              const extColor = item.exteriorColor || item.extColor || "";
              const intColor = item.interiorColor || item.intColor || "";
              const dealer   = item.dealer || payload.dealer || "";

              const subtotal = totals.subtotalExclVAT ?? totals.SubtotalExclVAT ?? "";
              const total    = totals.totalInclVAT ?? totals.TotalInclVAT ?? "";
              const taxName  = totals.taxName ?? totals.TaxName ?? "";
              const taxValue = totals.taxValue ?? totals.TaxValue ?? "";

              const statusData = await fetchMergedStatus(orderBase, itemNo, vin);

              cars.push({
                vin,
                itemNo,
                label: [carType, carCat, carModel].filter(Boolean).join(" "),
                carType,
                carCategory: carCat,
                carModel,
                extColor,
                intColor,
                dealer,
                subtotal,
                total,
                taxName,
                taxValue,
                statusData
              });
            }

            let activeIndex = 0;
            const norm = rawVin.replace(/\s+/g, "").toLowerCase();
            const idx  = cars.findIndex(c => (c.vin || "").replace(/\s+/g, "").toLowerCase() === norm);
            if (idx >= 0) activeIndex = idx;

            renderMultiResult(orderInfo, cars, activeIndex);
            setStatus(`ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨. Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ${cars.length} Ø³ÙŠØ§Ø±Ø©.`);
            handledMulti = true;
          }
        } catch (eMulti) {
          console.error("Error checking multi-car order:", eMulti);
        }

        if (!handledMulti) {
          renderSingleCar(vinData, statusForVin || {});
          setStatus("ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨. ÙŠØªÙ… Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø©.");
        }

      } catch (err) {
        console.error("Error fetching VIN:", err);
        setStatus("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ø§Ù‹.", true);
        renderEmptyState();
      }
    }

    searchBtn.addEventListener("click", handleSearch);
    vinInput.addEventListener("keydown", e => {
      if (e.key === "Enter") handleSearch();
    });
  </script>
</body>
</html>
