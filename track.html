<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ØªØªØ¨Ø¹ Ø·Ù„Ø¨Ùƒ Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ â€“ Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet" />
  <style>
    :root{
      --brown:#3e2420;
      --beige:#bc8f74;
      --cream:#fff8ef;
      --text:#111827;
      --muted:#6b7280;
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Tajawal",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#fffdf8 0,#fff3e6 40%,#fbe9da 70%,#f5e3d3 100%);
      color:var(--text);
      line-height:1.7;
    }
    .topbar{
      background:var(--brown);
      color:#fff;
      padding:10px 20px;
      text-align:center;
      box-shadow:0 4px 14px rgba(0,0,0,.25);
      position:sticky;
      top:0;
      z-index:20;
    }
    .topbar h1{
      margin:0;
      font-size:18px;
      font-weight:800;
    }
    .topbar span{
      font-size:13px;
      opacity:.9;
    }
    .wrap{
      max-width:900px;
      margin:20px auto 36px;
      padding:0 14px;
    }
    .card{
      background:#fff;
      border-radius:var(--radius);
      box-shadow:0 14px 40px rgba(62,36,32,.14);
      padding:16px 18px 18px;
      margin-bottom:16px;
    }
    .card-title{
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom:10px;
      color:var(--brown);
    }
    .card-title span.icon{
      width:26px;
      height:26px;
      border-radius:999px;
      background:rgba(188,143,116,.18);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:16px;
    }
    .card-title span.txt{
      font-size:17px;
      font-weight:700;
    }
    .card-sub{
      font-size:13px;
      color:var(--muted);
      margin-bottom:10px;
    }

    label{
      display:block;
      font-size:13px;
      color:var(--muted);
      margin-bottom:4px;
    }
    .search-row{
      display:grid;
      grid-template-columns:2fr 1fr;
      gap:10px;
    }
    @media(max-width:700px){
      .search-row{grid-template-columns:1fr;}
    }
    input[type="text"]{
      width:100%;
      padding:9px 11px;
      border-radius:10px;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      font-family:inherit;
      font-size:14px;
      outline:none;
    }
    input[type="text"]:focus{
      border-color:var(--beige);
      background:#fff;
      box-shadow:0 0 0 1px rgba(188,143,116,.45);
    }
    .btn{
      border:0;
      border-radius:999px;
      padding:9px 18px;
      font-family:inherit;
      font-size:14px;
      background:var(--brown);
      color:#fff;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      white-space:nowrap;
    }
    .btn:disabled{
      opacity:.6;
      cursor:not-allowed;
    }
    .status-msg{
      font-size:13px;
      margin-top:6px;
      color:var(--muted);
    }
    .status-msg.ok{color:#047857;font-weight:600;}
    .status-msg.err{color:#b91c1c;font-weight:600;}

    .info-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:10px;
      font-size:14px;
    }
    @media(max-width:650px){
      .info-grid{grid-template-columns:1fr;}
    }
    .info-item{
      padding:8px 10px;
      border-radius:10px;
      background:#fffaf3;
      border:1px solid rgba(188,143,116,.3);
    }
    .info-label{
      font-size:12px;
      color:var(--muted);
    }
    .info-value{
      font-size:14px;
      font-weight:600;
      color:var(--brown);
      margin-top:1px;
      word-break:break-word;
    }

    .progress-wrap{
      margin-top:6px;
    }
    .progress-head{
      display:flex;
      justify-content:space-between;
      font-size:13px;
      color:var(--muted);
      margin-bottom:4px;
    }
    .progress-head strong{color:var(--brown);}
    .progress-bar{
      position:relative;
      width:100%;
      height:10px;
      border-radius:999px;
      background:#f3f4f6;
      overflow:hidden;
    }
    .progress-inner{
      position:absolute;
      inset:0;
      width:0;
      border-radius:inherit;
      background:linear-gradient(90deg,#bc8f74,#3e2420);
      transition:width .35s ease-out;
    }
    .summary{
      font-size:13px;
      margin-top:8px;
      padding:8px 10px;
      border-radius:10px;
      background:#fdf6ed;
      border:1px dashed rgba(62,36,32,.36);
    }

    .stages-list{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .stage-row{
      display:flex;
      align-items:flex-start;
      gap:8px;
      padding:6px 8px;
      border-radius:10px;
      background:#f9fafb;
      border:1px solid #e5e7eb;
      font-size:13px;
    }
    .stage-row.done{
      background:#ecfdf5;
      border-color:#bbf7d0;
    }
    .stage-icon{
      width:20px;
      height:20px;
      border-radius:999px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:11px;
      background:#e5e7eb;
      color:#374151;
      flex-shrink:0;
    }
    .stage-row.done .stage-icon{
      background:#22c55e;
      color:#fff;
    }
    .stage-title{color:var(--brown);margin-bottom:2px;}
    .stage-time{font-size:11px;color:var(--muted);}
  </style>
</head>
<body>
  <div class="topbar">
    <h1>ØªØªØ¨Ø¹ Ø·Ù„Ø¨Ùƒ Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„</h1>
    <span>Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª â€“ Ø®Ø¯Ù…Ø© ØªØªØ¨Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</span>
  </div>

  <div class="wrap">

    <!-- Ø¨Ø­Ø« -->
    <div class="card">
      <div class="card-title">
        <span class="icon">ğŸ”</span>
        <span class="txt">Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·Ù„Ø¨</span>
      </div>
      <div class="card-sub">
        Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ (Ø§Ù„Ø´Ø§ØµÙŠ) ÙƒÙ…Ø§ Ù‡Ùˆ ÙÙŠ Ø¹Ù‚Ø¯ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø£Ùˆ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø©ØŒ ÙˆØ³ÙŠØªÙ… Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ ÙˆØ­Ø§Ù„Ø© Ø§Ù„Ù…Ø±Ø§Ø­Ù„.
      </div>

      <div class="search-row">
        <div>
          <label for="vinInput">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ (VIN)</label>
          <input id="vinInput" type="text" placeholder="Ù…Ø«Ø§Ù„: KMHXXXXXXXXXXXXX" />
        </div>
        <div style="display:flex;align-items:flex-end;justify-content:flex-end;">
          <button id="searchBtn" class="btn">
            ğŸ” ØªØªØ¨Ø¹ Ø§Ù„Ø·Ù„Ø¨
          </button>
        </div>
      </div>
      <div id="statusMsg" class="status-msg">
        Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø«Ù… Ø§Ø¶ØºØ· ØªØªØ¨Ø¹ Ø§Ù„Ø·Ù„Ø¨.
      </div>
    </div>

    <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ -->
    <div class="card" id="orderCard" style="display:none;">
      <div class="card-title">
        <span class="icon">ğŸ“„</span>
        <span class="txt">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨</span>
      </div>
      <div class="info-grid">
        <div class="info-item">
          <div class="info-label">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</div>
          <div class="info-value" id="orderNoEl">â€”</div>
        </div>
        <div class="info-item">
          <div class="info-label">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
          <div class="info-value" id="customerNameEl">â€”</div>
        </div>
        <div class="info-item">
          <div class="info-label">Ø§Ù„ÙØ±Ø¹</div>
          <div class="info-value" id="branchEl">â€”</div>
        </div>
        <div class="info-item">
          <div class="info-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø·Ù„Ø¨ (Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)</div>
          <div class="info-value" id="orderTotalEl">â€”</div>
        </div>
      </div>
    </div>

    <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø© -->
    <div class="card" id="carCard" style="display:none;">
      <div class="card-title">
        <span class="icon">ğŸš—</span>
        <span class="txt">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø©</span>
      </div>
      <div class="info-grid">
        <div class="info-item">
          <div class="info-label">Ø§Ø³Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©</div>
          <div class="info-value" id="carNameEl">â€”</div>
        </div>
        <div class="info-item">
          <div class="info-label">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„</div>
          <div class="info-value" id="vinEl">â€”</div>
        </div>
        <div class="info-item">
          <div class="info-label">Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ</div>
          <div class="info-value" id="extColorEl">â€”</div>
        </div>
        <div class="info-item">
          <div class="info-label">Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ</div>
          <div class="info-value" id="intColorEl">â€”</div>
        </div>
        <div class="info-item">
          <div class="info-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</div>
          <div class="info-value" id="subtotalEl">â€”</div>
        </div>
        <div class="info-item">
          <div class="info-label">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ©)</div>
          <div class="info-value" id="vatEl">â€”</div>
        </div>
        <div class="info-item">
          <div class="info-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</div>
          <div class="info-value" id="totalInclEl">â€”</div>
        </div>
      </div>
    </div>

    <!-- Ù…Ø±Ø§Ø­Ù„ Ø§Ù„ØªØªØ¨Ø¹ -->
    <div class="card" id="trackCard" style="display:none;">
      <div class="card-title">
        <span class="icon">ğŸš¦</span>
        <span class="txt">Ø­Ø§Ù„Ø© ØªØªØ¨Ø¹ Ø§Ù„Ø·Ù„Ø¨</span>
      </div>

      <div class="summary" id="summaryEl">
        â€” Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù† â€”
      </div>

      <div class="progress-wrap">
        <div class="progress-head">
          <span>Ù†Ø³Ø¨Ø© Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</span>
          <strong id="progressPercentEl">0%</strong>
        </div>
        <div class="progress-bar">
          <div class="progress-inner" id="progressInnerEl"></div>
        </div>
      </div>

      <div class="stages-list" id="stagesListEl"></div>
    </div>

  </div>

  <!-- Firebase compat (Ø¨Ø¯ÙˆÙ† type="module") -->
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>

  <script>
    // ===== Ø¥Ø¹Ø¯Ø§Ø¯ Firebase =====
    const firebaseConfig = {
      apiKey: "AIzaSyCorGtT5_Z68jCtLODvqnv0Fb7QW5eR6MQ",
      authDomain: "mzj-tracking.firebaseapp.com",
      projectId: "mzj-tracking",
      storageBucket: "mzj-tracking.firebasestorage.app",
      messagingSenderId: "655452217491",
      appId: "1:655452217491:web:9348d172c47bdd411fad66"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const STAGES = [
      "1) Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
      "2) Ø¥ÙŠØµØ§Ù„ Ø§Ù„Ø¯ÙØ¹ â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
      "3) Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ù† Ù‚ÙØ¨Ù„ Ù…Ù…Ø«Ù„ÙŠ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø¨Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¬Ø±ÙƒÙŠØ© â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø¹Ø±Ø¶)",
      "4) Ø³Ø¯Ø§Ø¯ Ø±Ø³ÙˆÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
      "5) Ø§Ù„ØªØ£Ù…ÙŠÙ† â€“ Ø´Ø±Ø· Ø§Ù„Ø±Ø¨Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ³ØªÙ… â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
      "6) Ø¥Ø³ØªÙŠÙØ§Ø¡ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
      "7) Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù„ÙˆØ­Ø§Øª Ø£Ùˆ Ù†Ù‚Ù„ Ø§Ù„Ù…Ù„ÙƒÙŠØ© â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø¹Ø±Ø¶)",
      "8) Ø¥Ø³ØªÙŠÙØ§Ø¡ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
      "9) Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ù„Ù„Ø¥Ø³ØªÙ„Ø§Ù… â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø¹Ø±Ø¶)",
      "10) Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­"
    ];

    // Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    const vinInput   = document.getElementById("vinInput");
    const searchBtn  = document.getElementById("searchBtn");
    const statusMsg  = document.getElementById("statusMsg");

    const orderCard  = document.getElementById("orderCard");
    const carCard    = document.getElementById("carCard");
    const trackCard  = document.getElementById("trackCard");

    const orderNoEl       = document.getElementById("orderNoEl");
    const customerNameEl  = document.getElementById("customerNameEl");
    const branchEl        = document.getElementById("branchEl");
    const orderTotalEl    = document.getElementById("orderTotalEl");

    const carNameEl   = document.getElementById("carNameEl");
    const vinEl       = document.getElementById("vinEl");
    const extColorEl  = document.getElementById("extColorEl");
    const intColorEl  = document.getElementById("intColorEl");
    const subtotalEl  = document.getElementById("subtotalEl");
    const vatEl       = document.getElementById("vatEl");
    const totalInclEl = document.getElementById("totalInclEl");

    const summaryEl        = document.getElementById("summaryEl");
    const progressInnerEl  = document.getElementById("progressInnerEl");
    const progressPercentEl= document.getElementById("progressPercentEl");
    const stagesListEl     = document.getElementById("stagesListEl");

    function setStatus(msg, type){
      statusMsg.textContent = msg;
      statusMsg.classList.remove("ok","err");
      if(type === "ok") statusMsg.classList.add("ok");
      if(type === "err") statusMsg.classList.add("err");
    }

    function parseAmount(v){
      if(v === null || v === undefined) return null;
      if(typeof v === "number") return v;
      const s = String(v).replace(/[^\d.,\-]/g,"").replace(/,/g,"");
      const n = parseFloat(s);
      return isNaN(n) ? null : n;
    }
    function formatCurrency(n){
      if(n === null || isNaN(n)) return "â€”";
      return n.toLocaleString("ar-SA",{minimumFractionDigits:2,maximumFractionDigits:2}) + " Ø±.Ø³";
    }

    function resetView(){
      orderCard.style.display = "none";
      carCard.style.display   = "none";
      trackCard.style.display = "none";

      orderNoEl.textContent      = "â€”";
      customerNameEl.textContent = "â€”";
      branchEl.textContent       = "â€”";
      orderTotalEl.textContent   = "â€”";

      carNameEl.textContent   = "â€”";
      vinEl.textContent       = "â€”";
      extColorEl.textContent  = "â€”";
      intColorEl.textContent  = "â€”";
      subtotalEl.textContent  = "â€”";
      vatEl.textContent       = "â€”";
      totalInclEl.textContent = "â€”";

      progressInnerEl.style.width = "0%";
      progressPercentEl.textContent = "0%";
      summaryEl.textContent = "â€” Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù† â€”";
      stagesListEl.innerHTML = "";
    }

    function renderStages(track){
      const stages = (track && track.stages) || {};
      let current = track && track.currentStage ? track.currentStage : 0;

      Object.keys(stages).forEach(key=>{
        const m = key.match(/^s(\d+)$/);
        if(!m) return;
        const n = parseInt(m[1],10);
        if(!isNaN(n) && n>current) current = n;
      });

      const doneCount = Object.keys(stages).length || current;
      const total = STAGES.length;
      const pct = total ? Math.round((doneCount/total)*100) : 0;

      progressInnerEl.style.width = pct + "%";
      progressPercentEl.textContent = pct + "%";

      let currentLabel;
      if(current>0 && current<=total) currentLabel = STAGES[current-1];
      else if(current===0) currentLabel = "Ù„Ù… ÙŠØ¨Ø¯Ø£ ØªÙ†ÙÙŠØ° Ø£ÙŠ Ù…Ø±Ø­Ù„Ø© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.";
      else currentLabel = "Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ø¯ÙŠØ«";

      const updatedAt = track && track.updatedAt
        ? new Date(track.updatedAt.toDate ? track.updatedAt.toDate() : track.updatedAt).toLocaleString("ar-SA")
        : "";

      summaryEl.innerHTML =
        "Ø­Ø§Ù„Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <strong>" + currentLabel +
        "</strong><br>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« Ù„Ù„Ø­Ø§Ù„Ø©: <span>" + (updatedAt || "â€”") + "</span>";

      stagesListEl.innerHTML = "";
      STAGES.forEach((label,idx)=>{
        const num = idx+1;
        const key = "s"+num;
        const ts  = stages[key];
        const isDone = current>=num || !!ts;
        let tsStr = "";
        if(ts){
          const d = ts.toDate ? ts.toDate() : ts;
          tsStr = new Date(d).toLocaleString("ar-SA");
        }
        const row = document.createElement("div");
        row.className = "stage-row" + (isDone ? " done":"");
        row.innerHTML = `
          <div class="stage-icon">${isDone ? "âœ“" : num}</div>
          <div>
            <div class="stage-title">${label}</div>
            <div class="stage-time">${tsStr ? ("ØªÙ…Øª ÙÙŠ: "+tsStr) : "Ù„Ù… ØªÙÙ†ÙÙ‘Ø° Ø¨Ø¹Ø¯."}</div>
          </div>
        `;
        stagesListEl.appendChild(row);
      });

      trackCard.style.display = "block";
    }

    async function handleSearch(){
      resetView();
      const vin = (vinInput.value || "").trim();
      if(!vin){
        setStatus("Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø£ÙˆÙ„Ø§Ù‹.", "err");
        return;
      }

      setStatus("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø±ØªØ¨Ø· Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…â€¦");

      let vinData = null;
      let lastData = {};
      let orderNo = null;
      let itemNo  = 1;
      let erpData = null;
      let track   = {};

      // 1) erp_vins/{vin}
      try{
        const vinSnap = await db.collection("erp_vins").doc(vin).get();
        if(vinSnap.exists){
          vinData   = vinSnap.data() || {};
          lastData  = vinData.lastData || {};
          orderNo   = vinData.lastOrderNo || lastData.orderNo || lastData.orderId || null;
          itemNo    = vinData.lastItemNo  || lastData.itemNo  || 1;
        }
      }catch(e){
        console.error("erp_vins error:", e);
      }

      if(!orderNo){
        setStatus("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨ Ù…Ø±ØªØ¨Ø· Ø¨Ù‡Ø°Ø§ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø±Ù‚Ù… ÙˆØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.", "err");
        return;
      }

      // 2) erp_orders/{OrderNo}_{ItemNo}
      try{
        const erpId  = orderNo + "_" + itemNo;
        const erpSnap= await db.collection("erp_orders").doc(erpId).get();
        if(erpSnap.exists){
          erpData = erpSnap.data() || null;
        }
      }catch(e){
        console.error("erp_orders error:", e);
      }

      // 3) tracking â€“ orders
      //   Ø£) orders/{OrderNo}_VIN_{VIN}/public/status
      try{
        const docId1 = orderNo + "_VIN_" + vin;
        const snap1  = await db.collection("orders").doc(docId1).collection("public").doc("status").get();
        if(snap1.exists){
          track = snap1.data() || {};
        }
      }catch(e){
        console.error("orders VIN status error:", e);
      }

      //   Ø¨) orders/{OrderNo}_{ItemNo}/public/status
      if(Object.keys(track).length === 0){
        try{
          const docId2 = orderNo + "_" + itemNo;
          const snap2  = await db.collection("orders").doc(docId2).collection("public").doc("status").get();
          if(snap2.exists){
            track = snap2.data() || {};
          }
        }catch(e){
          console.error("orders item status error:", e);
        }
      }

      //   Ø¬) orders/{OrderNo}/public/status
      if(Object.keys(track).length === 0){
        try{
          const snap3 = await db.collection("orders").doc(orderNo).collection("public").doc("status").get();
          if(snap3.exists){
            track = snap3.data() || {};
          }
        }catch(e){
          console.error("orders main status error:", e);
        }
      }

      if(!vinData && !erpData && Object.keys(track).length===0){
        setStatus("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù‡ÙŠÙƒÙ„ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù….", "err");
        return;
      }

      const erpItem   = (erpData && erpData.item)   || lastData.item   || {};
      const erpTotals = (erpData && erpData.totals) || lastData.totals || {};

      const customerName =
        track.customerName ||
        lastData.customerName ||
        (erpData && (erpData.customerName || erpData.CustomerName)) ||
        "";

      const branch =
        track.branch ||
        lastData.branch ||
        (erpData && (erpData.branch || erpData.Branch)) ||
        "";

      const totalRaw =
        track.orderTotalInclVAT ??
        track.orderTotalInclVat ??
        erpTotals.totalInclVAT ??
        erpTotals.totalInclVat ??
        erpTotals.TotalInclVAT ??
        null;

      const subtotalRaw =
        erpTotals.subtotalExclVAT ??
        erpTotals.SubtotalExclVAT ??
        null;

      const vatRaw =
        erpTotals.taxValue ??
        erpTotals.TaxValue ??
        null;

      const totalVal    = parseAmount(totalRaw);
      const subtotalVal = parseAmount(subtotalRaw);
      const vatVal      = parseAmount(vatRaw);

      orderCard.style.display = "block";
      orderNoEl.textContent      = orderNo || "â€”";
      customerNameEl.textContent = customerName || "â€”";
      branchEl.textContent       = branch || "â€”";

      let totalDisplay = totalVal;
      if(totalDisplay===null && subtotalVal!==null && vatVal!==null){
        totalDisplay = subtotalVal + vatVal;
      }
      orderTotalEl.textContent = totalDisplay!==null ? formatCurrency(totalDisplay) : "â€”";

      const carModel    = erpItem.model    || erpItem.ItemModel || "";
      const carCategory = erpItem.category || erpItem.ItemCategory || "";
      const carLabel    = [carCategory,carModel].filter(Boolean).join(" â€“ ");

      const exteriorColor =
        erpItem.exteriorColor ||
        erpItem.ExteriorColor ||
        lastData.exteriorColor ||
        "";

      const interiorColor =
        erpItem.interiorColor ||
        erpItem.InteriorColor ||
        lastData.interiorColor ||
        "";

      carCard.style.display = "block";
      carNameEl.textContent   = carLabel || "â€”";
      vinEl.textContent       = vin;
      extColorEl.textContent  = exteriorColor || "â€”";
      intColorEl.textContent  = interiorColor || "â€”";
      subtotalEl.textContent  = subtotalVal!==null ? formatCurrency(subtotalVal) : "â€”";
      vatEl.textContent       = vatVal!==null ? formatCurrency(vatVal) : "â€”";
      totalInclEl.textContent = totalDisplay!==null ? formatCurrency(totalDisplay) : "â€”";

      renderStages(track || {});
      setStatus("ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.", "ok");
    }

    searchBtn.addEventListener("click", handleSearch);
    vinInput.addEventListener("keydown", function(e){
      if(e.key === "Enter"){ handleSearch(); }
    });
  </script>
</body>
</html>
