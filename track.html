<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>MZJ â€“ ØªØªØ¨Ø¹ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet" />
  <style>
    :root{
      --brown:#3e2420;
      --beige:#bc8f74;
      --cream:#fff8ef;
      --text:#111827;
      --muted:#6b7280;
      --radius:16px;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:"Tajawal",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#fffdf8 0,#fff3e6 40%,#fbe9da 70%,#f5e3d3 100%);
      color:var(--text);
    }
    .topbar{
      background:var(--brown);
      color:#fff;
      padding:10px 20px;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 6px 14px rgba(0,0,0,.22);
    }
    .topbar-title{
      font-weight:800;
      font-size:17px;
      letter-spacing:.5px;
    }
    .wrap{
      max-width:900px;
      margin:22px auto 36px;
      padding:0 14px;
    }
    .card{
      background:#fff;
      border-radius:var(--radius);
      box-shadow:0 16px 40px rgba(62,36,32,.13);
      padding:18px 18px 20px;
      margin-bottom:18px;
    }
    .title{
      margin:0 0 12px 0;
      display:flex;
      align-items:center;
      gap:8px;
      color:var(--brown);
      font-size:18px;
    }
    .title .icon{
      width:26px;
      height:26px;
      border-radius:999px;
      background:rgba(188,143,116,.16);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:16px;
    }
    label{
      display:block;
      font-size:13px;
      margin-bottom:4px;
      color:var(--muted);
    }
    input{
      width:100%;
      padding:9px 11px;
      border-radius:10px;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      font-family:inherit;
      font-size:14px;
      outline:none;
    }
    input:focus{
      background:#fff;
      border-color:var(--beige);
      box-shadow:0 0 0 1px rgba(188,143,116,.45);
    }
    .btn{
      border:0;
      border-radius:999px;
      padding:9px 18px;
      font-family:inherit;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:14px;
      background:var(--brown);
      color:#fff;
    }
    .muted{color:var(--muted);font-size:13px;}
    .ok{color:#047857;font-weight:600;}
    .err{color:#b91c1c;font-weight:600;}
    .row{
      display:grid;
      grid-template-columns:2fr 1fr;
      gap:10px;
    }
    @media(max-width:700px){
      .row{grid-template-columns:1fr;}
    }

    .info-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      font-size:14px;
    }
    @media(max-width:650px){
      .info-grid{grid-template-columns:1fr;}
    }
    .info-item{
      padding:8px 10px;
      border-radius:10px;
      background:#fffaf3;
      border:1px solid rgba(188,143,116,.3);
    }
    .info-label{
      font-size:12px;
      color:var(--muted);
      margin-bottom:2px;
    }
    .info-value{
      font-size:14px;
      font-weight:600;
      color:var(--brown);
    }

    .progress-wrap{
      margin-top:8px;
    }
    .progress-label{
      display:flex;
      justify-content:space-between;
      font-size:13px;
      color:var(--muted);
      margin-bottom:4px;
    }
    .progress-bar{
      position:relative;
      width:100%;
      height:10px;
      border-radius:999px;
      background:#f3f4f6;
      overflow:hidden;
    }
    .progress-bar-inner{
      position:absolute;
      inset:0;
      width:0;
      border-radius:999px;
      background:linear-gradient(90deg,#bc8f74,#3e2420);
      transition:width .35s ease-out;
    }
    .stage-list{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .stage-row{
      display:flex;
      align-items:flex-start;
      gap:8px;
      padding:7px 9px;
      border-radius:10px;
      background:#f9fafb;
      border:1px solid #e5e7eb;
      font-size:13px;
    }
    .stage-row.done{
      background:#ecfdf5;
      border-color:#22c55e;
    }
    .stage-status{
      width:18px;
      height:18px;
      border-radius:999px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:11px;
      flex-shrink:0;
      background:#e5e7eb;
      color:#374151;
    }
    .stage-row.done .stage-status{
      background:#22c55e;
      color:#fff;
    }
    .stage-title{
      color:var(--brown);
      margin-bottom:2px;
    }
    .stage-time{
      color:var(--muted);
      font-size:11px;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-title">ØªØªØ¨Ø¹ Ø·Ù„Ø¨Ùƒ Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ â€“ Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª</div>
  </div>

  <div class="wrap">
    <!-- Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ -->
    <div class="card" id="searchCard">
      <h3 class="title">
        <span class="icon">ğŸ”</span>
        ØªØªØ¨Ø¹ Ø§Ù„Ø·Ù„Ø¨
      </h3>
      <div class="row">
        <div>
          <label>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ (VIN)</label>
          <input id="vinInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù‡Ù†Ø§" />
        </div>
        <div style="display:flex;align-items:flex-end;justify-content:flex-start;">
          <button class="btn" id="searchBtn">Ø¨Ø­Ø«</button>
        </div>
      </div>
      <div id="searchMsg" class="muted" style="margin-top:6px;">
        Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ ÙƒÙ…Ø§ Ù‡Ùˆ Ù…ÙˆØ¶Ø­ ÙÙŠ Ø¹Ù‚Ø¯ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø£Ùˆ Ø§Ø³ØªÙ…Ø§Ø±Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©.
      </div>
    </div>

    <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ -->
    <div class="card" id="orderInfoCard" style="display:none;">
      <h3 class="title">
        <span class="icon">ğŸ“„</span>
        Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨
      </h3>
      <div class="info-grid">
        <div class="info-item">
          <div class="info-label">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</div>
          <div class="info-value" id="orderNoEl">â€”</div>
        </div>
        <div class="info-item">
          <div class="info-label">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
          <div class="info-value" id="customerNameEl">â€”</div>
        </div>
        <div class="info-item">
          <div class="info-label">Ø§Ù„ÙØ±Ø¹</div>
          <div class="info-value" id="branchEl">â€”</div>
        </div>
        <div class="info-item">
          <div class="info-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø·Ù„Ø¨ (Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)</div>
          <div class="info-value" id="orderTotalEl">â€”</div>
        </div>
      </div>
    </div>

    <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø© -->
    <div class="card" id="carInfoCard" style="display:none;">
      <h3 class="title">
        <span class="icon">ğŸš—</span>
        Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø©
      </h3>
      <div class="info-grid">
        <div class="info-item">
          <div class="info-label">Ø§Ø³Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©</div>
          <div class="info-value" id="carNameEl">â€”</div>
        </div>
        <div class="info-item">
          <div class="info-label">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„</div>
          <div class="info-value" id="vinEl">â€”</div>
        </div>
        <div class="info-item">
          <div class="info-label">Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ</div>
          <div class="info-value" id="extColorEl">â€”</div>
        </div>
        <div class="info-item">
          <div class="info-label">Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ</div>
          <div class="info-value" id="intColorEl">â€”</div>
        </div>
        <div class="info-item">
          <div class="info-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</div>
          <div class="info-value" id="subtotalEl">â€”</div>
        </div>
        <div class="info-item">
          <div class="info-label">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ©)</div>
          <div class="info-value" id="vatValueEl">â€”</div>
        </div>
        <div class="info-item">
          <div class="info-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</div>
          <div class="info-value" id="totalInclEl">â€”</div>
        </div>
      </div>
    </div>

    <!-- Ù…Ø±Ø§Ø­Ù„ Ø§Ù„ØªØªØ¨Ø¹ -->
    <div class="card" id="stagesCard" style="display:none;">
      <h3 class="title">
        <span class="icon">ğŸš¦</span>
        Ø­Ø§Ù„Ø© ØªØªØ¨Ø¹ Ø§Ù„Ø·Ù„Ø¨
      </h3>

      <div class="progress-wrap">
        <div class="progress-label">
          <span>Ù†Ø³Ø¨Ø© Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</span>
          <span id="progressPercent">0%</span>
        </div>
        <div class="progress-bar">
          <div class="progress-bar-inner" id="progressBarInner"></div>
        </div>
      </div>

      <div class="muted" id="currentStageLabel" style="margin-top:8px;">â€”</div>

      <div class="stage-list" id="stagesList"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore,
      doc,
      getDoc,
      collection,
      query,
      where,
      getDocs
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCorGtT5_Z68jCtLODvqnv0Fb7QW5eR6MQ",
      authDomain: "mzj-tracking.firebaseapp.com",
      projectId: "mzj-tracking",
      storageBucket: "mzj-tracking.firebasestorage.app",
      messagingSenderId: "655452217491",
      appId: "1:655452217491:web:9348d172c47bdd411fad66"
    };

    const ERP_COLLECTION      = "erp_orders";
    const ERP_VINS_COLLECTION = "erp_vins";
    const TRACK_COLLECTION    = "orders";

    const STAGES = [
      "1) Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
      "2) Ø¥ÙŠØµØ§Ù„ Ø§Ù„Ø¯ÙØ¹ â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
      "3) Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ù† Ù‚ÙØ¨Ù„ Ù…Ù…Ø«Ù„ÙŠ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø¨Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¬Ø±ÙƒÙŠØ© â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø¹Ø±Ø¶)",
      "4) Ø³Ø¯Ø§Ø¯ Ø±Ø³ÙˆÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
      "5) Ø§Ù„ØªØ£Ù…ÙŠÙ† â€“ Ø´Ø±Ø· Ø§Ù„Ø±Ø¨Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ³ØªÙ… â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
      "6) Ø¥Ø³ØªÙŠÙØ§Ø¡ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
      "7) Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù„ÙˆØ­Ø§Øª Ø£Ùˆ Ù†Ù‚Ù„ Ø§Ù„Ù…Ù„ÙƒÙŠØ© â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø¹Ø±Ø¶)",
      "8) Ø¥Ø³ØªÙŠÙØ§Ø¡ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
      "9) Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ù„Ù„Ø¥Ø³ØªÙ„Ø§Ù… â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø¹Ø±Ø¶)",
      "10) Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­"
    ];

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // UI
    const vinInput        = document.getElementById("vinInput");
    const searchBtn       = document.getElementById("searchBtn");
    const searchMsg       = document.getElementById("searchMsg");

    const orderInfoCard   = document.getElementById("orderInfoCard");
    const carInfoCard     = document.getElementById("carInfoCard");
    const stagesCard      = document.getElementById("stagesCard");

    const orderNoEl       = document.getElementById("orderNoEl");
    const customerNameEl  = document.getElementById("customerNameEl");
    const branchEl        = document.getElementById("branchEl");
    const orderTotalEl    = document.getElementById("orderTotalEl");

    const carNameEl       = document.getElementById("carNameEl");
    const vinEl           = document.getElementById("vinEl");
    const extColorEl      = document.getElementById("extColorEl");
    const intColorEl      = document.getElementById("intColorEl");
    const subtotalEl      = document.getElementById("subtotalEl");
    const vatValueEl      = document.getElementById("vatValueEl");
    const totalInclEl     = document.getElementById("totalInclEl");

    const progressBarInner   = document.getElementById("progressBarInner");
    const progressPercentEl  = document.getElementById("progressPercent");
    const currentStageLabel  = document.getElementById("currentStageLabel");
    const stagesList         = document.getElementById("stagesList");

    // Helpers Ù…Ø£Ø®ÙˆØ°Ø© Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
    const FIELD_SYNONYMS = {
      CustomerName: ["CustomerName","customerName"],
      Branch:       ["Branch","branch"],
      OrderDate:    ["OrderDate","orderDate"],
      DeliveryDate: ["DeliveryDate","deliveryDate"],
      ItemModel:    ["ItemModel","itemModel","model"],
      VIN:          ["VIN","vin"],
      InteriorColor:["InteriorColor","interiorColor"],
      ExteriorColor:["ExteriorColor","exteriorColor"],
      SubtotalExclVAT: ["subtotalExclVAT","SubtotalExclVAT","subtotalExclVat"],
      TotalInclVAT:    ["totalInclVAT","TotalInclVAT","totalInclVat"],
      TaxValue:        ["taxValue","TaxValue"],
      orderSubtotalExclVAT: ["orderSubtotalExclVAT","orderSubtotalExclVat","orderSubtotal"],
      orderTotalInclVAT:    ["orderTotalInclVAT","orderTotalInclVat","orderTotal"]
    };

    function buildCandidates(name) {
      const syns = FIELD_SYNONYMS[name] || [name];
      const arr = [];
      syns.forEach(s => {
        if (!s) return;
        arr.push(s);
        arr.push(s.toLowerCase());
        arr.push(s.toUpperCase());
      });
      return Array.from(new Set(arr));
    }

    function lookupIn(obj, candidates) {
      if (!obj) return undefined;
      for (const key of candidates) {
        if (Object.prototype.hasOwnProperty.call(obj, key) && obj[key] !== undefined) {
          return obj[key];
        }
      }
      return undefined;
    }

    function getFieldFlex(fieldName, data) {
      if (!data) return "-";
      const candidates = buildCandidates(fieldName);
      let v = lookupIn(data, candidates);
      if (v !== undefined) return v;
      v = lookupIn(data.item, candidates);
      if (v !== undefined) return v;
      v = lookupIn(data.totals, candidates);
      if (v !== undefined) return v;
      return "-";
    }

    function parseAmountFront(value) {
      if (value === null || value === undefined || value === "-") return null;
      if (typeof value === "number") return value;
      const s = String(value)
        .replace(/[^\d.,\-]/g, "")
        .replace(/,/g, "");
      const n = parseFloat(s);
      return isNaN(n) ? null : n;
    }

    function formatCurrency(num) {
      if (num === null || num === undefined) return "â€”";
      return num.toLocaleString("ar-SA",{minimumFractionDigits:2, maximumFractionDigits:2}) + " Ø±.Ø³";
    }

    function resetView() {
      orderInfoCard.style.display = "none";
      carInfoCard.style.display   = "none";
      stagesCard.style.display    = "none";
      orderNoEl.textContent      = "â€”";
      customerNameEl.textContent = "â€”";
      branchEl.textContent       = "â€”";
      orderTotalEl.textContent   = "â€”";
      carNameEl.textContent      = "â€”";
      vinEl.textContent          = "â€”";
      extColorEl.textContent     = "â€”";
      intColorEl.textContent     = "â€”";
      subtotalEl.textContent     = "â€”";
      vatValueEl.textContent     = "â€”";
      totalInclEl.textContent    = "â€”";
      progressBarInner.style.width = "0%";
      progressPercentEl.textContent = "0%";
      currentStageLabel.textContent = "â€”";
      stagesList.innerHTML = "";
    }

    async function findOrderRecordsByVin(vinRaw) {
      const val = vinRaw.trim();
      if (!val) return null;

      const colRef = collection(db, ERP_COLLECTION);
      let mainDoc = null;

      // 1) Ø¨Ø­Ø« Ù…Ø¨Ø§Ø´Ø± Ø¹Ù„Ù‰ erp_orders.vin
      let q1 = query(colRef, where("vin","==",val));
      let snap = await getDocs(q1);
      if (!snap.empty) {
        mainDoc = snap.docs[0];
      } else {
        const asNum = Number(val);
        if (!Number.isNaN(asNum)) {
          q1 = query(colRef, where("vin","==",asNum));
          snap = await getDocs(q1);
          if (!snap.empty) mainDoc = snap.docs[0];
        }
      }

      // 2) Ù„Ùˆ Ù…Ø§ Ù„Ø§Ù‚ÙŠÙ†Ø§Ù‡ØŒ Ù†Ø³ØªØ®Ø¯Ù… erp_vins index
      if (!mainDoc) {
        try {
          const vinRef = doc(db, ERP_VINS_COLLECTION, val);
          const vinSnap = await getDoc(vinRef);
          if (vinSnap.exists()) {
            const vData = vinSnap.data();
            const ordNo = vData.lastOrderNo || vData.orderNo || vData.OrderNo || null;
            if (ordNo) {
              const ordRef = doc(db, ERP_COLLECTION, ordNo);
              const ordSnap = await getDoc(ordRef);
              if (ordSnap.exists()) {
                mainDoc = ordSnap;
              }
            }
          }
        } catch (e) {
          console.error("VIN lookup via erp_vins failed", e);
        }
      }

      if (!mainDoc) return null;

      const mainData = mainDoc.data();
      const orderNo = mainData.orderNo || mainData.OrderNo || mainDoc.id;

      // Ù†Ø¬ÙŠØ¨ ÙƒÙ„ Ø§Ù„Ø£Ø³Ø·Ø± Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨
      const qAll = query(colRef, where("orderNo","==",orderNo));
      const allSnap = await getDocs(qAll);
      const records = !allSnap.empty ? allSnap.docs.map(d => d.data()) : [mainData];

      return { orderNo, records };
    }

    function fillOrderInfo(orderNo, records) {
      const first = records[0] || {};
      const customerName = getFieldFlex("CustomerName", first) || "â€”";
      const branch       = getFieldFlex("Branch", first) || "â€”";

      // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨
      let orderSubtotal = parseAmountFront(
        first.orderSubtotalExclVAT ||
        first.orderSubtotalExclVat ||
        getFieldFlex("orderSubtotalExclVAT", first)
      );
      let orderTotal = parseAmountFront(
        first.orderTotalInclVAT ||
        first.orderTotalInclVat ||
        getFieldFlex("orderTotalInclVAT", first)
      );

      let totalSum = 0;
      records.forEach(r => {
        const t = parseAmountFront(
          r.totalInclVAT ||
          r.TotalInclVAT ||
          getFieldFlex("TotalInclVAT", r)
        );
        if (t !== null) totalSum += t;
      });
      if (orderTotal === null && totalSum > 0) orderTotal = totalSum;

      orderInfoCard.style.display = "";
      orderNoEl.textContent      = orderNo || "â€”";
      customerNameEl.textContent = customerName || "â€”";
      branchEl.textContent       = branch || "â€”";
      orderTotalEl.textContent   = orderTotal !== null ? formatCurrency(orderTotal) : "â€”";
    }

    function fillCarInfo(vin, records) {
      const match = records.find(r =>
        (getFieldFlex("VIN", r) || "").toString().trim() === vin.trim()
      ) || records[0];

      const carName   = getFieldFlex("ItemModel", match);
      const extColor  = getFieldFlex("ExteriorColor", match);
      const intColor  = getFieldFlex("InteriorColor", match);
      const subtotal  = parseAmountFront(
        match.subtotalExclVAT ||
        match.SubtotalExclVAT ||
        getFieldFlex("SubtotalExclVAT", match)
      );
      const taxValue  = parseAmountFront(
        match.taxValue ||
        match.TaxValue ||
        getFieldFlex("TaxValue", match)
      );
      const totalIncl = parseAmountFront(
        match.totalInclVAT ||
        match.TotalInclVAT ||
        getFieldFlex("TotalInclVAT", match)
      );

      carInfoCard.style.display = "";
      carNameEl.textContent   = carName && carName !== "-" ? carName : "â€”";
      vinEl.textContent       = vin || "â€”";
      extColorEl.textContent  = extColor && extColor !== "-" ? extColor : "â€”";
      intColorEl.textContent  = intColor && intColor !== "-" ? intColor : "â€”";
      subtotalEl.textContent  = subtotal !== null ? formatCurrency(subtotal) : "â€”";
      vatValueEl.textContent  = taxValue !== null ? formatCurrency(taxValue) : "â€”";
      totalInclEl.textContent = totalIncl !== null ? formatCurrency(totalIncl) : "â€”";
    }

    function buildStagesUI(data) {
      const stagesObj = data.stages || {};
      let current     = data.currentStage || 0;

      // Ù†ØªØ£ÙƒØ¯ Ø¥Ù† current Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ø£Ø¹Ù„Ù‰ Ù…Ø±Ø­Ù„Ø© Ù…Ù†Ø¬Ø²Ø©
      Object.keys(stagesObj).forEach(k => {
        const m = k.match(/^s(\d+)$/);
        if (!m) return;
        const n = parseInt(m[1],10);
        if (!isNaN(n) && n > current) current = n;
      });

      const totalStages = STAGES.length;
      const pct = totalStages > 0 ? Math.round((current / totalStages) * 100) : 0;

      progressBarInner.style.width   = pct + "%";
      progressPercentEl.textContent  = pct + "%";

      if (current > 0 && current <= totalStages) {
        currentStageLabel.textContent = "Ø¢Ø®Ø± Ù…Ø±Ø­Ù„Ø© ØªÙ… ØªÙ†ÙÙŠØ°Ù‡Ø§: " + STAGES[current-1];
      } else {
        currentStageLabel.textContent = "Ù„Ù… ÙŠØ¨Ø¯Ø£ ØªÙ†ÙÙŠØ° Ø£ÙŠ Ù…Ø±Ø­Ù„Ø© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.";
      }

      stagesList.innerHTML = "";
      STAGES.forEach((label, idx) => {
        const num = idx + 1;
        const key = "s" + num;
        const ts  = stagesObj[key];
        const done = !!ts;
        const tsStr = done
          ? new Date(ts.toDate ? ts.toDate() : ts).toLocaleString("ar-SA")
          : null;

        const row = document.createElement("div");
        row.className = "stage-row" + (done ? " done" : "");

        row.innerHTML = `
          <div class="stage-status">${done ? "âœ“" : "â€¢"}</div>
          <div>
            <div class="stage-title">${label}</div>
            <div class="stage-time">${tsStr ? ("ØªÙ…Øª ÙÙŠ: " + tsStr) : "Ù„Ù… ØªÙÙ†ÙÙ‘Ø° Ø¨Ø¹Ø¯"}</div>
          </div>
        `;
        stagesList.appendChild(row);
      });

      stagesCard.style.display = "";
    }

    async function loadTrackingForVin(orderNo, vin) {
      const vinClean = vin.trim();
      const docId = orderNo + "_VIN_" + vinClean;
      // Ù†Ù‚Ø±Ø£ Ù…Ù† public/status Ø£ÙˆÙ„Ø§Ù‹
      let statusSnap = await getDoc(doc(db, TRACK_COLLECTION, docId, "public", "status"));
      if (!statusSnap.exists()) {
        statusSnap = await getDoc(doc(db, TRACK_COLLECTION, docId));
      }
      if (!statusSnap.exists()) {
        // Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±Ø§Ø­Ù„ Ø¨Ø¹Ø¯
        buildStagesUI({ currentStage: 0, stages: {} });
      } else {
        buildStagesUI(statusSnap.data() || {});
      }
    }

    async function handleSearch() {
      resetView();
      searchMsg.classList.remove("ok","err");
      searchMsg.textContent = "";

      const vinRaw = vinInput.value.trim();
      if (!vinRaw) {
        searchMsg.classList.add("err");
        searchMsg.textContent = "Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø£ÙˆÙ„Ø§Ù‹.";
        return;
      }

      searchMsg.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø±ØªØ¨Ø· Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù‡ÙŠÙƒÙ„...";
      try {
        const found = await findOrderRecordsByVin(vinRaw);
        if (!found) {
          searchMsg.classList.add("err");
          searchMsg.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨ Ù…Ø±ØªØ¨Ø· Ø¨Ù‡Ø°Ø§ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„. ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù‚Ù… Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.";
          return;
        }

        const { orderNo, records } = found;

        fillOrderInfo(orderNo, records);
        fillCarInfo(vinRaw, records);
        await loadTrackingForVin(orderNo, vinRaw);

        searchMsg.classList.remove("err");
        searchMsg.classList.add("ok");
        searchMsg.textContent = "ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„Ù‡.";
      } catch (e) {
        console.error(e);
        searchMsg.classList.add("err");
        searchMsg.textContent = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ø§Ù‹.";
      }
    }

    searchBtn.addEventListener("click", handleSearch);
    vinInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        handleSearch();
      }
    });
  </script>
</body>
</html>
