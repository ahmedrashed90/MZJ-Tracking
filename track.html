<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ØªØªØ¨Ø¹ Ø·Ù„Ø¨Ùƒ - Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: "Tajawal", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f6f4f0;
      color: #3e2420;
    }
    .page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 24px 12px;
    }
    .card {
      width: 100%;
      max-width: 900px;
      background: #ffffff;
      border-radius: 20px;
      box-shadow: 0 14px 40px rgba(0, 0, 0, 0.12);
      padding: 20px 18px 22px;
    }
    .brand-header {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: flex-start;
      margin-bottom: 18px;
    }
    .brand-title {
      font-size: 18px;
      font-weight: 800;
      letter-spacing: 0.4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .brand-badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #fff1d6;
      color: #7b5b39;
    }
    .brand-text-sub {
      font-size: 13px;
      color: #7b6a63;
    }
    .search-section {
      margin-bottom: 18px;
    }
    .search-section label {
      font-size: 13px;
      margin-bottom: 6px;
      display: block;
      color: #7b6a63;
    }
    .search-input-wrap {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .search-input-wrap input {
      flex: 1;
      min-width: 220px;
      border-radius: 12px;
      border: 1px solid #d1c7bf;
      padding: 9px 11px;
      font-family: inherit;
      font-size: 14px;
      outline: none;
      background: #fdfaf7;
    }
    .search-input-wrap input:focus {
      border-color: #bc8f74;
      box-shadow: 0 0 0 1px rgba(188, 143, 116, 0.5);
      background: #ffffff;
    }
    .btn {
      border-radius: 999px;
      border: none;
      padding: 9px 18px;
      font-size: 14px;
      cursor: pointer;
      font-family: inherit;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    .btn-primary {
      background: linear-gradient(135deg, #3e2420, #bc8f74);
      color: #ffffff;
    }
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .status-bar {
      margin-top: 6px;
      font-size: 12px;
      color: #7b6a63;
      min-height: 16px;
    }
    .empty-state {
      margin-top: 16px;
      padding: 18px 14px;
      border-radius: 16px;
      background: #fbf7f2;
      border: 1px dashed #e1d5c7;
      font-size: 14px;
      color: #7b6a63;
      text-align: center;
    }
    .section-title {
      font-size: 15px;
      font-weight: 700;
      margin: 14px 0 8px;
      display: flex;
      align-items: center;
      gap: 6px;
      color: #3e2420;
    }
    .icon-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #bc8f74;
    }
    .info-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1.3fr);
      gap: 10px;
      font-size: 13px;
    }
    @media (max-width: 700px) {
      .info-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }
    .info-item {
      background: #fdfaf7;
      border-radius: 12px;
      border: 1px solid #e6dbcf;
      padding: 8px 10px;
    }
    .info-label {
      font-size: 11px;
      color: #7b6a63;
      margin-bottom: 3px;
    }
    .info-value {
      font-size: 14px;
      font-weight: 600;
      color: #3e2420;
      word-break: break-word;
    }
    .car-box {
      margin-top: 8px;
      border-radius: 12px;
      border: 1px solid #e3d7ca;
      background: #fefaf6;
      padding: 10px 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .car-main {
      font-size: 14px;
      font-weight: 700;
    }
    .car-meta {
      font-size: 12px;
      color: #7b6a63;
    }
    .tabs {
      display: flex;
      gap: 6px;
      margin-top: 12px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    .tab {
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid #e1d5c7;
      background: #fdfaf7;
      font-size: 12px;
      cursor: pointer;
      color: #7b6a63;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .tab.active {
      background: #3e2420;
      border-color: #3e2420;
      color: #ffffff;
    }
    .tab small {
      font-size: 11px;
      opacity: 0.85;
    }
    .timeline-section {
      margin-top: 14px;
      padding-top: 12px;
      border-top: 1px solid #eee0d2;
    }
    .progress-wrap {
      margin-bottom: 10px;
    }
    .progress-top {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: #7b6a63;
      margin-bottom: 4px;
    }
    .progress-bar {
      position: relative;
      width: 100%;
      height: 10px;
      border-radius: 999px;
      background: #f0e4d8;
      overflow: hidden;
    }
    .progress-bar-inner {
      position: absolute;
      inset: 0;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(90deg, #bc8f74, #3e2420);
      transition: width 0.35s ease-out;
    }
    .current-stage-label {
      font-size: 13px;
      color: #3e2420;
      font-weight: 600;
      margin-top: 4px;
    }
    .last-updated {
      font-size: 11px;
      color: #7b6a63;
      margin-top: 2px;
    }
    .timeline-list {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .stage-row {
      display: flex;
      gap: 8px;
      padding: 7px 9px;
      border-radius: 10px;
      border: 1px solid #eee0d2;
      background: #fdfaf7;
      align-items: flex-start;
    }
    .stage-row.done {
      background: #ecfdf3;
      border-color: #a7f3d0;
    }
    .stage-icon {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      margin-top: 1px;
    }
    .stage-icon.done {
      background: #16a34a;
      color: #ffffff;
    }
    .stage-icon.pending {
      background: #e5e7eb;
      color: #6b7280;
    }
    .stage-text-main {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 2px;
    }
    .stage-text-sub {
      font-size: 11px;
      color: #7b6a63;
    }
    .stage-time {
      font-size: 11px;
      color: #6b7280;
      margin-top: 2px;
    }
    @media (max-width: 480px) {
      .card {
        padding: 16px 12px;
      }
      .brand-title {
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="card">
      <div class="brand-header">
        <div class="brand-title">
          ØªØªØ¨Ø¹ Ø­Ø§Ù„Ø© Ø·Ù„Ø¨Ùƒ
          <span class="brand-badge">Ø®Ø¯Ù…Ø© Ø¹Ù…Ù„Ø§Ø¡ â€“ Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª</span>
        </div>
        <div class="brand-text-sub">
          Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ (Ø§Ù„Ø´Ø§ØµÙŠ) ÙˆØªØ§Ø¨Ø¹ Ø­Ø§Ù„Ø© Ø·Ù„Ø¨Ùƒ Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ© Ø­ØªÙ‰ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©.
        </div>
      </div>

      <div class="search-section">
        <div>
          <label for="vinInput">Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ (Ø§Ù„Ø´Ø§ØµÙŠ):</label>
        </div>
        <div class="search-input-wrap">
          <input id="vinInput" type="text" placeholder="Ù…Ø«Ø§Ù„: KMHXXXXXXXXXXXXX" />
          <button id="searchBtn" class="btn btn-primary">
            ğŸ” ØªØªØ¨Ø¹
          </button>
        </div>
        <div class="status-bar" id="statusBar"></div>
      </div>

      <div id="resultContainer">
        <div class="empty-state">
          Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ ÙˆØ§Ø¶ØºØ· "ØªØªØ¨Ø¹" Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø·Ù„Ø¨Ùƒ ÙˆØ­Ø§Ù„Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©.
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
    import {
      getFirestore,
      doc,
      getDoc,
      collection,
      query,
      where,
      getDocs
    } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCorGtT5_Z68jCtLODvqnv0Fb7QW5eR6MQ",
      authDomain: "mzj-tracking.firebaseapp.com",
      projectId: "mzj-tracking",
      storageBucket: "mzj-tracking.appspot.com",
      messagingSenderId: "655452217491",
      appId: "1:655452217491:web:9348d172c47bdd411fad66"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const vinInput = document.getElementById("vinInput");
    const searchBtn = document.getElementById("searchBtn");
    const statusBar = document.getElementById("statusBar");
    const resultContainer = document.getElementById("resultContainer");

    function setStatus(msg, isError = false) {
      statusBar.textContent = msg || "";
      statusBar.style.color = isError ? "#b00020" : "#7b6a63";
    }

    function renderEmptyState() {
      resultContainer.innerHTML = `
        <div class="empty-state">
          Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ ÙˆØ§Ø¶ØºØ· "ØªØªØ¨Ø¹" Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø·Ù„Ø¨Ùƒ ÙˆØ­Ø§Ù„Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©.
        </div>
      `;
    }

    const STAGES = [
      {
        title: "1) Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡. (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
        sub: "ÙŠØªÙ… ØªÙ‚Ø¯ÙŠÙ… Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¡ Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ù…Ù† Ø®Ù„Ø§Ù„ Ø§Ù„Ù…Ø¹Ø±Ø¶ Ø£Ùˆ Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©."
      },
      {
        title: "2) Ø¥ÙŠØµØ§Ù„ Ø§Ù„Ø¯ÙØ¹. (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
        sub: "ÙŠØªÙ… Ø¥ØµØ¯Ø§Ø± Ø£Ùˆ Ø§Ø³ØªÙ„Ø§Ù… Ø¥ÙŠØµØ§Ù„ Ø§Ù„Ø¯ÙØ¹ (ØªØ­ÙˆÙŠÙ„ / Ø´Ø¨ÙƒØ© / ÙƒØ§Ø´) ÙˆØ±Ø¨Ø·Ù‡ Ø¨Ø§Ù„Ø·Ù„Ø¨."
      },
      {
        title: "3) Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ù† Ù‚ÙØ¨Ù„ Ù…Ù…Ø«Ù„ÙŠ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø¨Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¬Ø±ÙƒÙŠØ©. (Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø¹Ø±Ø¶)",
        sub: "ÙŠØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ ÙØ±ÙŠÙ‚ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ù„Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¬Ø±ÙƒÙŠØ©."
      },
      {
        title: "4) Ø³Ø¯Ø§Ø¯ Ø±Ø³ÙˆÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„. (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
        sub: "ØªØ³Ø¯ÙŠØ¯ Ø±Ø³ÙˆÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø±Ø³Ù…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ø¥ØªÙ…Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©."
      },
      {
        title: "5) Ø§Ù„ØªØ£Ù…ÙŠÙ† - Ø´Ø±Ø· Ø§Ù„Ø±Ø¨Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ³ØªÙ…. (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
        sub: "Ø§Ø®ØªÙŠØ§Ø± Ø´Ø±ÙƒØ© Ø§Ù„ØªØ£Ù…ÙŠÙ† ÙˆØ¥ØªÙ…Ø§Ù… Ø¥ØµØ¯Ø§Ø± Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© ÙˆØ±Ø¨Ø·Ù‡Ø§ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù…."
      },
      {
        title: "6) Ø§Ø³ØªÙŠÙØ§Ø¡ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©. (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
        sub: "Ø³Ø¯Ø§Ø¯ Ø£ÙŠ Ù…Ø¨Ø§Ù„Øº Ø¥Ø¶Ø§ÙÙŠØ© Ù…ØªØ¨Ù‚ÙŠØ© ÙˆÙÙ‚Ø§Ù‹ Ù„Ø§ØªÙØ§Ù‚ÙŠØ© Ø§Ù„Ø´Ø±Ø§Ø¡ Ø£Ùˆ Ø§Ù„ØªÙ…ÙˆÙŠÙ„."
      },
      {
        title: "7) Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù„ÙˆØ­Ø§Øª Ø£Ùˆ Ù†Ù‚Ù„ Ø§Ù„Ù…Ù„ÙƒÙŠØ©. (Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø¹Ø±Ø¶)",
        sub: "Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù„ÙˆØ­Ø§Øª Ø£Ùˆ Ù†Ù‚Ù„ Ù…Ù„ÙƒÙŠØ© Ø§Ù„Ù…Ø±ÙƒØ¨Ø© Ù„Ø§Ø³Ù…Ùƒ."
      },
      {
        title: "8) Ø§Ø³ØªÙŠÙØ§Ø¡ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©. (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
        sub: "ØªØ³Ù„ÙŠÙ… ÙˆØ§Ø³ØªÙ„Ø§Ù… ÙƒØ§ÙØ© Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ø±ÙƒØ¨Ø© ÙˆØ§Ù„Ø¹Ù…ÙŠÙ„."
      },
      {
        title: "9) Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ù„Ù„Ø¥Ø³ØªÙ„Ø§Ù…. (Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø¹Ø±Ø¶)",
        sub: "ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ù…Ù† Ù†Ø§Ø­ÙŠØ© Ø§Ù„ØªÙ†Ø¸ÙŠÙØŒ Ø§Ù„ØªØ¸Ù„ÙŠÙ„ (Ø¥Ù† ÙˆØ¬Ø¯) ÙˆØ§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø³Ù„Ø§Ù…Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª."
      },
      {
        title: "10) Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­.",
        sub: "ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ù„Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø¹ Ø´Ø±Ø­ Ù…Ø®ØªØµØ± Ù„Ù„Ù…Ø²Ø§ÙŠØ§ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙˆØªÙˆØ«ÙŠÙ‚ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ³Ù„ÙŠÙ…."
      }
    ];

    function parseAmountFront(value) {
      if (value === null || value === undefined || value === "") return null;
      if (typeof value === "number") return value;
      const s = String(value)
        .replace(/[^\d.,\-]/g, "")
        .replace(/,/g, "");
      const n = parseFloat(s);
      return isNaN(n) ? null : n;
    }

    function formatAmount(val) {
      if (val === null || val === undefined || val === "") return "-";
      if (typeof val === "number") {
        return val.toLocaleString("ar-SA", { minimumFractionDigits: 2 });
      }
      const n = parseAmountFront(val);
      if (n === null) return val;
      return n.toLocaleString("ar-SA", { minimumFractionDigits: 2 });
    }

    function buildTimelineHtml(statusData) {
      const track = statusData || {};
      const stagesMap = track.stages || {};
      const updatedAt = track.updatedAt
        ? new Date(track.updatedAt.toDate ? track.updatedAt.toDate() : track.updatedAt).toLocaleString("ar-SA")
        : "";

      let doneCount = 0;
      for (let i = 1; i <= STAGES.length; i++) {
        if (stagesMap["s" + i]) {
          doneCount++;
        }
      }
      const progress = doneCount * (100 / STAGES.length);

      let currentStageLabel;
      if (track.currentStage > 0 && track.currentStage <= STAGES.length) {
        currentStageLabel = STAGES[track.currentStage - 1].title;
      } else if (doneCount > 0) {
        currentStageLabel = STAGES[doneCount - 1].title;
      } else {
        currentStageLabel = "Ù„Ù… ÙŠØ¨Ø¯Ø£ ØªÙ†ÙÙŠØ° Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø¨Ø¹Ø¯.";
      }

      const timelineRows = STAGES.map((s, idx) => {
        const stepIndex = idx + 1;
        const key = "s" + stepIndex;
        const isDone = !!stagesMap[key];
        const ts = stagesMap[key];
        const timeStr = ts
          ? new Date(ts.toDate ? ts.toDate() : ts).toLocaleString("ar-SA")
          : "";

        return `
          <div class="stage-row ${isDone ? "done" : ""}">
            <div class="stage-icon ${isDone ? "done" : "pending"}">
              ${isDone ? "âœ“" : stepIndex}
            </div>
            <div>
              <div class="stage-text-main">${s.title}</div>
              <div class="stage-text-sub">${s.sub}</div>
              <div class="stage-time">
                ${isDone ? `ØªÙ…Øª ÙÙŠ: ${timeStr}` : "Ù„Ù… ØªÙÙ†ÙÙ‘Ø° Ø¨Ø¹Ø¯"}
              </div>
            </div>
          </div>
        `;
      }).join("");

      const progressHtml = `
        <div class="timeline-section">
          <div class="progress-wrap">
            <div class="progress-top">
              <span>Ù†Ø³Ø¨Ø© Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</span>
              <span>${Math.round(progress)}%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-bar-inner" style="width:${progress}%;"></div>
            </div>
          </div>
          <div class="current-stage-label">
            ${currentStageLabel}
          </div>
          ${
            updatedAt
              ? `<div class="last-updated">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨: ${updatedAt}</div>`
              : ""
          }
          <div class="timeline-list">${timelineRows}</div>
        </div>
      `;
      return progressHtml;
    }

    function renderCarBox(car, isActive, statusData) {
      const label = `${car.model || ""} ${car.trim || ""}`.trim() || "Ø³ÙŠØ§Ø±Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù… Ù…Ø­Ø¯Ø¯";
      const vinLabel = car.vin || car.id || "-";
      const exterior = car.exteriorColor || car.color || "-";
      const interior = car.interiorColor || "-";

      let subtotal = car.subtotalExclVAT || car.subtotalExclVat || car.subtotal;
      let tax = car.taxValue || car.vatValue;
      let total = car.totalInclVAT || car.totalInclVat || car.total;

      const subtNum = parseAmountFront(subtotal);
      const taxNum = parseAmountFront(tax);
      const totNum = parseAmountFront(total);

      if (totNum !== null && subtNum !== null && (taxNum === null || taxNum === 0)) {
        const diff = totNum - subtNum;
        if (diff > 0) {
          tax = diff;
        }
      }

      const subtotalStr = subtNum !== null ? `${formatAmount(subtNum)} Ø±.Ø³` : "-";
      const taxStr = parseAmountFront(tax) !== null ? `${formatAmount(tax)} Ø±.Ø³` : "-";
      const totalStr = totNum !== null ? `${formatAmount(totNum)} Ø±.Ø³` : "-";

      const statusHtml = statusData ? buildTimelineHtml(statusData) : "";

      return `
        <div class="car-box ${isActive ? "active" : ""}">
          <div class="car-main">${label}</div>
          <div class="car-meta">
            Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„: ${vinLabel} &nbsp;|&nbsp;
            Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ: ${exterior} &nbsp;|&nbsp;
            Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ: ${interior}
          </div>
          <div class="info-grid" style="margin-top:8px;">
            <div class="info-item">
              <div class="info-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</div>
              <div class="info-value">${subtotalStr}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ©)</div>
              <div class="info-value">${taxStr}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</div>
              <div class="info-value">${totalStr}</div>
            </div>
          </div>
          ${statusHtml}
        </div>
      `;
    }

    function renderResult(orderInfo, cars, activeIndex) {
      if (!orderInfo || !cars || cars.length === 0) {
        renderEmptyState();
        return;
      }

      const tabsHtml = cars
        .map((car, idx) => {
          const label = car.vin || car.id || `Ø³ÙŠØ§Ø±Ø© ${idx + 1}`;
          const isActive = idx === activeIndex;
          const statusData = car.statusData || {};
          const doneCount = statusData.stages
            ? Object.values(statusData.stages).filter(Boolean).length
            : 0;
          const pct = doneCount * (100 / STAGES.length);
          return `
            <button class="tab ${isActive ? "active" : ""}" data-idx="${idx}">
              <span>${label}</span>
              <small>${Math.round(pct)}%</small>
            </button>
          `;
        })
        .join("");

      const activeCar = cars[activeIndex] || cars[0];
      const carDetailsHtml = renderCarBox(activeCar, true, activeCar.statusData || {});

      const orderHeaderHtml = `
        <div class="section-title">
          <span class="icon-dot"></span>
          <span>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨</span>
        </div>
        <div class="info-grid">
          <div class="info-item">
            <div class="info-label">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</div>
            <div class="info-value">${orderInfo.orderNo || "-"}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
            <div class="info-value">${orderInfo.customerName || "-"}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Ø§Ù„ÙØ±Ø¹</div>
            <div class="info-value">${orderInfo.branch || "-"}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø·Ù„Ø¨ (Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)</div>
            <div class="info-value">
              ${
                orderInfo.totalInclVAT
                  ? formatAmount(orderInfo.totalInclVAT) + " Ø±.Ø³"
                  : "-"
              }
            </div>
          </div>
        </div>
      `;

      const carsSectionHtml = `
        <div class="section-title" style="margin-top:16px;">
          <span class="icon-dot"></span>
          <span>Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø·Ù„Ø¨</span>
        </div>
        <div class="tabs">${tabsHtml}</div>
        <div id="carDetailsArea">
          ${carDetailsHtml}
        </div>
      `;

      resultContainer.innerHTML = orderHeaderHtml + carsSectionHtml;

      const tabButtons = resultContainer.querySelectorAll(".tab");
      const carDetailsArea = document.getElementById("carDetailsArea");
      tabButtons.forEach((tab) => {
        tab.addEventListener("click", () => {
          tabButtons.forEach((t) => t.classList.remove("active"));
          tab.classList.add("active");
          const idx = Number(tab.getAttribute("data-idx") || "0");
          carDetailsArea.innerHTML = renderCarBox(cars[idx], true, cars[idx].statusData || {});
        });
      });
    }

    async function handleSearch() {
      const rawVin = (vinInput.value || "").trim();
      if (!rawVin) {
        setStatus("Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø£ÙˆÙ„Ø§Ù‹.", true);
        renderEmptyState();
        return;
      }

      setStatus("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø±ØªØ¨Ø· Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…â€¦");
      renderEmptyState();

      try {
        const vinDocRef = doc(db, "erp_vins", rawVin);
        const vinSnap   = await getDoc(vinDocRef);

        if (!vinSnap.exists()) {
          setStatus("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø·Ù„Ø¨ Ù…Ø±ØªØ¨Ø· Ø¨Ù‡Ø°Ø§ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø±Ù‚Ù… ÙˆØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.", true);
          renderEmptyState();
          return;
        }

        const vinData   = vinSnap.data ? vinSnap.data() : vinSnap;
        const orderBase = vinData.lastOrderNo || vinData.orderNo || "";
        const itemNoForVin = vinData.lastItemNo || vinData.itemNo || 1;

        let vinStatus = null;
        let fallbackOrderStatus = null;

        if (orderBase) {
          try {
            const newDocId = `${orderBase}_VIN_${rawVin}`;
            // Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù…Ù† public/status ÙÙŠ Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
            const newStatusRef = doc(db, "orders", newDocId, "public", "status");
            const newStatusSnap = await getDoc(newStatusRef);
            if (newStatusSnap.exists()) {
              vinStatus = newStatusSnap.data();
              fallbackOrderStatus = vinStatus;
            } else {
              // Ù„Ùˆ Ù…Ø§ ÙÙŠØ´ public/status Ù„Ø³Ù‡ØŒ Ù†Ù‚Ø±Ø£ Ù…Ù† Ø§Ù„Ø¯ÙˆÙƒÙˆÙ…Ù†Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ (ÙŠØ­Ù…Ù„ currentStage + stages)
              const baseStatusRef = doc(db, "orders", newDocId);
              const baseStatusSnap = await getDoc(baseStatusRef);
              if (baseStatusSnap.exists()) {
                vinStatus = baseStatusSnap.data();
                fallbackOrderStatus = vinStatus;
              }
            }
          } catch (eNew) {
            console.error("Error fetching new-structure status:", eNew);
          }

          if (!vinStatus) {
            try {
              const vinStatusRef = doc(db, "orders", orderBase, "public", rawVin);
              const vinStatusSnap = await getDoc(vinStatusRef);
              if (vinStatusSnap.exists()) {
                vinStatus = vinStatusSnap.data();
                fallbackOrderStatus = fallbackOrderStatus || vinStatus;
              }
            } catch (eOldVin) {
              console.error("Error fetching old VIN-based status:", eOldVin);
            }
          }

          if (!vinStatus) {
            try {
              const fallbackRef = doc(db, "orders", orderBase, "public", "status");
              const fallbackSnap = await getDoc(fallbackRef);
              if (fallbackSnap.exists()) {
                fallbackOrderStatus = fallbackSnap.data();
                vinStatus = vinStatus || fallbackOrderStatus;
              }
            } catch (eFallback) {
              console.error("Error fetching fallback order status:", eFallback);
            }
          }
        }

        const lastData = vinData.lastData || {};
        const orderInfo = {
          orderNo: vinData.lastOrderNo || lastData.orderNo || orderBase,
          customerName: lastData.customerName || "-",
          branch: lastData.branch || "-",
          totalInclVAT: lastData.totalInclVAT || lastData.orderTotalInclVAT || lastData.orderTotalInclVat || null
        };

        const vinsCol = collection(db, "erp_vins");
        const q = query(vinsCol, where("lastOrderNo", "==", orderBase));
        const qsnap = await getDocs(q);

        const cars = [];
        if (!qsnap.empty) {
          qsnap.forEach((d) => {
            const data = d.data ? d.data() : d;
            const payload = data.lastData || {};
            cars.push({
              id: d.id,
              vin: d.id,
              model: payload.model || payload.carModel || "",
              trim: payload.trim || "",
              exteriorColor: payload.exteriorColor || payload.color || "",
              interiorColor: payload.interiorColor || "",
              subtotalExclVAT: payload.subtotalExclVAT || payload.subtotalExclVat || payload.subtotal,
              taxValue: payload.taxValue || payload.vatValue,
              totalInclVAT: payload.totalInclVAT || payload.totalInclVat || payload.total,
              itemNo: data.lastItemNo || data.itemNo || 1
            });
          });
        } else {
          cars.push({
            id: rawVin,
            vin: rawVin,
            model: lastData.model || lastData.carModel || "",
            trim: lastData.trim || "",
            exteriorColor: lastData.exteriorColor || lastData.color || "",
            interiorColor: lastData.interiorColor || "",
            subtotalExclVAT: lastData.subtotalExclVAT || lastData.subtotalExclVat || lastData.subtotal,
            taxValue: lastData.taxValue || lastData.vatValue,
            totalInclVAT: lastData.totalInclVAT || lastData.totalInclVat || lastData.total,
            itemNo: itemNoForVin
          });
        }

        let activeIndex = 0;

        if (vinStatus) {
          const idx = cars.findIndex((c) => (c.vin || c.id) === rawVin);
          if (idx >= 0) activeIndex = idx;
        }

        for (const car of cars) {
          const carItemNo = car.itemNo || 1;
          if (orderBase) {
            try {
              const carDocId = `${orderBase}_VIN_${car.vin || car.id || ""}`;
              const carStatusRef = doc(db, "orders", carDocId, "public", "status");
              const carStatusSnap = await getDoc(carStatusRef);
              if (carStatusSnap.exists()) {
                car.statusData = carStatusSnap.data();
              } else if (fallbackOrderStatus && car.vin === rawVin) {
                car.statusData = fallbackOrderStatus;
              } else if (vinStatus && car.vin === rawVin) {
                car.statusData = vinStatus;
              }
            } catch (eCar) {
              console.error("Error fetching car status", eCar);
            }
          }
        }

        if (!cars.some((c) => c.statusData) && vinStatus) {
          const idx = cars.findIndex((c) => (c.vin || c.id) === rawVin);
          if (idx >= 0) {
            cars[idx].statusData = vinStatus;
          }
        }

        renderResult(orderInfo, cars, activeIndex);
        setStatus("ØªÙ… Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­.");
      } catch (err) {
        console.error(err);
        setStatus("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ø§Ù‹.", true);
        renderEmptyState();
      }
    }

    searchBtn.addEventListener("click", handleSearch);
    vinInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        handleSearch();
      }
    });

    renderEmptyState();
  </script>
</body>
</html>
