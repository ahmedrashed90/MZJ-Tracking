<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>MZJ — تتبع الطلب</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --brown:#3e2420;
      --beige:#bc8f74;
      --cream:#fff8ef;
      --ok:#0e7a48;
      --muted:#6b7280;
      --grey:#d1d5db;
    }
    *{box-sizing:border-box}
    body{
      font-family:"Tajawal",system-ui;
      background:var(--cream);
      margin:0;
      color:#1f2937;
    }
    .wrap{
      max-width:800px;
      margin:40px auto;
      padding:16px;
    }
    .brand{
      font-weight:800;
      color:var(--brown);
      margin-bottom:10px;
    }
    .card{
      background:#fff;
      border-radius:14px;
      box-shadow:0 8px 30px rgba(62,36,32,.08);
      padding:18px;
      margin-bottom:20px;
    }
    label{font-weight:700;color:var(--brown);display:block;margin-bottom:6px}
    input{
      width:100%;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid #e5e7eb;
      outline:none;
    }
    button{
      background:var(--brown);
      color:#fff;
      border:0;
      padding:12px 18px;
      border-radius:12px;
      font-weight:800;
      cursor:pointer;
      white-space:nowrap;
    }
    .row{
      display:flex;
      gap:8px;
      align-items:center;
    }
    @media(max-width:640px){
      .row{flex-direction:column;align-items:stretch}
      button{width:100%}
    }
    #searchMsg{color:var(--muted);font-size:14px;margin-top:6px}

    /* شريط التقدم */
    .progress-wrap{
      margin-bottom:16px;
    }
    .progress-label{
      font-size:14px;
      color:var(--muted);
      margin-bottom:6px;
    }
    .progress-bar-bg{
      width:100%;
      height:10px;
      border-radius:999px;
      background:#f3f4f6;
      overflow:hidden;
      position:relative;
    }
    .progress-bar-fill{
      height:100%;
      width:0;
      background:var(--ok);
      border-radius:999px;
      transition:width .25s ease-out;
    }
    .progress-percent{
      font-size:13px;
      color:var(--brown);
    }

    .timeline{list-style:none;padding:0;margin:0}
    .timeline li{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding:8px 0;
      border-bottom:1px dashed #eee;
    }
    .dot{
      width:18px;
      height:18px;
      border-radius:50%;
      margin-top:4px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:11px;
      color:#fff;
      flex-shrink:0;
    }
    .dot.done{background:var(--ok);}
    .dot.next{background:var(--grey);}

    .stage-title{
      font-weight:700;
      color:var(--brown);
      margin-bottom:2px;
    }
    .ts{
      font-size:13px;
      color:var(--muted);
    }
    .badge{
      display:inline-block;
      background:var(--beige);
      color:#fff;
      padding:4px 8px;
      border-radius:999px;
      font-size:12px;
      margin-right:4px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="brand">مع محمد بن ذعار العجمي للسيارات… أنت نجم الطريق ✨</div>

    <div class="card">
      <label>أدخل رقم الطلب</label>
      <div class="row">
        <input id="orderIdInput" placeholder="مثال: MZJ-2025-0001">
        <button id="trackBtn">تتبّع الطلب</button>
      </div>
      <p id="searchMsg"></p>
    </div>

    <div class="card" id="resultCard" style="display:none">
      <p>
        <span class="badge">حالة الطلب</span>
        <strong id="stageNow"></strong>
      </p>

      <!-- شريط التقدم -->
      <div class="progress-wrap">
        <div class="progress-label">تقدّم الطلب</div>
        <div class="progress-bar-bg">
          <div id="progressFill" class="progress-bar-fill"></div>
        </div>
        <div class="progress-percent">
          مكتمل بنسبة <span id="progressPercent">0</span>%
        </div>
      </div>

      <ul id="timeline" class="timeline"></ul>
      <p id="updatedAt" class="ts" style="margin-top:8px"></p>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, doc, getDoc, Timestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // إعدادات مشروعك mzj-tracking
    const firebaseConfig = {
      apiKey: "AIzaSyCorGtT5_Z68jCtLODvqnv0Fb7QW5eR6MQ",
      authDomain: "mzj-tracking.firebaseapp.com",
      projectId: "mzj-tracking",
      storageBucket: "mzj-tracking.appspot.com",
      messagingSenderId: "655452217491",
      appId: "1:655452217491:web:9348d172c47bdd411fad66",
      measurementId: "G-QT7KTRWS4J"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // نصوص المراحل
    const STAGES = [
      "1) إنشاء الطلب",
      "2) أمر الدفع",
      "3) تواصل خدمة العملاء وإرسال البطاقة الجمركية",
      "4) سداد رسوم التسجيل",
      "5) التأمين (شرط الربط على السيستم)",
      "6) استيفاء الأوراق والمبالغ",
      "7) تجيير البطاقة الجمركية",
      "8) إصدار اللوحات أو نقل الملكية",
      "9) جاهزية السيارة للاستلام أو الشحن",
      "10) إتمام عملية التسليم"
    ];

    const input      = document.getElementById("orderIdInput");
    const btn        = document.getElementById("trackBtn");
    const msg        = document.getElementById("searchMsg");
    const card       = document.getElementById("resultCard");
    const stageNow   = document.getElementById("stageNow");
    const timeline   = document.getElementById("timeline");
    const updatedAt  = document.getElementById("updatedAt");
    const progressFill    = document.getElementById("progressFill");
    const progressPercent = document.getElementById("progressPercent");

    function fmtTS(v){
      if (!v) return null;
      const d = v instanceof Timestamp ? v.toDate() : (v.toDate ? v.toDate() : new Date(v));
      return new Date(d).toLocaleString("ar-SA");
    }

    function render(data){
      card.style.display = "";
      timeline.innerHTML = "";

      const stagesData = data.stages || {};
      const total      = STAGES.length;

      // أعلى مرحلة منتهية (بناءً على وجود وقت في stages.sX)
      let maxCompleted = 0;
      for (let i = 1; i <= total; i++){
        const key = "s" + i;
        if (stagesData[key]) maxCompleted = i;
      }

      // لو مفيش ختم لكن في currentStage، نستخدمه كفاallback
      const current = data.currentStage || 0;
      if (maxCompleted === 0 && current > 0){
        maxCompleted = current;
      }

      const safeCompleted = Math.min(Math.max(maxCompleted,0), total);

      // نص الحالة أعلى
      if (safeCompleted === 0){
        stageNow.textContent = "الطلب مسجَّل ولم تبدأ مراحله بعد.";
      } else if (safeCompleted === total){
        stageNow.textContent = `اكتملت جميع المراحل (${total}/${total})`;
      } else {
        stageNow.textContent = `تم الانتهاء من المرحلة ${safeCompleted} من ${total}`;
      }

      // شريط التقدم
      const percent = total === 0 ? 0 : Math.round((safeCompleted / total) * 100);
      progressFill.style.width = percent + "%";
      progressPercent.textContent = percent;

      updatedAt.textContent = data.updatedAt ? ("آخر تحديث: " + fmtTS(data.updatedAt)) : "";

      STAGES.forEach((label, idx) => {
        const stageNumber = idx + 1;
        const key = "s" + stageNumber;
        const ts  = stagesData[key] ? fmtTS(stagesData[key]) : null;

        const li  = document.createElement("li");
        const dot = document.createElement("div");
        dot.classList.add("dot");

        if (stageNumber <= safeCompleted){
          dot.classList.add("done");
          dot.textContent = "✔";
        } else {
          dot.classList.add("next");
          dot.textContent = "";
        }

        const ct  = document.createElement("div");
        let statusText;

        if (stageNumber <= safeCompleted){
          statusText = ts ? (`تم الانتهاء: ${ts}`) : "تم الانتهاء";
        } else {
          statusText = "لم تبدأ بعد";
        }

        ct.innerHTML = `
          <div class="stage-title">${label}</div>
          <div class="ts">${statusText}</div>
        `;

        li.appendChild(dot);
        li.appendChild(ct);
        timeline.appendChild(li);
      });
    }

    async function fetchStatus(){
      msg.textContent = "";
      const id = input.value.trim();
      if (!id){
        msg.textContent = "من فضلك اكتب رقم الطلب.";
        card.style.display = "none";
        return;
      }

      const ref  = doc(db, "orders", id, "public", "status");
      const snap = await getDoc(ref);

      if (!snap.exists()){
        card.style.display = "none";
        msg.textContent = "لايوجد طلب بهذا الرقم. تأكد من الرقم أو تواصل مع خدمة العملاء.";
        return;
      }

      render(snap.data());
    }

    btn.addEventListener("click", fetchStatus);
    input.addEventListener("keydown", e => {
      if (e.key === "Enter") fetchStatus();
    });

    // دعم رابط مباشر: track.html?order=XXXX
    const params = new URLSearchParams(location.search);
    const qOrder = params.get("order");
    if (qOrder){
      input.value = qOrder;
      fetchStatus();
    }
  </script>
</body>
</html>
