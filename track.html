<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ØªØªØ¨Ø¹ Ø·Ù„Ø¨Ùƒ - Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: "Tajawal", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f6f4f0;
      color: #3e2420;
    }
    .page {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    .shell {
      max-width: 960px;
      width: 100%;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 18px 45px rgba(62, 36, 32, 0.22);
      padding: 16px;
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.4fr);
      gap: 12px;
    }
    @media (max-width: 900px) {
      .shell {
        grid-template-columns: 1fr;
      }
    }
    .brand-side {
      border-radius: 14px;
      background: linear-gradient(135deg, #3e2420 0%, #5b4035 45%, #bc8f74 100%);
      padding: 14px 14px 16px;
      color: #fff;
      position: relative;
      overflow: hidden;
    }
    .brand-head {
      display: flex;
      align-items: center;
      gap: 9px;
      margin-bottom: 10px;
      position: relative;
      z-index: 2;
    }
    .brand-logo {
      width: 34px;
      height: 34px;
      border-radius: 12px;
      background: radial-gradient(circle at 30% 20%, #ffe7c2 0%, #fbbf77 35%, #a8693b 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 19px;
      font-weight: 800;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.35);
    }
    .brand-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .brand-text-main {
      font-size: 14px;
      font-weight: 700;
    }
    .brand-text-sub {
      font-size: 11px;
      opacity: 0.9;
    }
    .brand-body {
      font-size: 12px;
      opacity: 0.95;
      margin-bottom: 10px;
      position: relative;
      z-index: 2;
    }
    .brand-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      border-radius: 999px;
      padding: 4px 9px;
      background: rgba(15, 118, 110, 0.16);
      border: 1px solid rgba(45, 212, 191, 0.6);
      margin-bottom: 6px;
    }
    .brand-pill span.dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.45);
    }
    .brand-footer {
      font-size: 11px;
      opacity: 0.9;
      margin-top: 6px;
    }
    .brand-bg-glow {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }
    .brand-bg-glow::before,
    .brand-bg-glow::after {
      content: "";
      position: absolute;
      border-radius: 999px;
      filter: blur(22px);
      opacity: 0.55;
    }
    .brand-bg-glow::before {
      width: 140px;
      height: 140px;
      background: rgba(251, 191, 77, 0.8);
      top: -30px;
      left: -20px;
    }
    .brand-bg-glow::after {
      width: 160px;
      height: 160px;
      background: rgba(34, 211, 238, 0.5);
      bottom: -40px;
      right: -20px;
    }

    .right-side {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .search-card {
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      padding: 10px 12px;
    }
    .search-title {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 4px;
      color: #3e2420;
    }
    .search-sub {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 8px;
    }
    .search-row {
      display: grid;
      grid-template-columns: minmax(0, 1.6fr) auto;
      gap: 8px;
      align-items: flex-end;
    }
    @media (max-width: 640px) {
      .search-row {
        grid-template-columns: 1fr;
      }
    }
    label {
      display: block;
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 2px;
    }
    input[type="text"] {
      width: 100%;
      padding: 7px 9px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #fff;
      font-family: inherit;
      font-size: 13px;
      outline: none;
      direction: rtl;
    }
    input[type="text"]:focus {
      border-color: #bc8f74;
      box-shadow: 0 0 0 1px rgba(188, 143, 116, 0.35);
    }
    .btn {
      border-radius: 999px;
      border: 0;
      padding: 8px 13px;
      font-size: 13px;
      font-family: inherit;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      background: #3e2420;
      color: #fff;
      white-space: nowrap;
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .status-msg {
      font-size: 11px;
      margin-top: 4px;
      color: #6b7280;
    }
    .status-msg.ok {
      color: #16a34a;
      font-weight: 600;
    }
    .status-msg.err {
      color: #b91c1c;
      font-weight: 600;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-top: 6px;
    }
    @media (max-width: 640px) {
      .info-grid {
        grid-template-columns: 1fr;
      }
    }
    .info-card {
      border-radius: 12px;
      background: #fff;
      border: 1px solid #e5e7eb;
      padding: 8px 9px;
      font-size: 12px;
    }
    .info-label {
      font-size: 11px;
      color: #6b7280;
    }
    .info-value {
      font-size: 13px;
      font-weight: 700;
      color: #3e2420;
    }

    .status-block {
      border-radius: 14px;
      background: #fff;
      border: 1px solid #e5e7eb;
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .status-summary {
      font-size: 12px;
      color: #374151;
    }
    .status-summary strong {
      color: #3e2420;
    }
    .progress-wrapper {
      margin-top: 4px;
    }
    .progress-header {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 3px;
    }
    .progress-percent-strong {
      font-weight: 700;
      color: #3e2420;
      font-size: 12px;
    }
    .progress-bar {
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: #f3f4f6;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      border-radius: inherit;
      background: linear-gradient(90deg, #bc8f74, #3e2420);
      width: 0;
      transition: width 0.35s ease-out;
    }

    .timeline {
      margin-top: 8px;
    }
    .timeline-title {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #3e2420;
    }
    .timeline-steps {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .timeline-step {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 6px 7px;
      border-radius: 10px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      font-size: 12px;
    }
    .step-icon {
      width: 20px;
      height: 20px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: #4b5563;
      flex-shrink: 0;
      background: #fff;
    }
    .step-icon.done {
      background: #22c55e;
      border-color: #16a34a;
      color: #fff;
    }
    .step-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .step-title {
      font-size: 12px;
      font-weight: 600;
      color: #3e2420;
    }
    .step-sub {
      font-size: 11px;
      color: #6b7280;
    }
    .step-sub span {
      color: #374151;
    }

    .car-summary {
      margin-top: 6px;
      border-radius: 12px;
      background: linear-gradient(135deg, #3e2420 0%, #5b4035 45%, #bc8f74 100%);
      padding: 12px 14px;
      color: #fff;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    .car-main {
      font-size: 14px;
      font-weight: 700;
    }
    .car-meta {
      font-size: 12px;
      opacity: 0.95;
    }
    .car-meta span {
      opacity: 0.85;
    }
    .car-more {
      font-size: 11px;
      opacity: 0.9;
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="shell">
      <div class="brand-side">
        <div class="brand-bg-glow"></div>
        <div class="brand-head">
          <div class="brand-logo">â˜…</div>
          <div class="brand-text">
            <div class="brand-text-main">Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª</div>
            <div class="brand-text-sub">Ù†Ø¸Ø§Ù… ØªØªØ¨Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„</div>
          </div>
        </div>
        <div class="brand-body">
          <div class="brand-pill">
            <span class="dot"></span>
            <span>Ù†Ø¸Ø§Ù… Ù…ØªØµÙ„ Ù…Ø¨Ø§Ø´Ø±Ø©Ù‹ Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Ø§Ù„Ù…Ø¹Ø±Ø¶</span>
          </div>
          <div>
            Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ (Ø§Ù„Ø´Ø§ØµÙŠ) ÙƒÙ…Ø§ Ù‡Ùˆ ÙÙŠ Ø¹Ù‚Ø¯ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø£Ùˆ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø©ØŒ
            Ù„ÙŠØ¸Ù‡Ø± Ù„Ùƒ Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ­Ø§Ù„Ø© Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ù…Ù† Ù„Ø­Ø¸Ø© Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø­ØªÙ‰ ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø³ÙŠØ§Ø±Ø©.
          </div>
        </div>
        <div class="brand-footer">
          Ù…Ø¹ Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ:
          <strong>Ø§Ù„Ù…ØµØ¯Ø§Ù‚ÙŠØ© ØªØ£Ø³Ù‘Ø³ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø©â€¦ Ø§Ù„Ø¥ØªÙ‚Ø§Ù† ÙŠÙƒÙ…Ù„Ù‡Ø§â€¦ ÙˆØ§Ù„Ø³Ø±Ø¹Ø© ØªØ®ØªØµØ±Ù‡Ø§.</strong>
        </div>
      </div>

      <div class="right-side">
        <div class="search-card">
          <div class="search-title">ØªØªØ¨Ø¹ Ø·Ù„Ø¨Ùƒ Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„</div>
          <div class="search-sub">
            Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„ÙƒØ§Ù…Ù„ØŒ ÙˆØ§Ø¶ØºØ· "ØªØªØ¨Ø¹ Ø§Ù„Ø·Ù„Ø¨" Ù„ÙŠØªÙ… Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ ÙˆØ§Ù„Ø³ÙŠØ§Ø±Ø© ÙˆØ­Ø§Ù„Ø© Ø§Ù„Ù…Ø±Ø§Ø­Ù„.
          </div>
          <div class="search-row">
            <div>
              <label for="vinInput">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ (VIN)</label>
              <input id="vinInput" type="text" placeholder="Ù…Ø«Ø§Ù„: KMHXXXXXXXXXXXXXX" />
            </div>
            <button class="btn" id="trackBtn">ğŸ” ØªØªØ¨Ø¹ Ø§Ù„Ø·Ù„Ø¨</button>
          </div>
          <div id="statusMsg" class="status-msg">
            Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ÙƒÙ…Ø§ Ù‡Ùˆ ÙÙŠ Ø¹Ù‚Ø¯ Ø§Ù„Ø´Ø±Ø§Ø¡.
          </div>
        </div>

        <div id="orderBlock" style="display:none;">
          <div class="info-grid">
            <div class="info-card">
              <div class="info-label">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</div>
              <div class="info-value" id="orderIdEl">â€”</div>
            </div>
            <div class="info-card">
              <div class="info-label">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
              <div class="info-value" id="customerNameEl">â€”</div>
            </div>
            <div class="info-card">
              <div class="info-label">Ø§Ù„ÙØ±Ø¹</div>
              <div class="info-value" id="branchEl">â€”</div>
            </div>
            <div class="info-card">
              <div class="info-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø·Ù„Ø¨ (Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)</div>
              <div class="info-value" id="orderTotalEl">â€”</div>
            </div>
          </div>

          <div class="car-summary" id="carSummary">
            <div class="car-main" id="carNameEl">â€”</div>
            <div class="car-meta">
              Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„: <span id="vinEl">â€”</span>
            </div>
            <div class="car-more">
              Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ: <span id="extColorEl">â€”</span> â€¢
              Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ: <span id="intColorEl">â€”</span>
            </div>
          </div>

          <div class="info-grid">
            <div class="info-card">
              <div class="info-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</div>
              <div class="info-value" id="subtotalEl">â€”</div>
            </div>
            <div class="info-card">
              <div class="info-label">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ©)</div>
              <div class="info-value" id="vatEl">â€”</div>
            </div>
            <div class="info-card">
              <div class="info-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</div>
              <div class="info-value" id="totalInclEl">â€”</div>
            </div>
            <div class="info-card">
              <div class="info-label">Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…</div>
              <div class="info-value" id="erpStatusEl">â€”</div>
            </div>
          </div>

          <div class="status-block" id="statusBlock">
            <!-- timeline injected here -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      doc,
      getDoc,
      getDocs,
      query,
      where
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCorGtT5_Z68jCtLODvqnv0Fb7QW5eR6MQ",
      authDomain: "mzj-tracking.firebaseapp.com",
      projectId: "mzj-tracking",
      storageBucket: "mzj-tracking.firebasestorage.app",
      messagingSenderId: "655452217491",
      appId: "1:655452217491:web:9348d172c47bdd411fad66"
    };

    const app  = initializeApp(firebaseConfig);
    const db   = getFirestore(app);

    const STAGES = [
      { title:"1) Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)", sub:"ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨Ùƒ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­." },
      { title:"2) Ø¥ÙŠØµØ§Ù„ Ø§Ù„Ø¯ÙØ¹ â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)", sub:"ÙŠØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ù…Ø¨Ù„Øº Ø§Ù„Ø¯ÙØ¹Ø© Ø£Ùˆ ØªØ±ØªÙŠØ¨ Ø®ÙŠØ§Ø± Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨." },
      { title:"3) Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ù† Ù‚ÙØ¨Ù„ Ù…Ù…Ø«Ù„ÙŠ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø¨Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¬Ø±ÙƒÙŠØ© â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø¹Ø±Ø¶)", sub:"Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ØªØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù„Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¬Ø±ÙƒÙŠØ©." },
      { title:"4) Ø³Ø¯Ø§Ø¯ Ø±Ø³ÙˆÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)", sub:"ÙŠØªÙ… Ø³Ø¯Ø§Ø¯ Ø±Ø³ÙˆÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¹Ø¨Ø± Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ø±Ø³Ù…ÙŠØ©." },
      { title:"5) Ø§Ù„ØªØ£Ù…ÙŠÙ† â€“ Ø´Ø±Ø· Ø§Ù„Ø±Ø¨Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ³ØªÙ… â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)", sub:"Ø§Ø®ØªÙŠØ§Ø± Ø´Ø±ÙƒØ© Ø§Ù„ØªØ£Ù…ÙŠÙ† ÙˆØ±Ø¨Ø· Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù…." },
      { title:"6) Ø§Ø³ØªÙŠÙØ§Ø¡ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)", sub:"ÙŠØªÙ… Ø³Ø¯Ø§Ø¯ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº Ø¥Ù† ÙˆØ¬Ø¯." },
      { title:"7) Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù„ÙˆØ­Ø§Øª Ø£Ùˆ Ù†Ù‚Ù„ Ø§Ù„Ù…Ù„ÙƒÙŠØ© â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø¹Ø±Ø¶)", sub:"Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± ÙˆØ¥ØµØ¯Ø§Ø± Ø§Ù„Ù„ÙˆØ­Ø§Øª Ø£Ùˆ Ù†Ù‚Ù„ Ø§Ù„Ù…Ù„ÙƒÙŠØ©." },
      { title:"8) Ø§Ø³ØªÙŠÙØ§Ø¡ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)", sub:"ØªØ¬Ù‡ÙŠØ² ÙˆØªØ³Ù„ÙŠÙ… ÙƒØ§ÙØ© Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ø±Ø³Ù…ÙŠØ©." },
      { title:"9) Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ù„Ù„Ø§Ø³ØªÙ„Ø§Ù… â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø¹Ø±Ø¶)", sub:"Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø¬Ø§Ù‡Ø²Ø© ÙÙŠ Ø§Ù„Ù…Ø¹Ø±Ø¶ Ù„Ù„Ø§Ø³ØªÙ„Ø§Ù…." },
      { title:"10) Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­", sub:"ØªÙ… ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ù„Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­." }
    ];

    const vinInput     = document.getElementById("vinInput");
    const trackBtn     = document.getElementById("trackBtn");
    const statusMsg    = document.getElementById("statusMsg");
    const orderBlock   = document.getElementById("orderBlock");
    const statusBlock  = document.getElementById("statusBlock");

    const orderIdEl      = document.getElementById("orderIdEl");
    const customerNameEl = document.getElementById("customerNameEl");
    const branchEl       = document.getElementById("branchEl");
    const orderTotalEl   = document.getElementById("orderTotalEl");

    const carNameEl   = document.getElementById("carNameEl");
    const vinEl       = document.getElementById("vinEl");
    const extColorEl  = document.getElementById("extColorEl");
    const intColorEl  = document.getElementById("intColorEl");
    const subtotalEl  = document.getElementById("subtotalEl");
    const vatEl       = document.getElementById("vatEl");
    const totalInclEl = document.getElementById("totalInclEl");
    const erpStatusEl = document.getElementById("erpStatusEl");

    function setStatus(msg, type = "") {
      statusMsg.textContent = msg;
      statusMsg.classList.remove("ok", "err");
      if (type === "ok") statusMsg.classList.add("ok");
      if (type === "err") statusMsg.classList.add("err");
    }

    function parseAmount(v) {
      if (v === null || v === undefined) return null;
      if (typeof v === "number") return v;
      const s = String(v).replace(/[^\d.,-]/g, "").replace(/,/g, "");
      const n = parseFloat(s);
      return isNaN(n) ? null : n;
    }

    function fmtCurrency(n) {
      if (n === null || n === undefined || isNaN(n)) return "â€”";
      return n.toLocaleString("ar-SA", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }) + " Ø±.Ø³";
    }

    function buildTimelineHtml(statusData) {
      const track = statusData || {};
      const stagesMap = track.stages || {};
      const updatedAt = track.updatedAt
        ? new Date(track.updatedAt.toDate ? track.updatedAt.toDate() : track.updatedAt).toLocaleString("ar-SA")
        : "";

      const doneKeys = Object.keys(stagesMap).filter((k) => /^s\\d+$/.test(k) && stagesMap[k]);

      let maxIndex = 0;
      for (const key of doneKeys) {
        const n = parseInt(key.slice(1), 10);
        if (!isNaN(n) && n > maxIndex) {
          maxIndex = n;
        }
      }

      const doneCount = doneKeys.length;
      const total = STAGES.length;
      const progress = total ? Math.min(100, Math.round((doneCount / total) * 100)) : 0;

      let currentStageLabel = "Ù„Ù… ÙŠØ¨Ø¯Ø£ Ø¨Ø¹Ø¯";
      if (maxIndex > 0 && maxIndex <= STAGES.length) {
        currentStageLabel = STAGES[maxIndex - 1].title;
      }

      return `
        <div class="status-summary">
          <div>Ø­Ø§Ù„Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <strong>${currentStageLabel}</strong></div>
          <div>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« Ù„Ù„Ø­Ø§Ù„Ø©: <span>${updatedAt || "-"}</span></div>
        </div>
        <div class="progress-wrapper">
          <div class="progress-header">
            <span>Ù†Ø³Ø¨Ø© Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</span>
            <span class="progress-percent-strong">${progress}%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" style="width:${progress}%;"></div>
          </div>
        </div>
        <div class="timeline">
          <div class="timeline-title">Ø®Ø·ÙˆØ§Øª Ø·Ù„Ø¨Ùƒ Ù…Ù† Ø£ÙˆÙ„ Ø­Ø¬Ø² Ø­ØªÙ‰ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©</div>
          <ul class="timeline-steps">
            ${STAGES.map((step, idx) => {
              const stepIndex = idx + 1;
              const doneTs = stagesMap["s" + stepIndex];
              const isDone = !!doneTs;
              const tsLabel = doneTs
                ? new Date(doneTs.toDate ? doneTs.toDate() : doneTs).toLocaleString("ar-SA")
                : "";
              return `
                <li class="timeline-step">
                  <div class="step-icon ${isDone ? "done" : ""}">
                    ${isDone ? "âœ“" : stepIndex}
                  </div>
                  <div class="step-body">
                    <div class="step-title">${step.title}</div>
                    <div class="step-sub">
                      ${step.sub}
                      ${tsLabel ? " â€” <span>ØªÙ… ÙÙŠ: ${tsLabel}</span>" : ""}
                    </div>
                  </div>
                </li>
              `;
            }).join("")}
          </ul>
        </div>
      `;
    }

    async function fetchVinDoc(rawVin) {
      const col = collection(db, "erp_vins");
      let q1 = query(col, where("vin", "==", rawVin));
      let snap = await getDocs(q1);
      if (!snap.empty) return snap.docs[0];

      const asNum = Number(rawVin);
      if (!Number.isNaN(asNum)) {
        q1 = query(col, where("vin", "==", asNum));
        snap = await getDocs(q1);
        if (!snap.empty) return snap.docs[0];
      }

      try {
        const directRef = doc(db, "erp_vins", rawVin);
        const directSnap = await getDoc(directRef);
        if (directSnap.exists()) return directSnap;
      } catch (e) {
        console.error("direct vin doc error", e);
      }
      return null;
    }

    async function fetchErpOrder(orderBase) {
      if (!orderBase) return null;
      try {
        const ref = doc(db, "erp_orders", orderBase);
        const snap = await getDoc(ref);
        if (!snap.exists()) return null;
        return snap.data() || null;
      } catch (e) {
        console.error("fetchErpOrder error", e);
        return null;
      }
    }

    async function fetchStatusForVin(orderBase, rawVin, itemNoForVin) {
      let vinStatus = null;
      let fallbackOrderStatus = null;

      if (orderBase) {
        try {
          const vinDocId = `${orderBase}_VIN_${rawVin}`;
          const vinStatusRef = doc(db, "orders", vinDocId, "public", "status");
          const vinStatusSnap = await getDoc(vinStatusRef);
          if (vinStatusSnap.exists()) {
            vinStatus = vinStatusSnap.data();
            fallbackOrderStatus = vinStatus;
          }
        } catch (eVin) {
          console.error("Error fetching VIN-structure status:", eVin);
        }

        if (!vinStatus) {
          try {
            const newDocId = `${orderBase}_${itemNoForVin}`;
            const newStatusRef = doc(db, "orders", newDocId, "public", "status");
            const newStatusSnap = await getDoc(newStatusRef);
            if (newStatusSnap.exists()) {
              vinStatus = newStatusSnap.data();
              fallbackOrderStatus = vinStatus;
            }
          } catch (eNew) {
            console.error("Error fetching new-structure status:", eNew);
          }
        }

        if (!vinStatus) {
          try {
            const vinStatusRefOld = doc(db, "orders", orderBase, "public", rawVin);
            const vinStatusSnapOld = await getDoc(vinStatusRefOld);
            if (vinStatusSnapOld.exists()) {
              vinStatus = vinStatusSnapOld.data();
              fallbackOrderStatus = fallbackOrderStatus || vinStatus;
            }
          } catch (eOldVin) {
            console.error("Error fetching old VIN-based status:", eOldVin);
          }
        }

        if (!vinStatus) {
          try {
            const fallbackRef = doc(db, "orders", orderBase, "public", "status");
            const fallbackSnap = await getDoc(fallbackRef);
            if (fallbackSnap.exists()) {
              fallbackOrderStatus = fallbackSnap.data();
              vinStatus = vinStatus || fallbackOrderStatus;
            }
          } catch (eFallback) {
            console.error("Error fetching legacy fallback status:", eFallback);
          }
        }
      }

      return { vinStatus, fallbackOrderStatus };
    }

    function renderSingleCar(vinData, statusData) {
      const lastOrderNo = vinData.lastOrderNo || "";
      const payload     = vinData.lastData || {};

      const customerName = payload.customerName || payload.CustomerName || "";
      const branch       = payload.branch || payload.Branch || "";
      const totalIncl    = parseAmount(
        payload.totalInclVAT ??
        payload.TotalInclVAT ??
        payload.orderTotalInclVAT ??
        payload.orderTotalInclVat
      );

      orderIdEl.textContent      = lastOrderNo || "â€”";
      customerNameEl.textContent = customerName || "â€”";
      branchEl.textContent       = branch || "â€”";
      orderTotalEl.textContent   = totalIncl !== null ? fmtCurrency(totalIncl) : "â€”";

      const carLabel = [payload.itemCategory, payload.itemModel]
        .filter(Boolean)
        .join(" â€” ");
      const exteriorColor = payload.exteriorColor || "â€”";
      const interiorColor = payload.interiorColor || "â€”";

      carNameEl.textContent  = carLabel || "â€”";
      vinEl.textContent      = vinData.vin || vinData.VIN || "â€”";
      extColorEl.textContent = exteriorColor;
      intColorEl.textContent = interiorColor;

      const subtotalVal = parseAmount(payload.subtotalExclVAT ?? payload.SubtotalExclVAT);
      const vatVal      = parseAmount(payload.taxValue ?? payload.TaxValue);

      subtotalEl.textContent  = subtotalVal !== null ? fmtCurrency(subtotalVal) : "â€”";
      vatEl.textContent       = vatVal !== null ? fmtCurrency(vatVal) : "â€”";
      totalInclEl.textContent = totalIncl !== null ? fmtCurrency(totalIncl) : "â€”";

      const statusHtml = buildTimelineHtml(statusData);
      statusBlock.innerHTML = statusHtml;
      orderBlock.style.display = "block";
    }

    async function handleTrack() {
      setStatus("Ø¬Ø§Ø±Ù Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø±ØªØ¨Ø· Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù‡ÙŠÙƒÙ„...");
      orderBlock.style.display = "none";
      statusBlock.innerHTML    = "";

      const rawVin = (vinInput.value || "").trim();
      if (!rawVin) {
        setStatus("Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø£ÙˆÙ„Ø§Ù‹.", "err");
        return;
      }

      try {
        const vinSnap = await fetchVinDoc(rawVin);
        if (!vinSnap) {
          setStatus("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù‡ÙŠÙƒÙ„ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø±Ù‚Ù… ÙˆØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.", "err");
          return;
        }

        const vinData = vinSnap.data() || {};
        const orderBase = vinData.lastOrderNo || "";
        const itemNoForVin = vinData.lastItemNo || (vinData.lastData && vinData.lastData.itemNo) || 1;

        if (!orderBase) {
          setStatus("Ù‡Ø°Ø§ Ø§Ù„Ù‡ÙŠÙƒÙ„ ØºÙŠØ± Ù…Ø±ØªØ¨Ø· Ø¨Ø£ÙŠ Ø·Ù„Ø¨ Ù…Ø¨ÙŠØ¹Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.", "err");
          return;
        }

        const erpOrder = await fetchErpOrder(orderBase);
        if (erpOrder && !vinData.lastData) {
          vinData.lastData = vinData.lastData || {};
          vinData.lastData.customerName = erpOrder.CustomerName || erpOrder.customer_name || "";
          vinData.lastData.Branch       = erpOrder.Branch || "";
          vinData.lastData.TotalInclVAT = erpOrder.TotalInclVAT ?? erpOrder.grand_total;
          vinData.lastOrderNo           = orderBase;
        }

        const { vinStatus, fallbackOrderStatus } =
          await fetchStatusForVin(orderBase, rawVin, itemNoForVin);

        const statusData = vinStatus || fallbackOrderStatus || {};

        renderSingleCar(
          { ...vinData, vin: rawVin },
          statusData
        );

        setStatus("ØªÙ… Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ ÙˆØ§Ù„Ù…Ø±Ø§Ø­Ù„ Ø¨Ù†Ø¬Ø§Ø­.", "ok");
      } catch (e) {
        console.error(e);
        setStatus("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ø§Ù‹.", "err");
      }
    }

    trackBtn.addEventListener("click", handleTrack);
    vinInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        handleTrack();
      }
    });
  </script>
</body>
</html>
