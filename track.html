<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>MZJ â€“ ØªØªØ¨Ø¹ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet" />
  <style>
    :root{
      --brown:#3e2420;
      --beige:#bc8f74;
      --cream:#fff8ef;
      --text:#111827;
      --muted:#6b7280;
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:radial-gradient(circle at top,#fffdf8 0,#fff3e6 40%,#fbe9da 70%,#f5e3d3 100%);
      color:var(--text);
      font-family:"Tajawal",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
      line-height:1.75;
      overflow-x:hidden;
    }
    .topbar{
      background:var(--brown);
      color:#fff;
      padding:10px 20px;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 6px 14px rgba(0,0,0,.22);
    }
    .topbar-title{
      font-weight:800;
      font-size:17px;
      letter-spacing:.5px;
      text-align:center;
    }
    .wrap{
      max-width:900px;
      margin:22px auto 36px;
      padding:0 14px;
    }
    .card{
      background:#fff;
      border-radius:var(--radius);
      box-shadow:0 16px 40px rgba(62,36,32,.13);
      padding:18px 18px 20px;
      margin-bottom:18px;
    }
    .title{
      margin:0 0 12px 0;
      display:flex;
      align-items:center;
      gap:8px;
      color:var(--brown);
      font-size:18px;
    }
    .title .icon{
      width:26px;
      height:26px;
      border-radius:999px;
      background:rgba(188,143,116,.16);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:16px;
    }
    label{
      display:block;
      font-size:13px;
      margin-bottom:4px;
      color:var(--muted);
    }
    input{
      width:100%;
      padding:9px 11px;
      border-radius:10px;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      font-family:inherit;
      font-size:14px;
      outline:none;
    }
    input:focus{
      background:#fff;
      border-color:var(--beige);
      box-shadow:0 0 0 1px rgba(188,143,116,.45);
    }
    .btn{
      border:0;
      border-radius:999px;
      padding:9px 18px;
      font-family:inherit;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:14px;
      background:var(--brown);
      color:#fff;
    }
    .muted{color:var(--muted);font-size:13px;}
    .ok{color:#047857;font-weight:600;}
    .err{color:#b91c1c;font-weight:600;}
    .row{
      display:grid;
      grid-template-columns:2fr 1fr;
      gap:10px;
    }
    @media(max-width:700px){
      .row{grid-template-columns:1fr;}
    }
    .info-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      font-size:14px;
    }
    @media(max-width:650px){
      .info-grid{grid-template-columns:1fr;}
    }
    .info-item{
      padding:8px 10px;
      border-radius:10px;
      background:#fffaf3;
      border:1px solid rgba(188,143,116,.3);
    }
    .info-label{
      font-size:12px;
      color:var(--muted);
      margin-bottom:2px;
    }
    .info-value{
      font-size:14px;
      font-weight:600;
      color:var(--brown);
      direction:rtl;
      text-align:right;
      word-break:break-word;
    }
    .progress-wrap{
      margin-top:8px;
    }
    .progress-label{
      display:flex;
      justify-content:space-between;
      font-size:13px;
      color:var(--muted);
      margin-bottom:4px;
    }
    .progress-bar{
      position:relative;
      width:100%;
      height:10px;
      border-radius:999px;
      background:#f3f4f6;
      overflow:hidden;
    }
    .progress-bar-inner{
      position:absolute;
      inset:0;
      width:0;
      border-radius:999px;
      background:linear-gradient(90deg,#bc8f74,#3e2420);
      transition:width .35s ease-out;
    }
    .stage-list{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .stage-row{
      display:flex;
      align-items:flex-start;
      gap:8px;
      padding:7px 9px;
      border-radius:10px;
      background:#f9fafb;
      border:1px solid #e5e7eb;
      font-size:13px;
    }
    .stage-row.done{
      background:#ecfdf5;
      border-color:#22c55e;
    }
    .stage-status{
      width:18px;
      height:18px;
      border-radius:999px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:11px;
      flex-shrink:0;
      background:#e5e7eb;
      color:#374151;
    }
    .stage-row.done .stage-status{
      background:#22c55e;
      color:#fff;
    }
    .stage-title{
      color:var(--brown);
      margin-bottom:2px;
    }
    .stage-time{
      color:var(--muted);
      font-size:11px;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-title">
      ØªØªØ¨Ø¹ Ø·Ù„Ø¨Ùƒ Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ â€“ Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª
    </div>
  </div>

  <div class="wrap">
    <!-- Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ -->
    <div class="card" id="searchCard">
      <h3 class="title">
        <span class="icon">ğŸ”</span>
        ØªØªØ¨Ø¹ Ø§Ù„Ø·Ù„Ø¨
      </h3>
      <div class="row">
        <div>
          <label>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ (VIN)</label>
          <input id="vinInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù‡Ù†Ø§" />
        </div>
        <div style="display:flex;align-items:flex-end;justify-content:flex-start;">
          <button class="btn" id="searchBtn">Ø¨Ø­Ø«</button>
        </div>
      </div>
      <div id="searchMsg" class="muted" style="margin-top:6px;">
        Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ ÙƒÙ…Ø§ Ù‡Ùˆ Ù…ÙˆØ¶Ø­ ÙÙŠ Ø¹Ù‚Ø¯ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø£Ùˆ Ø§Ø³ØªÙ…Ø§Ø±Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©.
      </div>
    </div>

    <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ -->
    <div class="card" id="orderInfoCard" style="display:none;">
      <h3 class="title">
        <span class="icon">ğŸ“„</span>
        Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨
      </h3>
      <div class="info-grid">
        <div class="info-item">
          <div class="info-label">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</div>
          <div class="info-value" id="orderNoEl">â€”</div>
        </div>
        <div class="info-item">
          <div class="info-label">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
          <div class="info-value" id="customerNameEl">â€”</div>
        </div>
        <div class="info-item">
          <div class="info-label">Ø§Ù„ÙØ±Ø¹</div>
          <div class="info-value" id="branchEl">â€”</div>
        </div>
        <div class="info-item">
          <div class="info-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø·Ù„Ø¨ (Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)</div>
          <div class="info-value" id="orderTotalEl">â€”</div>
        </div>
      </div>
    </div>

    <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø© -->
    <div class="card" id="carInfoCard" style="display:none;">
      <h3 class="title">
        <span class="icon">ğŸš—</span>
        Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø©
      </h3>
      <div class="info-grid">
        <div class="info-item">
          <div class="info-label">Ø§Ø³Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©</div>
          <div class="info-value" id="carNameEl">â€”</div>
        </div>
        <div class="info-item">
          <div class="info-label">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„</div>
          <div class="info-value" id="vinEl">â€”</div>
        </div>
        <div class="info-item">
          <div class="info-label">Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ</div>
          <div class="info-value" id="extColorEl">â€”</div>
        </div>
        <div class="info-item">
          <div class="info-label">Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ</div>
          <div class="info-value" id="intColorEl">â€”</div>
        </div>
        <div class="info-item">
          <div class="info-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</div>
          <div class="info-value" id="subtotalEl">â€”</div>
        </div>
        <div class="info-item">
          <div class="info-label">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ©)</div>
          <div class="info-value" id="vatValueEl">â€”</div>
        </div>
        <div class="info-item">
          <div class="info-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</div>
          <div class="info-value" id="totalInclEl">â€”</div>
        </div>
      </div>
    </div>

    <!-- Ù…Ø±Ø§Ø­Ù„ Ø§Ù„ØªØªØ¨Ø¹ -->
    <div class="card" id="stagesCard" style="display:none;">
      <h3 class="title">
        <span class="icon">ğŸš¦</span>
        Ø­Ø§Ù„Ø© ØªØªØ¨Ø¹ Ø§Ù„Ø·Ù„Ø¨
      </h3>

      <div class="progress-wrap">
        <div class="progress-label">
          <span>Ù†Ø³Ø¨Ø© Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</span>
          <span id="progressPercent">0%</span>
        </div>
        <div class="progress-bar">
          <div class="progress-bar-inner" id="progressBarInner"></div>
        </div>
      </div>

      <div class="muted" id="currentStageLabel" style="margin-top:8px;">â€”</div>

      <div class="stage-list" id="stagesList"></div>
    </div>
  </div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    getFirestore,
    collection,
    query,
    where,
    getDocs,
    doc,
    getDoc
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCorGtT5_Z68jCtLODvqnv0Fb7QW5eR6MQ",
    authDomain: "mzj-tracking.firebaseapp.com",
    projectId: "mzj-tracking",
    storageBucket: "mzj-tracking.firebaseapp.com",
    messagingSenderId: "655452217491",
    appId: "1:655452217491:web:9348d172c47bdd411fad66"
  };

  const TRACK_COLLECTION    = "orders";
  const ERP_VINS_COLLECTION = "erp_vins";
  const ERP_ORDERS_COLLECTION = "erp_orders";

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  const vinInput        = document.getElementById("vinInput");
  const searchBtn       = document.getElementById("searchBtn");
  const searchMsg       = document.getElementById("searchMsg");

  const orderInfoCard   = document.getElementById("orderInfoCard");
  const carInfoCard     = document.getElementById("carInfoCard");
  const stagesCard      = document.getElementById("stagesCard");

  const orderNoEl       = document.getElementById("orderNoEl");
  const customerNameEl  = document.getElementById("customerNameEl");
  const branchEl        = document.getElementById("branchEl");
  const orderTotalEl    = document.getElementById("orderTotalEl");

  const carNameEl       = document.getElementById("carNameEl");
  const vinEl           = document.getElementById("vinEl");
  const extColorEl      = document.getElementById("extColorEl");
  const intColorEl      = document.getElementById("intColorEl");
  const subtotalEl      = document.getElementById("subtotalEl");
  const vatValueEl      = document.getElementById("vatValueEl");
  const totalInclEl     = document.getElementById("totalInclEl");

  const progressBarInner   = document.getElementById("progressBarInner");
  const progressPercentEl  = document.getElementById("progressPercent");
  const currentStageLabel  = document.getElementById("currentStageLabel");
  const stagesList         = document.getElementById("stagesList");

  const STAGES = [
    "1) Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
    "2) Ø¥ÙŠØµØ§Ù„ Ø§Ù„Ø¯ÙØ¹ â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
    "3) Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ù† Ù‚ÙØ¨Ù„ Ù…Ù…Ø«Ù„ÙŠ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø¨Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¬Ø±ÙƒÙŠØ© â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø¹Ø±Ø¶)",
    "4) Ø³Ø¯Ø§Ø¯ Ø±Ø³ÙˆÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
    "5) Ø§Ù„ØªØ£Ù…ÙŠÙ† â€“ Ø´Ø±Ø· Ø§Ù„Ø±Ø¨Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ³ØªÙ… â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
    "6) Ø¥Ø³ØªÙŠÙØ§Ø¡ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
    "7) Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù„ÙˆØ­Ø§Øª Ø£Ùˆ Ù†Ù‚Ù„ Ø§Ù„Ù…Ù„ÙƒÙŠØ© â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø¹Ø±Ø¶)",
    "8) Ø¥Ø³ØªÙŠÙØ§Ø¡ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
    "9) Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ù„Ù„Ø¥Ø³ØªÙ„Ø§Ù… â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø¹Ø±Ø¶)",
    "10) Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­"
  ];

  function resetView() {
    orderInfoCard.style.display = "none";
    carInfoCard.style.display   = "none";
    stagesCard.style.display    = "none";

    orderNoEl.textContent      = "â€”";
    customerNameEl.textContent = "â€”";
    branchEl.textContent       = "â€”";
    orderTotalEl.textContent   = "â€”";

    carNameEl.textContent      = "â€”";
    vinEl.textContent          = "â€”";
    extColorEl.textContent     = "â€”";
    intColorEl.textContent     = "â€”";
    subtotalEl.textContent     = "â€”";
    vatValueEl.textContent     = "â€”";
    totalInclEl.textContent    = "â€”";

    progressBarInner.style.width   = "0%";
    progressPercentEl.textContent  = "0%";
    currentStageLabel.textContent  = "â€”";
    stagesList.innerHTML           = "";
  }

  function parseAmount(value) {
    if (value === null || value === undefined) return null;
    if (typeof value === "number") return value;
    const s = String(value).replace(/[^\d.,\-]/g,"").replace(/,/g,"");
    const n = parseFloat(s);
    return isNaN(n) ? null : n;
  }

  function formatCurrency(num) {
    if (num === null || num === undefined || isNaN(num)) return "â€”";
    return num.toLocaleString("ar-SA",{minimumFractionDigits:2, maximumFractionDigits:2}) + " Ø±.Ø³";
  }

  function fillOrderAndCarInfo(vinData, erpOrderData, statusData, vin) {
    const lastData  = (vinData && vinData.lastData) || {};
    const erpItem   = (erpOrderData && erpOrderData.item) || lastData.item || {};
    const erpTotals = (erpOrderData && erpOrderData.totals) || lastData.totals || {};

    const orderId =
      statusData.orderId ||
      statusData.orderNo ||
      lastData.orderNo ||
      (vinData && vinData.lastOrderNo) ||
      (erpOrderData && (erpOrderData.orderNo || erpOrderData.OrderNo)) ||
      "â€”";

    const customerName =
      statusData.customerName ||
      lastData.customerName ||
      (erpOrderData && (erpOrderData.customerName || erpOrderData.CustomerName)) ||
      "â€”";

    const branch =
      statusData.branch ||
      lastData.branch ||
      (erpOrderData && (erpOrderData.branch || erpOrderData.Branch)) ||
      "â€”";

    const totalOrderRaw =
      statusData.orderTotalInclVat ??
      statusData.orderTotalInclVAT ??
      erpTotals.totalInclVAT ??
      erpTotals.totalInclVat ??
      erpTotals.TotalInclVAT ??
      null;

    const subtotalRaw =
      erpTotals.subtotalExclVAT ??
      erpTotals.SubtotalExclVAT ??
      null;

    const vatRaw =
      erpTotals.taxValue ??
      erpTotals.TaxValue ??
      null;

    const orderTotal = parseAmount(totalOrderRaw);
    const subtotal   = parseAmount(subtotalRaw);
    const vat        = parseAmount(vatRaw);
    const totalIncl  = orderTotal !== null ? orderTotal : parseAmount(
      erpTotals.totalInclVAT ?? erpTotals.totalInclVat ?? erpTotals.TotalInclVAT ?? null
    );

    const carModel =
      statusData.carModel ||
      statusData.carName ||
      erpItem.model ||
      erpItem.ItemModel ||
      "";

    const carCategory =
      erpItem.category || erpItem.ItemCategory || "";

    const exteriorColor =
      statusData.exteriorColor ||
      erpItem.exteriorColor ||
      erpItem.ExteriorColor ||
      lastData.exteriorColor ||
      "";

    const interiorColor =
      statusData.interiorColor ||
      erpItem.interiorColor ||
      erpItem.InteriorColor ||
      lastData.interiorColor ||
      "";

    orderInfoCard.style.display = "";
    carInfoCard.style.display   = "";

    orderNoEl.textContent      = orderId || "â€”";
    customerNameEl.textContent = customerName || "â€”";
    branchEl.textContent       = branch || "â€”";
    orderTotalEl.textContent   = orderTotal !== null ? formatCurrency(orderTotal) : (totalIncl !== null ? formatCurrency(totalIncl) : "â€”");

    const carFullName = [carCategory, carModel].filter(Boolean).join(" â€“ ");
    carNameEl.textContent   = carFullName || "â€”";
    vinEl.textContent       = vin || "â€”";
    extColorEl.textContent  = exteriorColor || "â€”";
    intColorEl.textContent  = interiorColor || "â€”";
    subtotalEl.textContent  = subtotal !== null ? formatCurrency(subtotal) : "â€”";
    vatValueEl.textContent  = vat      !== null ? formatCurrency(vat)      : "â€”";
    totalInclEl.textContent = totalIncl !== null ? formatCurrency(totalIncl) : (orderTotal !== null ? formatCurrency(orderTotal) : "â€”");
  }

  function buildStagesUI(statusData){
    const stagesObj   = statusData.stages || {};
    let current       = statusData.currentStage || 0;

    Object.keys(stagesObj).forEach(key => {
      const m = key.match(/^s(\d+)$/);
      if (!m) return;
      const n = parseInt(m[1],10);
      if (!isNaN(n) && n > current) current = n;
    });

    const totalStages = STAGES.length;
    const pct = totalStages > 0 ? Math.round((current / totalStages) * 100) : 0;

    progressBarInner.style.width  = pct + "%";
    progressPercentEl.textContent = pct + "%";

    if (current > 0 && current <= totalStages) {
      currentStageLabel.textContent = "Ø¢Ø®Ø± Ù…Ø±Ø­Ù„Ø© ØªÙ… ØªÙ†ÙÙŠØ°Ù‡Ø§: " + STAGES[current-1];
    } else {
      currentStageLabel.textContent = "Ù„Ù… ÙŠØ¨Ø¯Ø£ ØªÙ†ÙÙŠØ° Ø£ÙŠ Ù…Ø±Ø­Ù„Ø© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.";
    }

    stagesList.innerHTML = "";
    STAGES.forEach((label, idx) => {
      const num = idx + 1;
      const key = "s" + num;
      const ts  = stagesObj[key];

      let isDone = false;
      if (ts) {
        isDone = true;
      } else if (!stagesObj[key] && current >= num) {
        isDone = true;
      }

      let tsStr = "";
      if (ts) {
        const d = ts.toDate ? ts.toDate() : new Date(ts);
        tsStr = d.toLocaleString("ar-SA");
      }

      const row = document.createElement("div");
      row.className = "stage-row" + (isDone ? " done" : "");
      row.innerHTML = `
        <div class="stage-status">${isDone ? "âœ“" : "â€¢"}</div>
        <div>
          <div class="stage-title">${label}</div>
          <div class="stage-time">${tsStr ? ("ØªÙ…Øª ÙÙŠ: " + tsStr) : "Ù„Ù… ØªÙÙ†ÙÙ‘Ø° Ø¨Ø¹Ø¯"}</div>
        </div>
      `;
      stagesList.appendChild(row);
    });

    stagesCard.style.display = "";
  }

  async function handleSearch(){
    resetView();
    searchMsg.classList.remove("ok","err");
    searchMsg.textContent = "";

    const vinRaw = (vinInput.value || "").trim();
    if (!vinRaw) {
      searchMsg.classList.add("err");
      searchMsg.textContent = "Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø£ÙˆÙ„Ø§Ù‹.";
      return;
    }

    const vin = vinRaw;
    searchMsg.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø±ØªØ¨Ø· Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù‡ÙŠÙƒÙ„...";

    try{
      let vinData = null;
      let statusData = {};
      let erpOrderData = null;
      let orderId = null;
      let itemNo  = null;

      // 1) Ù†Ø­Ø§ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ erp_vins/{VIN}
      try{
        const vinRef = doc(db, ERP_VINS_COLLECTION, vin);
        const vinSnap = await getDoc(vinRef);
        if (vinSnap.exists()) {
          vinData = vinSnap.data() || {};
          const lastData = vinData.lastData || {};
          orderId = vinData.lastOrderNo || lastData.orderNo || vinData.orderNo || null;
          itemNo  = vinData.lastItemNo || lastData.itemNo || (lastData.item && lastData.item.no) || null;
        }
      }catch(e){
        console.warn("Error reading erp_vins:", e);
      }

      // 2) Ù„Ùˆ ÙÙŠÙ‡ Ø±Ù‚Ù… Ø·Ù„Ø¨ Ù†Ø­Ø§ÙˆÙ„ Ù†Ø¬ÙŠØ¨ Ø¯ÙˆÙƒ Ø§Ù„ØªØªØ¨Ø¹ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ orders/{OrderNo}_VIN_{VIN}
      let trackDocId = null;
      if (orderId) {
        const baseId = orderId;
        const candidateIds = [
          baseId + "_VIN_" + vin,
          itemNo ? (baseId + "_" + itemNo) : null
        ].filter(Boolean);

        for (const id of candidateIds) {
          try{
            const ref = doc(db, TRACK_COLLECTION, id);
            const snap = await getDoc(ref);
            if (snap.exists()) {
              trackDocId = id;
              statusData = snap.data() || {};
              break;
            }
          }catch(e){
            console.warn("Error reading tracking doc", id, e);
          }
        }

        if (trackDocId) {
          try{
            const statusRef = doc(db, TRACK_COLLECTION, trackDocId, "public", "status");
            const statusSnap = await getDoc(statusRef);
            if (statusSnap.exists()) {
              statusData = { ...statusData, ...statusSnap.data() };
            }
          }catch(e){
            console.warn("Error reading public/status:", e);
          }
        }

        // 3) Ù†Ø­Ø§ÙˆÙ„ ÙƒÙ…Ø§Ù† Ù†Ø¬ÙŠØ¨ erp_orders/{OrderNo}_{ItemNo} Ù„Ùˆ Ù…ØªØ§Ø­
        if (itemNo) {
          try{
            const erpOrderRef = doc(db, ERP_ORDERS_COLLECTION, `${orderId}_${itemNo}`);
            const erpOrderSnap = await getDoc(erpOrderRef);
            if (erpOrderSnap.exists()) {
              erpOrderData = erpOrderSnap.data() || null;
            }
          }catch(e){
            console.warn("Error reading erp_orders:", e);
          }
        }
      }

      // 4) Ù„Ùˆ Ù…Ø§ Ø¹Ø±ÙÙ†Ø§Ø´ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† erp_vins Ù†Ø­Ø§ÙˆÙ„ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ orders Ø¨Ø§Ù„Ù€ VIN
      if (!orderId || (!trackDocId && Object.keys(statusData).length === 0)) {
        try{
          const colRef = collection(db, TRACK_COLLECTION);
          const q = query(colRef, where("vin","==",vin));
          const snap = await getDocs(q);
          if (!snap.empty) {
            const mainDoc = snap.docs[0];
            trackDocId = mainDoc.id;
            const data = mainDoc.data() || {};
            statusData = { ...data, ...statusData };
            orderId = orderId ||
              data.orderId ||
              data.orderNo ||
              (typeof trackDocId === "string" ? trackDocId.split("_")[0] : null);

            try{
              const statusRef = doc(db, TRACK_COLLECTION, trackDocId, "public", "status");
              const statusSnap = await getDoc(statusRef);
              if (statusSnap.exists()) {
                statusData = { ...statusData, ...statusSnap.data() };
              }
            }catch(e){
              console.warn("Error reading fallback public/status:", e);
            }
          }
        }catch(e){
          console.warn("Error querying orders by VIN:", e);
        }
      }

      if (!vinData && (!orderId && Object.keys(statusData).length === 0)) {
        searchMsg.classList.add("err");
        searchMsg.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨ Ù…Ø±ØªØ¨Ø· Ø¨Ù‡Ø°Ø§ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø±Ù‚Ù… Ø£Ùˆ ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡.";
        return;
      }

      fillOrderAndCarInfo(vinData, erpOrderData, statusData, vin);
      buildStagesUI(statusData);

      searchMsg.classList.add("ok");
      searchMsg.textContent = "ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„Ù‡.";
    }catch(e){
      console.error(e);
      searchMsg.classList.add("err");
      searchMsg.textContent = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ø§Ù‹.";
    }
  }

  searchBtn.addEventListener("click", handleSearch);
  vinInput.addEventListener("keydown",(e)=>{
    if (e.key === "Enter") handleSearch();
  });
  </script>
</body>
</html>
