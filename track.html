

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ØªØªØ¨Ø¹ Ø·Ù„Ø¨Ùƒ - Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: "Tajawal", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f6f4f0;
      color: #3e2420;
    }
    .page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 24px 12px 40px;
    }
    .card {
      width: 100%;
      max-width: 720px;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      padding: 20px 18px 24px;
      box-sizing: border-box;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 18px;
    }
    .brand-mark {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: linear-gradient(135deg, #3e2420, #bc8f74);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 700;
      font-size: 20px;
    }
    .brand-text-title {
      font-weight: 700;
      font-size: 18px;
      color: #3e2420;
    }
    .brand-text-sub {
      font-size: 13px;
      color: #7b6a63;
    }

    .search-section {
      margin-bottom: 18px;
      background: #fff8ef;
      border-radius: 12px;
      padding: 12px 14px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    .search-section label {
      font-size: 13px;
      color: #5b4035;
      font-weight: 600;
    }
    .search-input-wrap {
      flex: 1 1 200px;
      display: flex;
      gap: 8px;
    }
    .search-input-wrap input {
      flex: 1;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #d4c4b8;
      font-size: 14px;
      outline: none;
    }
    .search-input-wrap input:focus {
      border-color: #bc8f74;
      box-shadow: 0 0 0 2px rgba(188,143,116,0.25);
    }
    .btn {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.2s;
    }
    .btn-primary {
      background: linear-gradient(135deg, #3e2420, #bc8f74);
      color: #fff;
      box-shadow: 0 4px 14px rgba(62,36,32,0.35);
    }
    .btn-primary:active {
      transform: translateY(1px);
      box-shadow: 0 2px 8px rgba(62,36,32,0.35);
    }

    .status-bar {
      margin-top: 4px;
      font-size: 13px;
      color: #7b6a63;
      min-height: 18px;
    }

    .section-title {
      font-size: 15px;
      font-weight: 700;
      margin: 14px 0 8px;
      display: flex;
      align-items: center;
      gap: 6px;
      color: #3e2420;
    }
    .section-title span.icon-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #bc8f74;
      display: inline-block;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 8px 12px;
      margin-bottom: 6px;
    }
    .info-item {
      padding: 8px 10px;
      border-radius: 10px;
      background: #faf3ea;
      border: 1px solid #e4d6c8;
    }
    .info-label {
      font-size: 11px;
      color: #7b6a63;
      margin-bottom: 3px;
    }
    .info-value {
      font-size: 13px;
      font-weight: 600;
      color: #3e2420;
      word-break: break-word;
    }

    .car-box {
      margin-top: 8px;
      border-radius: 12px;
      background: linear-gradient(135deg, #3e2420 0%, #5b4035 45%, #bc8f74 100%);
      padding: 12px 14px;
      color: #fff;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    .car-main {
      font-size: 14px;
      font-weight: 700;
    }
    .car-meta {
      font-size: 12px;
      opacity: 0.9;
    }

    .timeline {
      margin-top: 10px;
      padding-top: 8px;
      border-top: 1px solid #e5d6c7;
    }
    .timeline-title {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 6px;
    }
    .timeline-steps {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .timeline-step {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 8px 0;
    }
    .timeline-step:not(:last-child) {
      border-bottom: 1px dashed #e0d0c2;
    }
    .step-icon {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 2px solid #bc8f74;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      flex-shrink: 0;
    }
    .step-icon.done {
      background: #bc8f74;
      color: #fff;
    }
    .step-body {
      flex: 1;
    }
    .step-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 2px;
    }
    .step-sub {
      font-size: 11px;
      color: #7b6a63;
    }

    .empty-state {
      padding: 14px 10px 6px;
      font-size: 13px;
      color: #7b6a63;
    }

    @media (max-width: 480px) {
      .card {
        padding: 16px 14px 20px;
      }
      .brand-text-title {
        font-size: 16px;
      }
      .search-section {
        padding: 10px 10px;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="card">
      <!-- Brand header -->
      <div class="brand">
        <div class="brand-mark">â˜…</div>
        <div>
          <div class="brand-text-title">ØªØªØ¨Ø¹ Ø·Ù„Ø¨Ùƒ</div>
          <div class="brand-text-sub">Ù…Ø¹ Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øªâ€¦ Ø£Ù†Øª Ù†Ø¬Ù… Ø§Ù„Ø·Ø±ÙŠÙ‚ âœ¨</div>
        </div>
      </div>

      <!-- Search -->
      <div class="search-section">
        <div>
          <label for="vinInput">Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ (Ø§Ù„Ø´Ø§ØµÙŠ):</label>
        </div>
        <div class="search-input-wrap">
          <input id="vinInput" type="text" placeholder="Ù…Ø«Ø§Ù„: KMHXXXXXXXXXXXXX" />
          <button id="searchBtn" class="btn btn-primary">
            ğŸ” ØªØªØ¨Ø¹
          </button>
        </div>
        <div class="status-bar" id="statusBar"></div>
      </div>

      <!-- Result -->
      <div id="resultContainer">
        <div class="empty-state">
          Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ ÙˆØ§Ø¶ØºØ· "ØªØªØ¨Ø¹" Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø·Ù„Ø¨Ùƒ ÙˆØ­Ø§Ù„Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©.
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK v9 (Modules) -->
  <script type="module">
    // TODO: Ø¶Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ù‡Ù†Ø§:
    // ÙŠÙ…ÙƒÙ†Ùƒ Ù†Ø³Ø®Ù‡Ø§ Ù…Ù† ØµÙØ­Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙˆÙŠØ¨ ÙÙŠ Firebase Console
    // Ù…Ø«Ø§Ù„:
    /*
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_DOMAIN.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "XXXX",
      appId: "XXXX"
    };
    */

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore.js";

    // ========= 1) Ø¥Ø¹Ø¯Ø§Ø¯ Firebase =========
    const firebaseConfig = {
      apiKey: "AIzaSyCorGtT5_Z68jCtLODvqnv0Fb7QW5eR6MQ",
      authDomain: "mzj-tracking.firebaseapp.com",
      projectId: "mzj-tracking",
      storageBucket: "mzj-tracking.firebasestorage.app",
      messagingSenderId: "655452217491",
      appId: "1:655452217491:web:9348d172c47bdd411fad66"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // ========= 2) Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙØ­Ø© =========
    const vinInput      = document.getElementById("vinInput");
    const searchBtn     = document.getElementById("searchBtn");
    const statusBar     = document.getElementById("statusBar");
    const resultContainer = document.getElementById("resultContainer");

    function setStatus(msg, isError = false) {
      statusBar.textContent = msg || "";
      statusBar.style.color = isError ? "#b00020" : "#7b6a63";
    }

    function renderEmptyState() {
      resultContainer.innerHTML = `
        <div class="empty-state">
          Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ ÙˆØ§Ø¶ØºØ· "ØªØªØ¨Ø¹" Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø·Ù„Ø¨Ùƒ ÙˆØ­Ø§Ù„Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©.
        </div>
      `;
    }


    const STAGES = [
      {
        title: "1) Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨",
        sub: "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨Ùƒ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­."
      },
      {
        title: "2) Ø£Ù…Ø± Ø§Ù„Ø¯ÙØ¹ (ØªØ­ÙˆÙŠÙ„/Ø´Ø¨ÙƒØ©/ÙƒØ§Ø´)",
        sub: "ÙŠØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ù…Ø¨Ù„Øº Ø§Ù„Ø¯ÙØ¹Ø© Ø£Ùˆ ØªØ±ØªÙŠØ¨ Ø®ÙŠØ§Ø± Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨."
      },
      {
        title: "3) ØªÙˆØ§ØµÙ„ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ + Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠØ©",
        sub: "Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ØªØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù„Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠØ©."
      },
      {
        title: "4) Ø³Ø¯Ø§Ø¯ Ø±Ø³ÙˆÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„",
        sub: "ÙŠØªÙ… Ø³Ø¯Ø§Ø¯ Ø±Ø³ÙˆÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø±Ø³Ù…ÙŠØ© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ø±ÙƒØ¨Ø©."
      },
      {
        title: "5) Ø§Ù„ØªØ£Ù…ÙŠÙ† (Ø´Ø±Ø· Ø§Ù„Ø±Ø¨Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ³ØªÙ…)",
        sub: "Ø¥ØµØ¯Ø§Ø± ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„ØªØ£Ù…ÙŠÙ† ÙˆØ±Ø¨Ø·Ù‡Ø§ Ø¨Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±ÙˆØ±."
      },
      {
        title: "6) Ø§Ø³ØªÙŠÙØ§Ø¡ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ ÙˆØ§Ù„Ù…Ø¨Ø§Ù„Øº",
        sub: "Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª ÙˆØ§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„ØªØ³Ø¬ÙŠÙ„."
      },
      {
        title: "7) ØªØ¬ÙŠÙŠØ± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠØ©",
        sub: "ØªØ­ÙˆÙŠÙ„ ÙˆØªØ¬ÙŠÙŠØ± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠØ© Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯."
      },
      {
        title: "8) Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù„ÙˆØ­Ø§Øª Ø£Ùˆ Ù†Ù‚Ù„ Ø§Ù„Ù…Ù„ÙƒÙŠØ©",
        sub: "Ø¥ØµØ¯Ø§Ø± Ù„ÙˆØ­Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ø£Ùˆ Ø¥ØªÙ…Ø§Ù… Ø¥Ø¬Ø±Ø§Ø¡ Ù†Ù‚Ù„ Ø§Ù„Ù…Ù„ÙƒÙŠØ©."
      },
      {
        title: "9) Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ù„Ù„Ø§Ø³ØªÙ„Ø§Ù…/Ø·Ù„Ø¨ Ø§Ù„Ø´Ø­Ù†",
        sub: "Ø³ÙŠØ§Ø±ØªÙƒ Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø§Ø³ØªÙ„Ø§Ù… Ù…Ù† Ø§Ù„Ù…Ø¹Ø±Ø¶ Ø£Ùˆ Ù„Ø·Ù„Ø¨ Ø§Ù„Ø´Ø­Ù† Ù„Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©."
      },
      {
        title: "10) Ø¥ØªÙ…Ø§Ù… Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­",
        sub: "ØªÙ… ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø³ÙŠØ§Ø±Ø© ÙˆØ¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­. Ù†ØªÙ…Ù†Ù‰ Ù„Ùƒ Ø±Ø­Ù„Ø© Ø³Ø¹ÙŠØ¯Ø©."
      }
    ];

    function renderResult(vinDocData, statusData) {
      // vinDocData = Ù…Ø­ØªÙˆÙ‰ Ù…Ø³ØªÙ†Ø¯ erp_vins/{vin}
      const lastOrderNo = vinDocData.lastOrderNo || "";
      const lastItemNo  = vinDocData.lastItemNo || "";
      const lastUpdate  = vinDocData.lastUpdate || "";
      const payload     = vinDocData.lastData || {};

      const customerName = payload.customerName || "";
      const customerVat  = payload.customerVat || "";
      const branch       = payload.branch || "";
      const orderDate    = payload.orderDate || "";
      const deliveryDate = payload.deliveryDate || "";
      const salesPerson  = payload.salesPerson || "";

      const item = payload.item || {};
      const carType     = item.type || "";
      const carCategory = item.category || "";
      const carModel    = item.model || "";
      const extColor    = item.exteriorColor || item.extColor || "";
      const intColor    = item.interiorColor || item.intColor || "";
      const dealer      = item.dealer || "";
      const vin         = item.vin || "";

      const totals = payload.totals || {};
      const totalInclVAT  = totals.totalInclVAT  || totals.TotalInclVAT || "";
      const subtotalExcl  = totals.subtotalExclVAT || totals.SubtotalExclVAT || "";
      const taxName       = totals.taxName || totals.TaxName || "";
      const taxValue      = totals.taxValue || totals.TaxValue || "";

      // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØªØ¨Ø¹
      const track = statusData || {};
      const currentStage = track.currentStage || 0;
      const stages = track.stages || {};
      const updatedAt = track.updatedAt ? new Date(track.updatedAt.toDate ? track.updatedAt.toDate() : track.updatedAt).toLocaleString("ar-SA") : "";

      const currentStageLabel =
        currentStage > 0 && currentStage <= STAGES.length
          ? STAGES[currentStage - 1].title
          : (currentStage === 0 ? "Ù„Ù… ÙŠØ¨Ø¯Ø£ Ø¨Ø¹Ø¯" : "Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ø¯ÙŠØ«");

      resultContainer.innerHTML = `
        <div>
          <div class="section-title">
            <span class="icon-dot"></span>
            <span>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨</span>
          </div>
          <div class="info-grid">
            <div class="info-item">
              <div class="info-label">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</div>
              <div class="info-value">${lastOrderNo || "-"}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
              <div class="info-value">${customerName || "-"}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ</div>
              <div class="info-value">${customerVat || "-"}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Ø§Ù„ÙØ±Ø¹</div>
              <div class="info-value">${branch || "-"}</div>
            </div>
            <div class="info-item">
              <div class="info-label">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</div>
              <div class="info-value">${deliveryDate || "-"}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</div>
              <div class="info-value">${salesPerson || "-"}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div>
              <div class="info-value">${currentStageLabel}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« Ù„Ù„Ø­Ø§Ù„Ø©</div>
              <div class="info-value">${updatedAt || "-"}</div>
            </div>
          </div>

          <div class="section-title">
            <span class="icon-dot"></span>
            <span>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø©</span>
          </div>
          <div class="car-box">
            <div class="car-main">
              ${carType || "-"} ${carCategory || ""} ${carModel || ""}
            </div>
            <div class="car-meta">
              Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„: ${vin || "-"}
            </div>
            <div class="car-meta">
              Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ: ${extColor || "-"} â€“ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ: ${intColor || "-"}
            </div>
            <div class="car-meta">
              Ø§Ù„ÙˆÙƒÙŠÙ„: ${dealer || "-"}
            </div>
            <div class="car-meta">
              Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©: ${subtotalExcl || "-"}
            </div>
            <div class="car-meta">
              Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©${taxName ? " (" + taxName + ")" : ""}: ${taxValue || "-"}
            </div>
            <div class="car-meta">
              Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©: ${totalInclVAT || "-"}
            </div>
          </div>

          <div class="section-title">
            <span class="icon-dot"></span>
            <span>Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</span>
          </div>
          <div class="timeline">
            <div class="timeline-title">Ø®Ø·ÙˆØ§Øª Ø·Ù„Ø¨Ùƒ Ù…Ù† Ø£ÙˆÙ„ Ø­Ø¬Ø² Ø­ØªÙ‰ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©</div>
            <ul class="timeline-steps">
              ${STAGES.map((step, idx) => {
                const stepIndex = idx + 1;
                const doneTs = stages["s" + stepIndex];
                const isDone = currentStage >= stepIndex || !!doneTs;
                const tsLabel = doneTs
                  ? new Date(doneTs.toDate ? doneTs.toDate() : doneTs).toLocaleString("ar-SA")
                  : "";
                return `
                  <li class="timeline-step">
                    <div class="step-icon ${isDone ? "done" : ""}">
                      ${isDone ? "âœ“" : stepIndex}
                    </div>
                    <div class="step-body">
                      <div class="step-title">${step.title}</div>
                      <div class="step-sub">
                        ${step.sub}
                        ${tsLabel ? " â€” <span>ØªÙ… ÙÙŠ: " + tsLabel + "</span>" : ""}
                      </div>
                    </div>
                  </li>
                `;
              }).join("")}
            </ul>
          </div>
        </div>
      `;
    }
    // ========= 3) Ø­Ø¯Ø« Ø§Ù„Ø¨Ø­Ø« =========

    async function handleSearch() {
      const rawVin = (vinInput.value || "").trim();
      if (!rawVin) {
        setStatus("Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø£ÙˆÙ„Ø§Ù‹.", true);
        renderEmptyState();
        return;
      }

      setStatus("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø±ØªØ¨Ø· Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…â€¦");

      try {
        const vinDocRef = doc(db, "erp_vins", rawVin);
        const vinSnap   = await getDoc(vinDocRef);

        if (!vinSnap.exists()) {
          setStatus("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø·Ù„Ø¨ Ù…Ø±ØªØ¨Ø· Ø¨Ù‡Ø°Ø§ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø±Ù‚Ù… ÙˆØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.", true);
          renderEmptyState();
          return;
        }

        const vinData = vinSnap.data();

        // Ù‚Ø±Ø§Ø¡Ø© Ø­Ø§Ù„Ø© Ø§Ù„ØªØªØ¨Ø¹ Ù…Ù† orders/{orderId}/public/status
        let statusData = null;
        const orderId = vinData.lastOrderNo || vinData.orderId || "";
        if (orderId) {
          try {
            const statusRef = doc(db, "orders", orderId, "public", "status");
            const statusSnap = await getDoc(statusRef);
            if (statusSnap.exists()) {
              statusData = statusSnap.data();
            }
          } catch (errStatus) {
            console.error("Error fetching status:", errStatus);
          }
        }

        setStatus("ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨. ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¢Ù†.");
        renderResult(vinData, statusData);
      } catch (err) {
        console.error("Error fetching VIN:", err);
        setStatus("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ø§Ù‹.", true);
        renderEmptyState();
      }
    }
    searchBtn.addEventListener("click", handleSearch);
    vinInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        handleSearch();
      }
    });
  </script>
</body>
</html>
