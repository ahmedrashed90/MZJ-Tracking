<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø¥Ø¯Ø§Ø±Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª â€” Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet" />
  <style>
    :root{
      --brown:#3e2420;
      --beige:#bc8f74;
      --cream:#fff8ef;
      --text:#111827;
      --muted:#6b7280;
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Tajawal",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#fffdf8 0,#fff3e6 40%,#fbe9da 70%,#f5e3d3 100%);
      color:var(--text);
      line-height:1.7;
    }
    .layout{
      display:flex;
      min-height:100vh;
    }
    .sidebar{
      width:260px;
      background:var(--brown);
      color:#fff;
      padding:18px 14px 18px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    .logo{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    .logo-mark{
      width:38px;
      height:38px;
      border-radius:14px;
      background:linear-gradient(135deg,#fbbf77,#bc8f74);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      font-size:20px;
      box-shadow:0 4px 14px rgba(0,0,0,.35);
    }
    .logo-text{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .logo-text-main{font-weight:700;font-size:14px;}
    .logo-text-sub{font-size:11px;opacity:.9;}

    .side-title{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:rgba(255,255,255,.7);
      margin-bottom:4px;
    }
    .side-card{
      border-radius:var(--radius);
      background:rgba(0,0,0,.16);
      padding:10px 11px;
      font-size:12px;
    }
    .side-card strong{display:block;font-size:13px;margin-bottom:2px;}
    .side-card span{font-size:12px;opacity:.9;}

    .stats{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:6px;
      margin-top:6px;
    }
    .stat-box{
      background:rgba(0,0,0,.25);
      border-radius:12px;
      padding:6px 7px;
      font-size:11px;
    }
    .stat-label{opacity:.8;font-size:11px;}
    .stat-value{font-size:13px;font-weight:700;}

    .main{
      flex:1;
      padding:18px 18px 28px;
    }
    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:12px;
    }
    .topbar-title{
      font-size:18px;
      font-weight:800;
      color:var(--brown);
    }
    .topbar-sub{
      font-size:13px;
      color:var(--muted);
    }
    .topbar-actions{
      display:flex;
      gap:6px;
      align-items:center;
    }
    .badge{
      border-radius:999px;
      padding:4px 9px;
      font-size:11px;
      background:#fff;
      border:1px solid rgba(188,143,116,.45);
      color:var(--brown);
    }

    .tabs{
      display:none;
      margin:-8px 0 10px;
      gap:6px;
    }

    .card{
      background:#fff;
      border-radius:var(--radius);
      box-shadow:0 14px 40px rgba(62,36,32,.12);
      padding:14px 14px 16px;
      margin-bottom:14px;
    }
    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-bottom:10px;
    }
    .card-title{
      display:flex;
      align-items:center;
      gap:8px;
      color:var(--brown);
    }
    .card-title span.icon{
      width:26px;
      height:26px;
      border-radius:999px;
      background:rgba(188,143,116,.16);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:16px;
    }
    .card-title strong{font-size:15px;}
    .card-sub{
      font-size:12px;
      color:var(--muted);
    }
    .pill{
      border-radius:999px;
      background:#fff8ef;
      padding:4px 9px;
      font-size:11px;
      color:var(--brown);
      border:1px solid rgba(188,143,116,.45);
    }

    .filters{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-bottom:10px;
      font-size:13px;
    }
    .filters label{
      font-size:12px;
      color:var(--muted);
      margin-bottom:2px;
    }
    .filters select,.filters input{
      min-width:150px;
      padding:6px 8px;
      border-radius:10px;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      font-family:inherit;
      font-size:13px;
      outline:none;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    th,td{
      padding:8px 6px;
      border-bottom:1px solid #f1f2f4;
      text-align:right;
    }
    th{
      background:#fff8ef;
      color:var(--brown);
      font-weight:600;
      font-size:12px;
      white-space:nowrap;
    }
    tbody tr:hover{
      background:#fffaf3;
    }
    .tag{
      border-radius:999px;
      padding:3px 8px;
      font-size:11px;
      background:#f3f4f6;
      color:#374151;
    }
    .tag-success{
      background:#dcfce7;
      color:#166534;
    }
    .tag-warning{
      background:#fef9c3;
      color:#854d0e;
    }
    .tag-muted{
      background:#e5e7eb;
      color:#4b5563;
    }

    .btn{
      border-radius:999px;
      border:0;
      padding:8px 13px;
      font-size:13px;
      font-family:inherit;
      cursor:pointer;
      background:var(--brown);
      color:#fff;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .btn-outline{
      border-radius:999px;
      border:1px solid var(--brown);
      padding:8px 14px;
      font-family:inherit;
      cursor:pointer;
      background:transparent;
      color:var(--brown);
      font-size:13px;
    }
    .btn:disabled,.btn-outline:disabled{
      opacity:.5;
      cursor:not-allowed;
    }
    .stage .stage-btn{
      transition:background-color .2s ease, color .2s ease, border-color .2s ease;
    }
    .stage.done .stage-btn{
      background:#22c55e;
      border-color:#16a34a;
      color:#fff;
      opacity:1;
    }
    .muted{color:var(--muted);font-size:13px;}
    .hint{color:var(--muted);font-size:12px;}

    .grid-2{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:10px;
    }
    @media(max-width:900px){
      .layout{flex-direction:column;}
      .sidebar{width:100%;flex-direction:row;overflow-x:auto;}
      .main{padding:14px;}
      .grid-2{grid-template-columns:1fr;}
    }

    .stage{
      background:#fffaf3;
      border-radius:12px;
      padding:10px 12px;
      border:1px dashed rgba(188,143,116,.55);
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .stage.done{
      background:#ecfdf5;
      border-style:solid;
      border-color:#22c55e;
    }
    .stage-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .stage strong{color:var(--brown);font-size:13px;}
    .stage small{font-size:11px;color:var(--muted);}
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div>
        <div class="logo">
          <div class="logo-mark">â˜…</div>
          <div class="logo-text">
            <div class="logo-text-main">Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ</div>
            <div class="logo-text-sub">Ù…Ø±ÙƒØ² Ø¥Ø¯Ø§Ø±Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</div>
          </div>
        </div>
        <div class="side-card">
          <strong>Ù„ÙˆØ­Ø© Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</strong>
          <span>Ø¥Ø¯Ø§Ø±Ø© Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨ÙŠØ¹ØŒ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨ÙƒÙ„ Ø·Ù„Ø¨ØŒ ÙˆÙ…Ø±Ø§Ø­Ù„ Ø§Ù„ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„.</span>
        </div>
      </div>

      <div>
        <div class="side-title">Ù…Ù„Ø®Øµ Ø³Ø±ÙŠØ¹</div>
        <div class="stats">
          <div class="stat-box">
            <div class="stat-label">Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
            <div class="stat-value" id="statToday">â€”</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Ø·Ù„Ø¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</div>
            <div class="stat-value" id="statInProgress">â€”</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Ø·Ù„Ø¨Ø§Øª Ù…ÙƒØªÙ…Ù„Ø©</div>
            <div class="stat-value" id="statCompleted">â€”</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
            <div class="stat-value" id="statTotal">â€”</div>
          </div>
        </div>
      </div>
    </aside>

    <main class="main">
      <header class="topbar">
        <div>
          <div class="topbar-title">Ø¥Ø¯Ø§Ø±Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</div>
          <div class="topbar-sub">Ø§Ø®ØªÙØ± Ø§Ù„Ø·Ù„Ø¨ØŒ Ø«Ù… Ø§Ø®ØªÙØ± Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ØŒ Ø«Ù… Ø­Ø¯Ù‘Ø« Ù…Ø±Ø§Ø­Ù„ Ø§Ù„ØªØªØ¨Ø¹ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù‡ÙŠÙƒÙ„ ÙÙ‚Ø·.</div>
        </div>
        <div class="topbar-actions">
          <span class="badge">Ù…ØªØµÙ„ Ø¨Ù€ Firebase â€” Ù…Ø´Ø±ÙˆØ¹ mzj-tracking</span>
        </div>
      </header>

      <!-- Orders Table -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <span class="icon">ğŸ§¾</span>
            <strong>Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</strong>
          </div>
          <div class="card-sub">
            Ø§Ø®ØªØ± Ø·Ù„Ø¨ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ØŒ Ø«Ù… Ø§Ø®ØªØ± Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ù…Ø±ØªØ¨Ø·ØŒ Ø¨Ø¹Ø¯Ù‡Ø§ Ø§Ù†ØªÙ‚Ù„ Ø¥Ù„Ù‰ Ù…Ø±Ø§Ø­Ù„ Ø§Ù„ØªØªØ¨Ø¹.
          </div>
        </div>

        <div class="filters">
          <div>
            <label>Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</label>
            <input id="searchOrderInput" type="text" placeholder="Ù…Ø«Ø§Ù„: SO-0001" />
          </div>
          <div>
            <label>Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
            <input id="searchCustomerInput" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" />
          </div>
          <div>
            <label>ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ÙØ±Ø¹</label>
            <select id="filterBranch">
              <option value="">ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹</option>
              <option value="Ø§Ù„Ø±ÙŠØ§Ø¶ 1">Ø§Ù„Ø±ÙŠØ§Ø¶ 1</option>
              <option value="Ø§Ù„Ø±ÙŠØ§Ø¶ 2">Ø§Ù„Ø±ÙŠØ§Ø¶ 2</option>
              <option value="Ø§Ù„ÙØ±ÙˆØ¹ Ø§Ù„Ø£Ø®Ø±Ù‰">Ø§Ù„ÙØ±ÙˆØ¹ Ø§Ù„Ø£Ø®Ø±Ù‰</option>
            </select>
          </div>
        </div>

        <div style="overflow-x:auto;">
          <table>
            <thead>
              <tr>
                <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
                <th>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                <th>Ø§Ù„ÙØ±Ø¹</th>
                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨</th>
                <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨ (Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th>Ø¹Ø±Ø¶</th>
              </tr>
            </thead>
            <tbody id="ordersListBody"></tbody>
          </table>
        </div>
        <div class="muted" id="ordersMsg" style="margin-top:6px;">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</div>
      </div>

      <!-- Linked VINs -->
      <div class="card" id="vinsCard" style="display:none;">
        <div class="card-header">
          <div class="card-title">
            <span class="icon">ğŸš—</span>
            <strong>Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø®ØªØ§Ø±</strong>
          </div>
          <div class="card-sub">
            Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ Ù…Ø±Ø§Ø­Ù„ ØªØªØ¨Ø¹ Ø§Ù„Ø·Ù„Ø¨ Ø³ÙŠÙƒÙˆÙ† Ù„Ù‡Ø°Ø§ <strong>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ ÙÙ‚Ø·</strong>.
          </div>
        </div>

        <div class="filters">
          <div>
            <label>Ø§Ø®ØªØ± Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ Ù„Ù„Ø¹Ù…Ù„ Ø¹Ù„ÙŠÙ‡</label>
            <select id="vinSelect"></select>
          </div>
          <div>
            <label>Ø§Ø³Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©</label>
            <div id="vinCarName" class="pill">â€”</div>
          </div>
          <div>
            <label>Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ</label>
            <div id="vinExtColor" class="pill">â€”</div>
          </div>
          <div>
            <label>Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ</label>
            <div id="vinIntColor" class="pill">â€”</div>
          </div>
        </div>

        <div class="muted" id="vinMsg">Ø§Ø®ØªØ± Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„Ù‡.</div>
      </div>

      <!-- Stages -->
      <div class="card" id="stagesCard" style="display:none;">
        <h3 class="title"><span class="icon">ğŸš¦</span>Ù…Ø±Ø§Ø­Ù„ ØªØªØ¨Ø¹ Ø§Ù„Ø·Ù„Ø¨</h3>
        <div class="grid-2" id="stagesList"></div>
        <div class="hint" style="margin-top:8px;">
          Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ <strong>ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</strong> Ø£Ù…Ø§Ù… Ø£ÙŠ Ù…Ø±Ø­Ù„Ø© Ù„ÙŠØªÙ… Ø®ØªÙ…Ù‡Ø§ ÙˆØªØ­Ø¯ÙŠØ« ØµÙØ­Ø© ØªØªØ¨Ø¹ Ø§Ù„Ø¹Ù…ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.<br>
          ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø²Ø± <strong>ØªØ±Ø§Ø¬Ø¹</strong> Ù„Ø¥Ù„ØºØ§Ø¡ Ø£ÙŠ Ù…Ø±Ø­Ù„Ø© Ø«Ù… Ø¥Ø¹Ø§Ø¯Ø© ØªÙ†ÙÙŠØ°Ù‡Ø§ Ù…ØªÙ‰ Ø§Ø­ØªØ¬Øª.
        </div>
        <div class="muted" id="stageMsg" style="margin-top:6px;"></div>
      </div>
    </main>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import {
      getFirestore,
      collection,
      doc,
      getDoc,
      getDocs,
      query,
      where,
      orderBy,
      limit,
      updateDoc,
      setDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCorGtT5_Z68jCtLODvqnv0Fb7QW5eR6MQ",
      authDomain: "mzj-tracking.firebaseapp.com",
      projectId: "mzj-tracking",
      storageBucket: "mzj-tracking.firebasestorage.app",
      messagingSenderId: "655452217491",
      appId: "1:655452217491:web:9348d172c47bdd411fad66"
    };

    const ERP_COLLECTION      = "erp_orders";
    const ERP_VINS_COLLECTION = "erp_vins";
    const TRACK_COLLECTION    = "orders";

    const ERP_FIELDS = [
      "CustomerName","CustomerVAT","Branch","PostingDate",
      "TotalInclVAT","Status"
    ];

    const app  = initializeApp(firebaseConfig);
    const db   = getFirestore(app);
    const auth = getAuth(app);

    const ordersListBody   = document.getElementById("ordersListBody");
    const ordersMsg        = document.getElementById("ordersMsg");
    const statToday        = document.getElementById("statToday");
    const statInProgress   = document.getElementById("statInProgress");
    const statCompleted    = document.getElementById("statCompleted");
    const statTotal        = document.getElementById("statTotal");
    const searchOrderInput = document.getElementById("searchOrderInput");
    const searchCustomerInput = document.getElementById("searchCustomerInput");
    const filterBranch     = document.getElementById("filterBranch");

    const vinsCard   = document.getElementById("vinsCard");
    const vinSelect  = document.getElementById("vinSelect");
    const vinCarName = document.getElementById("vinCarName");
    const vinExtColor= document.getElementById("vinExtColor");
    const vinIntColor= document.getElementById("vinIntColor");
    const vinMsg     = document.getElementById("vinMsg");

    const stagesCard = document.getElementById("stagesCard");
    const stagesList = document.getElementById("stagesList");
    const stageMsg   = document.getElementById("stageMsg");

    let currentOrderId      = null;
    let currentVin          = null;
    let currentItemNo       = null;
    let currentOrderRecords = [];

    // Ø§Ù„Ù…Ø±Ø§Ø­Ù„ (10 Ù…Ø±Ø§Ø­Ù„)
    const STAGES = [
      "1) Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
      "2) Ø¥ÙŠØµØ§Ù„ Ø§Ù„Ø¯ÙØ¹ â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
      "3) Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ù† Ù‚ÙØ¨Ù„ Ù…Ù…Ø«Ù„ÙŠ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø¨Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¬Ø±ÙƒÙŠØ© â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø¹Ø±Ø¶)",
      "4) Ø³Ø¯Ø§Ø¯ Ø±Ø³ÙˆÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
      "5) Ø§Ù„ØªØ£Ù…ÙŠÙ† â€“ Ø´Ø±Ø· Ø§Ù„Ø±Ø¨Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ³ØªÙ… â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
      "6) Ø¥Ø³ØªÙŠÙØ§Ø¡ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
      "7) Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù„ÙˆØ­Ø§Øª Ø£Ùˆ Ù†Ù‚Ù„ Ø§Ù„Ù…Ù„ÙƒÙŠØ© â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø¹Ø±Ø¶)",
      "8) Ø¥Ø³ØªÙŠÙØ§Ø¡ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
      "9) Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ù„Ù„Ø¥Ø³ØªÙ„Ø§Ù… â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø¹Ø±Ø¶)",
      "10) Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­"
    ];

    function fmtCurrency(v){
      if(v==null) return "â€”";
      const n = typeof v==="number"?v:parseFloat(String(v).replace(/[^\d.,-]/g,"").replace(/,/g,""));
      if(!isFinite(n)) return "â€”";
      return n.toLocaleString("ar-SA",{minimumFractionDigits:2,maximumFractionDigits:2})+" Ø±.Ø³";
    }

    function setStageMessage(msg,type="info"){
      stageMsg.textContent = msg || "";
      stageMsg.style.color = type==="error" ? "#b91c1c" : (type==="success" ? "#166534" : "#6b7280");
    }

    function getTrackingDocIds() {
      if (!currentOrderId) return [];
      const base = currentOrderId;
      const vinClean = (currentVin || "").toString().trim();
      const itemNo = currentItemNo || 1;

      const ids = [];
      if (vinClean) ids.push(`${base}_VIN_${vinClean}`);
      ids.push(`${base}_${itemNo}`);
      ids.push(base);
      return ids;
    }

    async function getTrackingData(){
      const ids = getTrackingDocIds();
      const result = { docId:null, data:null };

      for(const id of ids){
        const ref = doc(db, TRACK_COLLECTION, id, "public", "status");
        const snap = await getDoc(ref);
        if(snap.exists()){
          result.docId = id;
          result.data  = snap.data();
          break;
        }
      }
      return result;
    }

    async function saveStage(stageNumber, completed){
      if(!currentOrderId || !currentVin){
        setStageMessage("Ø§Ø®ØªØ± Ø·Ù„Ø¨ ÙˆØ±Ù‚Ù… Ù‡ÙŠÙƒÙ„ Ø£ÙˆÙ„Ø§Ù‹.", "error");
        return;
      }
      const ids = getTrackingDocIds();
      if(!ids.length){
        setStageMessage("Ù„Ù… ÙŠØªÙ…ÙƒÙ† Ø§Ù„Ù†Ø¸Ø§Ù… Ù…Ù† ØªØ­Ø¯ÙŠØ¯ Ù…Ø³Ø§Ø± Ø§Ù„ØªØªØ¨Ø¹ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨.", "error");
        return;
      }

      const targetId = ids[0];
      const ref = doc(db, TRACK_COLLECTION, targetId, "public", "status");
      const key = "s"+stageNumber;

      try{
        const snap = await getDoc(ref);
        let data = {};
        if(snap.exists()){
          data = snap.data() || {};
        }
        if(!data.stages) data.stages = {};

        if(completed){
          data.stages[key] = serverTimestamp();
          data.currentStage = stageNumber;
        }else{
          delete data.stages[key];
          const keys = Object.keys(data.stages || {}).filter(k=>/^s\d+$/.test(k));
          let maxIndex = 0;
          for(const k of keys){
            const n = parseInt(k.slice(1),10);
            if(!isNaN(n) && n>maxIndex) maxIndex = n;
          }
          data.currentStage = maxIndex || 0;
        }

        data.updatedAt = serverTimestamp();
        await setDoc(ref, data, { merge:true });

        const refreshed = await getTrackingData();
        buildStagesUI(refreshed.data || {});
        setStageMessage("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­.", "success");
      }catch(err){
        console.error(err);
        setStageMessage("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù…Ø±Ø­Ù„Ø©. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.", "error");
      }
    }

    function buildStagesUI(orderData = {}) {
      stagesList.innerHTML = "";
      const stagesObj = orderData.stages || {};
      const current   = orderData.currentStage || 0;

      STAGES.forEach((label, idx) => {
        const num = idx + 1;
        const key = "s" + num;
        const ts  = stagesObj[key];

        const tsStr = ts
          ? new Date(ts.toDate ? ts.toDate() : ts).toLocaleString("ar-SA")
          : null;

        const wrap = document.createElement("div");
        wrap.className = "stage";
        if (tsStr) wrap.classList.add("done");

        const header = document.createElement("div");
        header.className = "stage-header";

        const tEl = document.createElement("div");
        tEl.innerHTML = "<strong>" + label + "</strong>";

        const meta = document.createElement("div");
        meta.innerHTML = tsStr
          ? "<small>ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡: " + tsStr + "</small>"
          : "<small>Ù„Ù… ØªÙÙ†ÙÙ‘Ø° Ø¨Ø¹Ø¯</small>";

        header.appendChild(tEl);
        header.appendChild(meta);

        const actions = document.createElement("div");
        actions.style.display = "flex";
        actions.style.gap = "6px";

        const undoBtn = document.createElement("button");
        undoBtn.className = "btn-outline";
        undoBtn.style.fontSize = "12px";
        undoBtn.textContent = "ØªØ±Ø§Ø¬Ø¹";
        undoBtn.disabled = !tsStr;
        undoBtn.onclick = () => saveStage(num, false);

        const btn = document.createElement("button");
        btn.className = "btn-outline stage-btn";
        btn.style.fontSize = "12px";
        btn.textContent = tsStr ? "ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°" : "ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡";
        btn.disabled = !!tsStr;
        btn.onclick = () => saveStage(num, true);

        actions.appendChild(undoBtn);
        actions.appendChild(btn);

        wrap.appendChild(header);
        wrap.appendChild(actions);

        if (current === num) {
          const b = document.createElement("div");
          b.className = "hint";
          b.textContent = "Ù‡Ø°Ù‡ Ù‡ÙŠ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø³Ø¬Ù„Ø© ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù….";
          wrap.appendChild(b);
        }

        stagesList.appendChild(wrap);
      });

      stagesCard.style.display = "block";
    }

    async function loadOrders(){
      ordersMsg.textContent = "Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...";
      ordersListBody.innerHTML = "";

      const colRef = collection(db, ERP_COLLECTION);
      let qRef = query(colRef, orderBy("PostingDate","desc"), limit(100));
      const snap = await getDocs(qRef);

      const rows = [];
      let todayCount=0, inProgress=0, completed=0, totalAmount=0;

      const todayStr = new Date().toISOString().slice(0,10);

      snap.forEach(docSnap=>{
        const data = docSnap.data() || {};
        const id   = docSnap.id;
        const orderNo = data.OrderNo || data.orderNo || id;
        const customer = data.CustomerName || data.customerName || "â€”";
        const branch = data.Branch || data.branch || "â€”";
        const postingDate = (data.PostingDate || data.postingDate || "").slice(0,10);
        const totalIncl = data.TotalInclVAT ?? data.totalInclVAT ?? null;
        const status = data.Status || data.status || "Open";

        const row = { id, orderNo, customer, branch, postingDate, totalIncl, status };
        rows.push(row);

        if(postingDate===todayStr) todayCount++;
        if(status==="Completed") completed++;
        else inProgress++;
        if(totalIncl!=null){
          const n = parseFloat(String(totalIncl).replace(/[^\d.,-]/g,"").replace(/,/g,""));
          if(isFinite(n)) totalAmount += n;
        }
      });

      rows.forEach(row=>{
        const tr = document.createElement("tr");

        const tdOrder = document.createElement("td");
        tdOrder.textContent = row.orderNo;

        const tdCustomer = document.createElement("td");
        tdCustomer.textContent = row.customer;

        const tdBranch = document.createElement("td");
        tdBranch.textContent = row.branch;

        const tdDate = document.createElement("td");
        tdDate.textContent = row.postingDate || "â€”";

        const tdTotal = document.createElement("td");
        tdTotal.textContent = fmtCurrency(row.totalIncl);

        const tdStatus = document.createElement("td");
        const sSpan = document.createElement("span");
        sSpan.className = "tag " + (row.status==="Completed"?"tag-success":"tag-warning");
        sSpan.textContent = row.status==="Completed"?"Ù…ÙƒØªÙ…Ù„":"Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©";
        tdStatus.appendChild(sSpan);

        const tdActions = document.createElement("td");
        const linkBtn = document.createElement("button");
        linkBtn.className = "btn-outline";
        linkBtn.textContent = "Ø§Ø®ØªÙŠØ§Ø±";
        linkBtn.dataset.orderId = row.orderNo;
        linkBtn.onclick = () => selectOrder(row.orderNo);
        tdActions.appendChild(linkBtn);

        tr.appendChild(tdOrder);
        tr.appendChild(tdCustomer);
        tr.appendChild(tdBranch);
        tr.appendChild(tdDate);
        tr.appendChild(tdTotal);
        tr.appendChild(tdStatus);
        tr.appendChild(tdActions);

        ordersListBody.appendChild(tr);
      });

      statToday.textContent      = rows.length ? todayCount : "â€”";
      statInProgress.textContent = rows.length ? inProgress : "â€”";
      statCompleted.textContent  = rows.length ? completed : "â€”";
      statTotal.textContent      = rows.length ? fmtCurrency(totalAmount) : "â€”";

      ordersMsg.textContent = rows.length ? "Ø§Ø®ØªØ± Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø£Ø¹Ù„Ø§Ù‡." : "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…ØªØ§Ø­Ø©.";
    }

    async function selectOrder(orderId){
      currentOrderId = orderId;
      currentVin     = null;
      currentItemNo  = 1;
      vinsCard.style.display = "none";
      stagesCard.style.display = "false";
      vinSelect.innerHTML = "";
      vinCarName.textContent = "â€”";
      vinExtColor.textContent = "â€”";
      vinIntColor.textContent = "â€”";
      vinMsg.textContent = "Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‡ÙŠØ§ÙƒÙ„ Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨...";
      setStageMessage("");

      try{
        const vinCol = collection(db, ERP_VINS_COLLECTION);
        const qRef = query(vinCol, where("lastOrderNo","==",orderId));
        const snap = await getDocs(qRef);

        const vins = [];
        snap.forEach(docSnap=>{
          const id = docSnap.id;
          const data = docSnap.data() || {};
          const lastData = data.lastData || {};
          vins.push({
            vin:id,
            itemNo:data.lastItemNo || lastData.itemNo || 1,
            carName:lastData.itemModel || lastData.itemName || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯",
            extColor:lastData.exteriorColor || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯",
            intColor:lastData.interiorColor || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"
          });
        });

        if(!vins.length){
          vinsCard.style.display = "block";
          vinMsg.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø±Ù‚Ø§Ù… Ù‡ÙŠØ§ÙƒÙ„ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ erp_vins.";
          return;
        }

        vinSelect.innerHTML = "";
        vins.forEach(v=>{
          const opt = document.createElement("option");
          opt.value = v.vin+"||"+v.itemNo;
          opt.textContent = v.vin;
          opt.dataset.carName = v.carName;
          opt.dataset.extColor = v.extColor;
          opt.dataset.intColor = v.intColor;
          vinSelect.appendChild(opt);
        });

        vinsCard.style.display = "block";
        vinMsg.textContent = "Ø§Ø®ØªØ± Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ Ù„Ù„Ø¹Ù…Ù„ Ø¹Ù„Ù‰ Ù…Ø±Ø§Ø­Ù„Ù‡.";

        const first = vins[0];
        selectVinInternal(first.vin, first.itemNo, first.carName, first.extColor, first.intColor);

        vinSelect.onchange = ()=>{
          const val = vinSelect.value;
          const [v,itemNo] = val.split("||");
          const opt = vinSelect.options[vinSelect.selectedIndex];
          const carName = opt.dataset.carName;
          const extC    = opt.dataset.extColor;
          const intC    = opt.dataset.intColor;
          selectVinInternal(v, parseInt(itemNo||"1",10), carName, extC, intC);
        };

      }catch(err){
        console.error(err);
        vinMsg.textContent = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‡ÙŠØ§ÙƒÙ„.";
      }
    }

    async function selectVinInternal(vin, itemNo, carName, extColor, intColor){
      currentVin    = vin;
      currentItemNo = itemNo || 1;
      vinCarName.textContent = carName || "â€”";
      vinExtColor.textContent = extColor || "â€”";
      vinIntColor.textContent = intColor || "â€”";
      setStageMessage("");

      const tracking = await getTrackingData();
      buildStagesUI(tracking.data || {});
    }

    loadOrders();
  </script>
</body>
</html>
