<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MZJ — إدارة مبيعات</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    :root{ --brown:#3e2420; --beige:#bc8f74; --cream:#fff8ef; --text:#1f2937; --muted:#6b7280; --radius:14px }
    *{box-sizing:border-box}
    body{margin:0;background:var(--cream);color:var(--text);font-family:"Tajawal",system-ui,Arial}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1100px;margin:24px auto;padding:16px}
    .card{background:#fff;border-radius:var(--radius);box-shadow:0 8px 30px rgba(62,36,32,.08);padding:18px;margin-bottom:16px}
    .title{display:flex;align-items:center;gap:10px;color:var(--brown);margin:0 0 12px 0}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .col-6{grid-column:span 6}
    .col-4{grid-column:span 4}
    .col-3{grid-column:span 3}
    .col-2{grid-column:span 2}
    .col-12{grid-column:span 12}
    label{font-weight:700;color:var(--brown);display:block;margin-bottom:6px}
    input,select,textarea{width:100%;padding:12px 14px;border:1px solid #e8e2dc;border-radius:12px;background:#fff}
    textarea{min-height:90px}
    button{border:0;border-radius:12px;padding:12px 16px;font-weight:800;cursor:pointer}
    .btn{background:var(--brown);color:#fff}
    .btn-outline{background:#fff;border:1px solid var(--beige);color:var(--brown)}
    .stage{display:flex;align-items:center;justify-content:space-between;border:1px dashed #efd9cb;padding:12px;border-radius:12px;margin-bottom:8px;background:#fffaf3}
    .stage strong{color:var(--brown)}
    .stage.done{background:#ecfdf5;border-color:#bbf7d0;}
    .muted{color:var(--muted);font-size:14px}
    .badge{display:inline-block;background:var(--beige);color:#fff;padding:4px 8px;border-radius:999px;font-size:12px}
    .topbar{background:var(--brown);color:#fff;padding:12px 16px;display:flex;justify-content:space-between;align-items:center}
    .logout{background:#fff;color:var(--brown);padding:6px 10px;border-radius:10px;border:0;cursor:pointer}
    .hint{font-size:13px;color:var(--muted)}
    .ok{color:#0e7a48;font-weight:700}
    .err{color:#b00020;font-weight:700}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#f3f4ff;color:#1d4ed8;font-size:12px}
    .items-list{margin:0;padding-right:18px;font-size:14px}
    .items-list li{margin-bottom:4px}
    @media (max-width:900px){
      .row{grid-template-columns:1fr}
      .col-6,.col-4,.col-3,.col-2,.col-12{grid-column:span 1}
      .grid-2{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div><strong>MZJ — إدارة المبيعات</strong></div>
    <div id="authArea">
      <span id="whoami" class="hint"></span>
      <button id="logoutBtn" class="logout" style="display:none">تسجيل الخروج</button>
    </div>
  </div>

  <div class="wrap">
    <!-- Auth Card -->
    <div class="card" id="authCard">
      <h3 class="title">تسجيل الدخول</h3>
      <div class="row">
        <div class="col-4">
          <label>البريد</label>
          <input id="email" type="email" placeholder="admin@yourdomain.com" />
        </div>
        <div class="col-4">
          <label>كلمة السر</label>
          <input id="password" type="password" placeholder="••••••••" />
        </div>
        <div class="col-4" style="display:flex;align-items:end;gap:8px">
          <button class="btn" id="loginBtn">دخول</button>
          <button class="btn-outline" id="signupBtn" title="إنشاء مستخدم جديد">تسجيل جديد</button>
        </div>
      </div>
      <div class="hint">الدخول مطلوب لإضافة/تحديث الطلبات.</div>
      <div id="authMsg" class="muted"></div>
    </div>

    <!-- Create/Find Order -->
    <div class="card" id="orderCard" style="display:none">
      <h3 class="title">إنشاء/فتح طلب</h3>
      <div class="row">
        <div class="col-3">
          <label>رقم الطلب (مهم جدًا)</label>
          <input id="orderId" placeholder="مثال: 18790" />
        </div>
        <div class="col-3">
          <label>اسم العميل</label>
          <input id="customerName" placeholder="اسم ثلاثي" />
        </div>
        <div class="col-3">
          <label>جوال العميل</label>
          <input id="customerPhone" placeholder="05xxxxxxxx" />
        </div>
        <div class="col-3">
          <label>أمر الدفع</label>
          <select id="paymentMethod">
            <option value="تحويل">تحويل</option>
            <option value="شبكة">شبكة</option>
            <option value="كاش">كاش</option>
          </select>
        </div>
        <div class="col-12">
          <label>ملاحظات</label>
          <textarea id="notes" placeholder="تفاصيل إضافية للإدارة"></textarea>
        </div>
        <div class="col-12" style="display:flex;gap:8px;align-items:center">
          <button id="createBtn" class="btn">حفظ/إنشاء</button>
          <button id="loadBtn" class="btn-outline">فتح طلب موجود</button>
          <span id="orderMsg" class="muted"></span>
        </div>
      </div>
    </div>

    <!-- Woo Order Details -->
    <div class="card" id="wooDetailsCard" style="display:none">
      <h3 class="title">تفاصيل الطلب من المتجر (WooCommerce)</h3>
      <div class="row">
        <div class="col-3">
          <label>رقم الطلب في المتجر</label>
          <input id="wooOrderNumber" readonly />
        </div>
        <div class="col-3">
          <label>حالة الطلب في المتجر</label>
          <input id="wooStatus" readonly />
        </div>
        <div class="col-3">
          <label>إجمالي الطلب</label>
          <input id="wooTotal" readonly />
        </div>
        <div class="col-3">
          <label>طريقة الدفع (المتجر)</label>
          <input id="wooPaymentTitle" readonly />
        </div>

        <div class="col-3">
          <label>اسم العميل (الفاتورة)</label>
          <input id="wooBillingName" readonly />
        </div>
        <div class="col-3">
          <label>جوال العميل (الفاتورة)</label>
          <input id="wooBillingPhone" readonly />
        </div>
        <div class="col-3">
          <label>البريد الإلكتروني</label>
          <input id="wooBillingEmail" readonly />
        </div>
        <div class="col-3">
          <label>المدينة / الدولة</label>
          <input id="wooBillingCityCountry" readonly />
        </div>

        <div class="col-12">
          <label>عنوان الفاتورة</label>
          <input id="wooBillingAddress" readonly />
        </div>

        <div class="col-12">
          <label>المنتجات في الطلب</label>
          <ul id="wooItemsList" class="items-list"></ul>
        </div>
      </div>
      <div class="hint">هذه التفاصيل تُجلب مباشرةً من طلب WooCommerce عن طريق Webhook.</div>
    </div>

    <!-- Stages -->
    <div class="card" id="stagesCard" style="display:none">
      <h3 class="title">مراحل التتبع</h3>
      <div class="grid-2" id="stagesList"></div>
      <div class="hint" style="margin-top:8px">
        اضغط على <strong>تم الانتهاء</strong> أمام أي مرحلة ليتم ختمها وتعيينها كآخر مرحلة للطلب مع مزامنتها فورًا في صفحة العميل.
      </div>
      <div class="muted" id="stageMsg" style="margin-top:6px"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCorGtT5_Z68jCtLODvqnv0Fb7QW5eR6MQ",
      authDomain: "mzj-tracking.firebaseapp.com",
      projectId: "mzj-tracking",
      storageBucket: "mzj-tracking.firebasestorage.app",
      messagingSenderId: "655452217491",
      appId: "1:655452217491:web:9348d172c47bdd411fad66"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI
    const authCard = document.getElementById("authCard");
    const orderCard = document.getElementById("orderCard");
    const stagesCard = document.getElementById("stagesCard");
    const whoami = document.getElementById("whoami");
    const logoutBtn = document.getElementById("logoutBtn");
    const email = document.getElementById("email");
    const password = document.getElementById("password");
    const loginBtn = document.getElementById("loginBtn");
    const signupBtn = document.getElementById("signupBtn");
    const authMsg = document.getElementById("authMsg");

    const orderId = document.getElementById("orderId");
    const customerName = document.getElementById("customerName");
    const customerPhone = document.getElementById("customerPhone");
    const paymentMethod = document.getElementById("paymentMethod");
    const notes = document.getElementById("notes");
    const createBtn = document.getElementById("createBtn");
    const loadBtn = document.getElementById("loadBtn");
    const orderMsg = document.getElementById("orderMsg");

    const stagesList = document.getElementById("stagesList");
    const stageMsg = document.getElementById("stageMsg");

    // Woo details
    const wooDetailsCard      = document.getElementById("wooDetailsCard");
    const wooOrderNumberEl    = document.getElementById("wooOrderNumber");
    const wooStatusEl         = document.getElementById("wooStatus");
    const wooTotalEl          = document.getElementById("wooTotal");
    const wooPaymentTitleEl   = document.getElementById("wooPaymentTitle");
    const wooBillingNameEl    = document.getElementById("wooBillingName");
    const wooBillingPhoneEl   = document.getElementById("wooBillingPhone");
    const wooBillingEmailEl   = document.getElementById("wooBillingEmail");
    const wooBillingCityCountryEl = document.getElementById("wooBillingCityCountry");
    const wooBillingAddressEl = document.getElementById("wooBillingAddress");
    const wooItemsListEl      = document.getElementById("wooItemsList");

    const STAGES = [
      "1) إنشاء الطلب",
      "2) أمر الدفع (تحويل/شبكة/كاش)",
      "3) تواصل خدمة العملاء + إرسال البطاقة الجمركية",
      "4) سداد رسوم التسجيل",
      "5) التأمين (شرط الربط على السيستم)",
      "6) استيفاء الأوراق والمبالغ",
      "7) تجيير البطاقة الجمركية",
      "8) إصدار اللوحات أو نقل الملكية",
      "9) جاهزية السيارة للاستلام/طلب الشحن",
      "10) إتمام التسليم بنجاح"
    ];

    function buildStagesUI(data = {}) {
      stagesList.innerHTML = "";
      const stagesObj = data.stages || {};

      STAGES.forEach((label, idx) => {
        const stageNumber = idx + 1;
        const key = "s" + stageNumber;
        const tsObj = stagesObj[key];
        const ts = tsObj
          ? new Date(tsObj.toDate ? tsObj.toDate() : tsObj).toLocaleString("ar-SA")
          : null;

        const item = document.createElement("div");
        item.className = "stage";
        if (ts) item.classList.add("done"); // أي مرحلة فيها وقت تعتبر منتهية (لون أخضر)

        item.innerHTML = `
          <div>
            <strong>${label}</strong>
            <div class="muted">
              ${ ts ? "تم الانتهاء في: " + ts : "لم يتم الانتهاء بعد" }
            </div>
          </div>
          <div>
            <button class="btn-outline" data-key="${key}" data-stage="${stageNumber}">
              تم الانتهاء
            </button>
          </div>
        `;
        stagesList.appendChild(item);
      });
    }

    function fillWooDetails(data) {
      if (!data || !data.wooOrderNumber) {
        wooDetailsCard.style.display = "none";
        wooItemsListEl.innerHTML = "";
        return;
      }
      wooDetailsCard.style.display = "";

      wooOrderNumberEl.value  = data.wooOrderNumber || data.orderId || "";
      wooStatusEl.value       = data.wooStatus || "";
      wooTotalEl.value        = data.orderTotal
        ? `${data.orderTotal} ${data.orderCurrency || ""}`
        : "";
      wooPaymentTitleEl.value = data.paymentMethodTitle || data.wooPaymentTitle || "";

      const billingName = data.customerName || "";
      const billingPhone = data.customerPhone || "";
      const billingEmail = data.customerEmail || "";
      const cityCountry = [
        data.billingCity || "",
        data.billingCountry || "",
      ].filter(Boolean).join(" / ");
      const address = [
        data.billingAddress1 || "",
        data.billingPostcode || "",
      ]
        .filter(Boolean)
        .join(" - ");

      wooBillingNameEl.value        = billingName;
      wooBillingPhoneEl.value       = billingPhone;
      wooBillingEmailEl.value       = billingEmail;
      wooBillingCityCountryEl.value = cityCountry;
      wooBillingAddressEl.value     = address;

      const items = data.lineItems || (data.wooDetails && data.wooDetails.items) || [];
      wooItemsListEl.innerHTML = "";
      if (!items.length) {
        wooItemsListEl.innerHTML = "<li class='muted'>لا توجد منتجات مسجلة في هذا الطلب.</li>";
      } else {
        items.forEach((it) => {
          const li = document.createElement("li");
          li.textContent = `${it.name || ""} — عدد: ${it.quantity || 1} — إجمالي: ${it.total || ""}`;
          wooItemsListEl.appendChild(li);
        });
      }
    }

    // Auth state
    onAuthStateChanged(auth, (user) => {
      if (user) {
        authCard.style.display = "none";
        orderCard.style.display = "";
        stagesCard.style.display = "";
        whoami.textContent = "مسجّل: " + (user.email || "");
        logoutBtn.style.display = "";
      } else {
        authCard.style.display = "";
        orderCard.style.display = "none";
        stagesCard.style.display = "none";
        wooDetailsCard.style.display = "none";
        whoami.textContent = "";
        logoutBtn.style.display = "none";
      }
    });

    // Auth actions
    loginBtn.onclick = async () => {
      authMsg.textContent = "";
      try {
        await signInWithEmailAndPassword(auth, email.value.trim(), password.value.trim());
      } catch (e) {
        authMsg.innerHTML = `<span class="err">فشل الدخول: ${e.message}</span>`;
      }
    };

    signupBtn.onclick = async () => {
      authMsg.textContent = "";
      try {
        await createUserWithEmailAndPassword(auth, email.value.trim(), password.value.trim());
        authMsg.innerHTML = `<span class="ok">تم إنشاء المستخدم.</span>`;
      } catch (e) {
        authMsg.innerHTML = `<span class="err">فشل الإنشاء: ${e.message}</span>`;
      }
    };

    logoutBtn.onclick = () => signOut(auth);

    async function loadOrder() {
      stageMsg.textContent = "";
      orderMsg.textContent = "";
      const id = orderId.value.trim();
      if (!id) {
        orderMsg.innerHTML = `<span class="err">أدخل رقم الطلب.</span>`;
        buildStagesUI();
        fillWooDetails(null);
        return null;
      }
      const ref = doc(db, "orders", id);
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        buildStagesUI();
        fillWooDetails(null);
        orderMsg.innerHTML = `<span class="err">الطلب غير موجود — يمكنك إنشاؤه.</span>`;
        return null;
      }
      const data = snap.data();
      customerName.value = data.customerName || "";
      customerPhone.value = data.customerPhone || "";
      paymentMethod.value = data.paymentMethod || "تحويل";
      notes.value = data.notes || "";
      buildStagesUI(data);
      fillWooDetails(data);
      orderMsg.innerHTML = `<span class="ok">تم تحميل الطلب.</span>`;
      return data;
    }

    loadBtn.onclick = loadOrder;

    // Create/Save basic order
    createBtn.onclick = async () => {
      orderMsg.textContent = "";
      stageMsg.textContent = "";
      try {
        const id = orderId.value.trim();
        if (!id) throw new Error("أدخل رقم الطلب");
        const now = new Date();
        const payload = {
          orderId: id,
          customerName: customerName.value.trim(),
          customerPhone: customerPhone.value.trim(),
          paymentMethod: paymentMethod.value,
          notes: notes.value.trim(),
          currentStage: 1,
          stages: { } // أول مرة بدون ختم، تقدر تختم من الزرار
        };
        await setDoc(doc(db, "orders", id), payload, { merge: true });

        await setDoc(
          doc(db, "orders", id, "public", "status"),
          {
            orderId: id,
            currentStage: 0, // لسه ولا مرحلة منتهية
            stages: {},
            updatedAt: serverTimestamp()
          },
          { merge: true }
        );

        buildStagesUI(payload);
        fillWooDetails(null);
        orderMsg.innerHTML = `<span class="ok">تم حفظ/إنشاء الطلب ومزامنته للعميل.</span>`;
      } catch (e) {
        orderMsg.innerHTML = `<span class="err">خطأ: ${e.message}</span>`;
      }
    };

    // عند الضغط على "تم الانتهاء" لأي مرحلة:
    // - نختم المرحلة (stages.sX = now)
    // - currentStage = نفس رقم المرحلة (مافيش +1)
    // - مزامنة document تبع العميل public/status بنفس الرقم
    stagesList.addEventListener("click", async (e) => {
      const btn = e.target.closest("button[data-key]");
      if (!btn) return;
      const id = orderId.value.trim();
      if (!id) {
        stageMsg.innerHTML = `<span class="err">أدخل/حمّل رقم الطلب أولاً.</span>`;
        return;
      }

      const key = btn.getAttribute("data-key");
      const stageNumber = parseInt(btn.getAttribute("data-stage"), 10) || 0;

      try {
        const now = new Date();

        await updateDoc(doc(db, "orders", id), {
          [`stages.${key}`]: now,
          currentStage: stageNumber
        });

        await setDoc(
          doc(db, "orders", id, "public", "status"),
          {
            [`stages.${key}`]: now,
            currentStage: stageNumber,
            updatedAt: serverTimestamp()
          },
          { merge: true }
        );

        const data = await loadOrder();
        buildStagesUI(data || {});
        stageMsg.innerHTML = `<span class="ok">تم الانتهاء من المرحلة رقم ${stageNumber} ومزامنتها فورًا مع صفحة العميل.</span>`;
      } catch (err) {
        console.error(err);
        stageMsg.innerHTML = `<span class="err">خطأ أثناء تحديث المرحلة.</span>`;
      }
    });

    // init
    buildStagesUI();
    fillWooDetails(null);
  </script>
</body>
</html>
