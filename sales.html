<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MZJ — لوحة فريق المبيعات</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
<style>
:root{ --brown:#3e2420; --beige:#bc8f74; --cream:#fff8ef; --text:#1f2937; --muted:#6b7280; --radius:14px; --shadow:0 8px 28px rgba(0,0,0,.08); }
*{box-sizing:border-box} body{margin:0;background:var(--cream);color:var(--text);font-family:"Tajawal",system-ui,Arial;line-height:1.75}
.wrap{max-width:1100px;margin:24px auto;padding:0 16px}
.topbar{display:flex;justify-content:space-between;align-items:center;padding:14px;background:#fff;border:1px solid #eadbcf;border-radius:var(--radius);box-shadow:var(--shadow)}
.logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--brown),#2a1714);color:#fff;display:grid;place-items:center;font-weight:900}
h1{margin:0;font-size:18px;color:var(--brown)}
.card{background:#fff;border:1px solid #eadbcf;border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin-top:16px}
.row{display:flex;gap:8px;flex-wrap:wrap}
input,select,textarea{padding:10px 12px;border:1px solid #eadbcf;border-radius:10px;background:#fff}
button{border:1px solid #eadbcf;background:#fff;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:800}
button.primary{background:var(--brown);border-color:var(--brown);color:#fff}
.small{font-size:13px}.muted{color:var(--muted)}
.grid{display:grid;gap:16px} @media(min-width:900px){ .grid-2{grid-template-columns:1fr 1fr} }
label{font-weight:800}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div style="display:flex;gap:10px;align-items:center">
      <div class="logo">★</div>
      <div>
        <h1>MZJ — لوحة فريق المبيعات</h1>
        <div class="muted small">تحديث حالة الطلبات (محمي)</div>
      </div>
    </div>
    <div class="muted small" id="who"></div>
  </div>

  <!-- تسجيل الدخول -->
  <div class="card" id="loginCard">
    <div class="row">
      <input id="email" placeholder="بريد الموظف" />
      <input id="password" type="password" placeholder="كلمة المرور" />
      <button class="primary" id="btnLogin">دخول</button>
    </div>
    <div class="muted small">لازم المستخدم يكون له claim: role=sales أو admin</div>
  </div>

  <!-- لوحة التحكم بعد الدخول -->
  <div id="app" style="display:none">
    <div class="card">
      <div class="row">
        <input id="orderSearch" placeholder="رقم الطلب (مثال: ORD-2025-001)" />
        <button class="primary" id="btnLoad">تحميل الطلب</button>
        <button id="btnNew">إنشاء طلب جديد</button>
        <button id="btnLogout">خروج</button>
      </div>
      <div class="muted small" id="statusMsg"></div>
    </div>

    <div class="grid grid-2">
      <div class="card">
        <div class="row">
          <div style="flex:1">
            <label>رقم الطلب</label>
            <input id="orderNumber" />
          </div>
          <div style="flex:1">
            <label>الحالة</label>
            <select id="status"></select>
          </div>
        </div>

        <div class="row">
          <div style="flex:1">
            <label>طريقة الدفع</label>
            <select id="paymentMethod">
              <option value="">—</option>
              <option value="TRANSFER">تحويل</option>
              <option value="POS">شبكة</option>
              <option value="CASH">كاش</option>
            </select>
          </div>
          <div style="flex:1">
            <label>آخر تحديث</label>
            <input id="updatedAt" disabled />
          </div>
        </div>

        <div class="row">
          <div style="flex:1">
            <label>اسم العميل</label>
            <input id="custName" placeholder="الاسم"/>
          </div>
          <div style="flex:1">
            <label>رقم الجوال</label>
            <input id="custPhone" placeholder="+9665..."/>
          </div>
          <div style="flex:1">
            <label>البريد الإلكتروني</label>
            <input id="custEmail" placeholder="example@email.com"/>
          </div>
        </div>

        <div class="row">
          <div style="flex:1">
            <label>السيارة</label>
            <input id="veh" placeholder="Hyundai Elantra 2026 Smart Plus أبيض"/>
          </div>
        </div>

        <div class="row">
          <div style="flex:1">
            <label>ملاحظات</label>
            <textarea id="notes" rows="4" placeholder="تفاصيل المرحلة…"></textarea>
          </div>
        </div>

        <div class="row">
          <button class="primary" id="btnSave">حفظ</button>
        </div>
      </div>

      <div class="card">
        <div class="small muted" style="margin-bottom:8px">تلميحات سريعة</div>
        <ul class="small muted" style="margin-top:0">
          <li>المراحل من (3) إلى (8) مسؤولية فريق المبيعات.</li>
          <li>العميل يشاهد الحالة من track.html عبر Cloud Function.</li>
          <li>حدّث الملاحظات بما تم (إرسال البطاقة/سداد الرسوم...)</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<script>
// ****** Firebase Config — من عندك ******
const firebaseConfig = {
  apiKey: "AIzaSyCorGtT5_Z68jCtLODvqnv0Fb7QW5eR6MQ",
  authDomain: "mzj-tracking.firebaseapp.com",
  projectId: "mzj-tracking",
  // storageBucket غير مطلوب هنا
  messagingSenderId: "655452217491"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// مراحل التراكينج
const STAGES = [
  {k:'ORDER_CREATED',      t:'1) تم إنشاء الطلب (رقم الطلب مهم)'},
  {k:'PAYMENT_ORDER',      t:'2) أمر الدفع (تحويل/شبكة/كاش)'},
  {k:'CUSTOMER_SERVICE',   t:'3) تواصل ممثلي خدمة العملاء + إرسال البطاقة الجمركية'},
  {k:'FEES_PAYMENT',       t:'4) سداد الرسوم'},
  {k:'INSURANCE_LINK',     t:'5) التأمين (شرط الربط على سيستم المملكة)'},
  {k:'DOCS_CLEARANCE',     t:'6) استيفاء الأوراق والمبالغ المتبقية'},
  {k:'CUSTOMS_TRANSFER',   t:'7) تجيير البطاقة الجمركية'},
  {k:'PLATES_OR_OWNERSHIP',t:'8) إصدار اللوحات أو نقل الملكية'},
  {k:'READY_OR_SHIPPING',  t:'9) جاهزية السيارة للاستلام أو طلب الشحن'},
  {k:'DELIVERED',          t:'10) إتمام عملية التسليم بنجاح'}
];
const statusSel = document.getElementById('status');
STAGES.forEach(s=>{ const o=document.createElement('option'); o.value=s.k; o.textContent=s.t; statusSel.appendChild(o); });

// عناصر عامة
const loginCard = document.getElementById('loginCard');
const app = document.getElementById('app');
const who = document.getElementById('who');
document.getElementById('btnLogin').addEventListener('click', async ()=>{
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value;
  try{ await auth.signInWithEmailAndPassword(email, password); }
  catch(e){ alert('فشل تسجيل الدخول'); console.error(e); }
});
document.getElementById('btnLogout').addEventListener('click', ()=>auth.signOut());
auth.onAuthStateChanged((u)=>{
  if(u){ who.textContent = `مسجّل: ${u.email||u.uid}`; loginCard.style.display='none'; app.style.display='block'; }
  else { who.textContent = ''; loginCard.style.display='block'; app.style.display='none'; }
});

// تحميل/إنشاء/حفظ
const msg = document.getElementById('statusMsg');
const f = {
  orderNumber: document.getElementById('orderNumber'),
  status: document.getElementById('status'),
  paymentMethod: document.getElementById('paymentMethod'),
  updatedAt: document.getElementById('updatedAt'),
  custName: document.getElementById('custName'),
  custPhone: document.getElementById('custPhone'),
  custEmail: document.getElementById('custEmail'),
  veh: document.getElementById('veh'),
  notes: document.getElementById('notes'),
};
document.getElementById('btnLoad').addEventListener('click', async ()=>{
  const num = document.getElementById('orderSearch').value.trim();
  if(!num){ msg.textContent='أدخل رقم الطلب'; return; }
  try{
    const snap = await db.collection('orders').doc(num).get();
    if(!snap.exists){ msg.textContent='لم يتم العثور على الطلب'; return; }
    fillForm(snap.data()); msg.textContent='تم التحميل';
  }catch(e){ console.error(e); msg.textContent='خطأ في التحميل'; }
});
document.getElementById('btnNew').addEventListener('click', ()=>{
  fillForm({
    orderNumber: 'ORD-' + new Date().getFullYear() + '-' + Math.floor(Math.random()*1000).toString().padStart(3,'0'),
    status: 'ORDER_CREATED',
    statusIndex: 1,
    paymentMethod: '',
    notes: '',
    customer: {name:'', phone:'', email:''},
    vehicle: null,
    meta: {updatedAt: Date.now()}
  });
  msg.textContent = 'جاري إنشاء طلب جديد — عدّل ثم احفظ';
});
document.getElementById('btnSave').addEventListener('click', async ()=>{
  const orderNumber = f.orderNumber.value.trim();
  if(!orderNumber){ msg.textContent='رقم الطلب مطلوب'; return; }
  const status = f.status.value;
  const statusIndex = STAGES.findIndex(s=>s.k===status)+1;
  const doc = {
    orderNumber,
    status, statusIndex,
    paymentMethod: f.paymentMethod.value || null,
    notes: f.notes.value || '',
    customer: { name: f.custName.value||'', phone: f.custPhone.value||'', email: f.custEmail.value||'' },
    vehicle: f.veh.value ? { title: f.veh.value } : null,
    meta: { updatedAt: Date.now(), updatedBy: auth.currentUser?.email || auth.currentUser?.uid }
  };
  try{
    await db.collection('orders').doc(orderNumber).set(doc, { merge:true });
    f.updatedAt.value = new Date(doc.meta.updatedAt).toLocaleString('ar-SA');
    msg.textContent='تم الحفظ ✅';
  }catch(e){ console.error(e); msg.textContent='فشل الحفظ'; }
});
function fillForm(d){
  f.orderNumber.value = d.orderNumber||'';
  f.status.value = d.status||'ORDER_CREATED';
  f.paymentMethod.value = d.paymentMethod||'';
  f.updatedAt.value = d.meta?.updatedAt ? new Date(d.meta.updatedAt).toLocaleString('ar-SA') : '';
  f.custName.value = d.customer?.name||'';
  f.custPhone.value = d.customer?.phone||'';
  f.custEmail.value = d.customer?.email||'';
  f.veh.value = d.vehicle?.title||'';
  f.notes.value = d.notes||'';
}
</script>
</body>
</html>
