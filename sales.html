
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MZJ â€” Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">
  
  <style>
    :root{
      --brown:#3e2420;
      --beige:#bc8f74;
      --cream:#fff8ef;
      --cream-soft:#fff3e2;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --radius-lg:18px;
      --radius-md:12px;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      min-height:100vh;
      font-family:"Tajawal",system-ui,Arial,sans-serif;
      background:radial-gradient(circle at top left,#fff,#ffeedd 55%,#f5e7db 100%);
      color:var(--text);
    }
    a{color:inherit;text-decoration:none}
    .topbar{
      position:sticky;
      top:0;
      z-index:20;
      background:linear-gradient(90deg,var(--brown),#2b1916);
      color:#fff;
      padding:10px 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      box-shadow:0 6px 25px rgba(0,0,0,0.25);
    }
    .topbar-title{
      font-weight:800;
      letter-spacing:.4px;
      font-size:16px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .topbar-title::before{
      content:"â˜…";
      font-size:17px;
      color:var(--beige);
    }
    .wrap{
      max-width:1200px;
      margin:18px auto 40px;
      padding:0 16px 24px;
    }
    .card{
      background:#fff;
      border-radius:var(--radius-lg);
      border:1px solid rgba(188,143,116,0.18);
      box-shadow:0 18px 45px rgba(62,36,32,0.08);
      padding:18px 18px 20px;
      margin-bottom:16px;
    }
    .title{
      display:flex;
      align-items:center;
      gap:10px;
      margin:0 0 14px 0;
      color:var(--brown);
      font-size:18px;
      font-weight:700;
    }
    .title span.icon{
      width:30px;
      height:30px;
      border-radius:999px;
      background:rgba(188,143,116,.16);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:16px;
    }
    .row{
      display:grid;
      grid-template-columns:repeat(12,1fr);
      gap:12px;
    }
    .col-3{grid-column:span 3}
    .col-4{grid-column:span 4}
    .col-6{grid-column:span 6}
    .col-12{grid-column:span 12}
    label{
      display:block;
      font-size:13px;
      margin-bottom:4px;
      color:var(--muted);
    }
    input{
      width:100%;
      padding:8px 10px;
      border-radius:var(--radius-md);
      border:1px solid var(--border);
      font-family:inherit;
      font-size:14px;
      outline:none;
      background:#f9fafb;
      transition:border-color .15s, box-shadow .15s, background .15s;
    }
    input:focus{
      border-color:var(--beige);
      box-shadow:0 0 0 1px rgba(188,143,116,.45);
      background:#fff;
    }
    .btn{
      border:0;
      background:var(--brown);
      color:#fff;
      padding:9px 18px;
      border-radius:999px;
      font-family:inherit;
      font-size:14px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      transition:transform .12s, box-shadow .12s, background .12s;
      box-shadow:0 10px 25px rgba(62,36,32,0.25);
    }
    .btn:hover{
      transform:translateY(-1px);
      box-shadow:0 14px 30px rgba(62,36,32,0.3);
      background:#2b1916;
    }
    .btn-outline{
      border-radius:999px;
      border:1px solid var(--brown);
      background:transparent;
      color:var(--brown);
      padding:9px 16px;
      font-size:14px;
      cursor:pointer;
      font-family:inherit;
      transition:background .12s,color .12s,border-color .12s;
    }
    .btn-outline:hover{
      background:rgba(62,36,32,0.06);
      border-color:var(--brown);
    }
    .btn:disabled,.btn-outline:disabled{
      opacity:.55;
      cursor:not-allowed;
      box-shadow:none;
      transform:none;
    }
    .muted{color:var(--muted);font-size:13px}
    .hint{color:var(--muted);font-size:12px;margin-top:4px}
    .ok{color:#047857;font-weight:700}
    .err{color:#b91c1c;font-weight:700}
    .logout{
      background:#fff;
      color:var(--brown);
      padding:6px 12px;
      border-radius:999px;
      border:0;
      cursor:pointer;
      font-size:13px;
      box-shadow:0 8px 20px rgba(0,0,0,0.15);
    }
    .badge{
      display:inline-block;
      padding:4px 9px;
      border-radius:999px;
      font-size:11px;
      background:rgba(188,143,116,.12);
      color:var(--brown);
      margin-inline-start:4px;
    }
    /* Tabs */
    .tabs{
      display:none;
      margin:10px 0 10px;
      background:rgba(255,255,255,0.6);
      border-radius:999px;
      padding:4px;
      box-shadow:0 8px 25px rgba(62,36,32,0.08);
      width:max-content;
    }
    .tab-btn{
      padding:6px 16px;
      border-radius:999px;
      border:0;
      background:transparent;
      color:var(--muted);
      font-size:13px;
      cursor:pointer;
      font-family:inherit;
      transition:background .15s,color .15s, box-shadow .15s;
    }
    .tab-btn.tab-active{
      background:var(--brown);
      color:#fff;
      box-shadow:0 10px 24px rgba(62,36,32,0.4);
    }
    .link-btn{
      border:0;
      background:none;
      color:#1d4ed8;
      text-decoration:underline;
      cursor:pointer;
      font-size:13px;
      font-family:inherit;
      padding:0;
    }
    /* ERP table */
    .erp-table-wrap{
      overflow-x:auto;
      margin-top:8px;
      border-radius:var(--radius-md);
      border:1px solid rgba(0,0,0,0.04);
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    thead{
      background:#f3f4f6;
    }
    th,td{
      padding:7px 10px;
      border-bottom:1px solid #e5e7eb;
      white-space:nowrap;
    }
    th{
      text-align:right;
      font-weight:600;
      color:#374151;
    }
    td{
      color:#111827;
    }
    tbody tr:nth-child(even){
      background:#fafafa;
    }
    /* stages */
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .stage{
      background:var(--cream-soft);
      border-radius:var(--radius-md);
      padding:10px 12px;
      border:1px dashed rgba(188,143,116,.55);
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .stage.done{
      background:#ecfdf5;
      border-style:solid;
      border-color:#22c55e;
    }
    .stage-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .stage strong{color:var(--brown);font-size:13px}
    .stage small{font-size:11px;color:var(--muted)}
    @media (max-width:900px){
      .row{grid-template-columns:1fr}
      .col-3,.col-4,.col-6,.col-12{grid-column:span 1}
      .grid-2{grid-template-columns:1fr}
      .topbar{flex-direction:column;align-items:flex-start;gap:6px}
      .tabs{width:100%;justify-content:space-between;}
      .tab-btn{flex:1;text-align:center;}
    }
  </style>
</style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-title">MZJ â€” Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</div>
    <div>
      <span id="whoami" class="hint"></span>
      <button id="logoutBtn" class="logout" style="display:none">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>

  <div class="wrap">
    <div class="card" id="authCard">
      <h3 class="title"><span class="icon">ğŸ”</span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
      <div class="row">
        <div class="col-4">
          <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
          <input id="email" type="email" placeholder="user@mzjcars.com" />
        </div>
        <div class="col-4">
          <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
          <input id="password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
        </div>
        <div class="col-4" style="display:flex;align-items:flex-end;gap:8px">
          <button class="btn" id="loginBtn">Ø¯Ø®ÙˆÙ„</button>
          <button class="btn-outline" id="signupBtn">ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
        </div>
      </div>
      <div id="authMsg" class="muted" style="margin-top:6px"></div>
      <div class="hint">Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø±Ø§Ø­Ù„.</div>

    </div>

    <div class="tabs" id="tabsBar">
      <button class="tab-btn tab-active" id="tabSearchBtn">Ø¨Ø­Ø« Ø¹Ù† Ø·Ù„Ø¨</button>
      <button class="tab-btn" id="tabListBtn">ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
    </div>

    <div class="card" id="orderCard" style="display:none">
      <h3 class="title"><span class="icon">ğŸ“„</span>Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø·Ù„Ø¨</h3>
      <div class="row">
        <div class="col-4">
          <label>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</label>
          <input id="orderId" placeholder="SAL-ORD-2025-01109_1 Ø£Ùˆ Ø¨Ø¯ÙˆÙ† _1" />
        </div>
        <div class="col-4">
          <label>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ (VIN)</label>
          <input id="vinInput" placeholder="11409 Ù…Ø«Ù„Ø§Ù‹" />
        </div>
        <div class="col-4" style="display:flex;align-items:flex-end;gap:8px">
          <button class="btn" id="loadBtn">ÙØªØ­ Ø§Ù„Ø·Ù„Ø¨</button>
          <button class="btn-outline" id="clearBtn">ØªÙØ±ÙŠØº</button>
        </div>
      </div>
      <div id="orderMsg" class="muted" style="margin-top:6px"></div>
      <div class="hint">ØªÙ‚Ø¯Ø± ØªØ¨Ø­Ø« ÙŠØ§ Ø¨Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ ÙŠØ§ Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ â€” ÙˆØ§Ø­Ø¯ Ù…Ù†Ù‡Ù… ÙŠÙƒÙÙŠ.</div>
    </div>

    <div class="card" id="erpCard" style="display:none">
      <h3 class="title"><span class="icon">ğŸ“Š</span>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (ERP)</h3>
      <div id="erpMeta" class="muted" style="margin-bottom:6px"></div>
      <div class="erp-table-wrap">
        <table>
          <thead>
            <tr>
              <th>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
              <th>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ Ù„Ù„Ø¹Ù…ÙŠÙ„</th>
              <th>Ø§Ù„ÙØ±Ø¹</th>
              <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨</th>
              <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…</th>
              <th>Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</th>
              <th>Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù</th>
              <th>Ù†ÙˆØ¹ Ø§Ù„ØµÙ†Ù</th>
              <th>ÙØ¦Ø© Ø§Ù„ØµÙ†Ù</th>
              <th>Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</th>
              <th>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ VIN</th>
              <th>Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ</th>
              <th>Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ</th>
              <th>Ø§Ù„ÙˆÙƒÙŠÙ„</th>
              <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
              <th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th>
              <th>Ù‚ÙŠÙ…Ø© Ø§Ù„ØµÙ†Ù</th>
              <th>ÙƒÙˆØ¯ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</th>
              <th>Ù†ÙˆØ¹ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</th>
              <th>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</th>
              <th>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</th>
              <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</th>
              <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</th>
            </tr>
          </thead>
          <tbody id="erpBody">
            <tr>
              <td data-field="CustomerName"></td>
              <td data-field="CustomerVAT"></td>
              <td data-field="Branch"></td>
              <td data-field="OrderDate"></td>
              <td data-field="DeliveryDate"></td>
              <td data-field="SalesPerson"></td>
              <td data-field="ItemNo"></td>
              <td data-field="ItemType"></td>
              <td data-field="ItemCategory"></td>
              <td data-field="ItemModel"></td>
              <td data-field="VIN"></td>
              <td data-field="InteriorColor"></td>
              <td data-field="ExteriorColor"></td>
              <td data-field="Dealer"></td>
              <td data-field="Qty"></td>
              <td data-field="UnitPrice"></td>
              <td data-field="ItemValue"></td>
              <td data-field="TaxCode"></td>
              <td data-field="taxName"></td>
              <td data-field="taxRate"></td>
              <td data-field="taxValue"></td>
              <td data-field="SubtotalExclVAT"></td>
              <td data-field="totalInclVAT"></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="card" id="ordersListCard" style="display:none">
      <h3 class="title"><span class="icon">ğŸ“‹</span>ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
      <div class="hint">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ù„Ù†Ø³Ø®Ù‡ ÙˆÙØªØ­Ù‡ ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰.</div>
      <div class="erp-table-wrap">
        <table>
          <thead>
            <tr>
              <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
              <th>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
              <th>Ø§Ù„ÙØ±Ø¹</th>
              <th>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ VIN</th>
              <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…</th>
              <th>Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ (Ø£Ø­Ø¯Ø« Ù…Ø±Ø­Ù„Ø©)</th>
            </tr>
          </thead>
          <tbody id="ordersListBody">
          </tbody>
        </table>
      </div>
    </div>

    <div class="card" id="stagesCard" style="display:none">
      <h3 class="title"><span class="icon">ğŸš¦</span>Ù…Ø±Ø§Ø­Ù„ Ø§Ù„ØªØªØ¨Ø¹</h3>
      <div class="grid-2" id="stagesList"></div>
      <div class="hint" style="margin-top:8px">
        Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ <strong>ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</strong> Ø£Ù…Ø§Ù… Ø£ÙŠ Ù…Ø±Ø­Ù„Ø© Ù„ÙŠØªÙ… Ø®ØªÙ…Ù‡Ø§ ÙˆØªØ¹ÙŠÙŠÙ†Ù‡Ø§ ÙƒØ¢Ø®Ø± Ù…Ø±Ø­Ù„Ø© Ù„Ù„Ø·Ù„Ø¨ Ù…Ø¹ Ù…Ø²Ø§Ù…Ù†ØªÙ‡Ø§ ÙÙˆØ±Ù‹Ø§ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„.
      </div>
      <div class="muted" id="stageMsg" style="margin-top:6px"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      updateDoc,
      serverTimestamp,
      collection,
      query,
      where,
      getDocs,
      limit
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCorGtT5_Z68jCtLODvqnv0Fb7QW5eR6MQ",
      authDomain: "mzj-tracking.firebaseapp.com",
      projectId: "mzj-tracking",
      storageBucket: "mzj-tracking.firebasestorage.app",
      messagingSenderId: "655452217491",
      appId: "1:655452217491:web:9348d172c47bdd411fad66"
    };

    const ERP_COLLECTION = "erp_orders";
    const TRACK_COLLECTION = "orders";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI refs
    const authCard   = document.getElementById("authCard");
    const orderCard  = document.getElementById("orderCard");
    const erpCard    = document.getElementById("erpCard");
    const stagesCard = document.getElementById("stagesCard");
    const tabsBar    = document.getElementById("tabsBar");
    const tabSearchBtn = document.getElementById("tabSearchBtn");
    const tabListBtn   = document.getElementById("tabListBtn");
    const ordersListCard = document.getElementById("ordersListCard");

    const whoami     = document.getElementById("whoami");
    const logoutBtn  = document.getElementById("logoutBtn");

    const email      = document.getElementById("email");
    const password   = document.getElementById("password");
    const loginBtn   = document.getElementById("loginBtn");
    const signupBtn  = document.getElementById("signupBtn");
    const authMsg    = document.getElementById("authMsg");

    const orderIdInput = document.getElementById("orderId");
    const vinInput     = document.getElementById("vinInput");
    const loadBtn      = document.getElementById("loadBtn");
    const clearBtn     = document.getElementById("clearBtn");
    const orderMsg     = document.getElementById("orderMsg");

    const erpMetaEl    = document.getElementById("erpMeta");
    const erpBody      = document.getElementById("erpBody");
    const ordersListBody = document.getElementById("ordersListBody");

    const stagesList   = document.getElementById("stagesList");
    const stageMsg     = document.getElementById("stageMsg");

    let currentOrderId = null;
    let currentVin     = null;

    const STAGES = [
      "1) Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨",
      "2) Ø£Ù…Ø± Ø§Ù„Ø¯ÙØ¹ (ØªØ­ÙˆÙŠÙ„/Ø´Ø¨ÙƒØ©/ÙƒØ§Ø´)",
      "3) ØªÙˆØ§ØµÙ„ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ + Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠØ©",
      "4) Ø³Ø¯Ø§Ø¯ Ø±Ø³ÙˆÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„",
      "5) Ø§Ù„ØªØ£Ù…ÙŠÙ† (Ø´Ø±Ø· Ø§Ù„Ø±Ø¨Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ³ØªÙ…)",
      "6) Ø§Ø³ØªÙŠÙØ§Ø¡ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ ÙˆØ§Ù„Ù…Ø¨Ø§Ù„Øº",
      "7) ØªØ¬ÙŠÙŠØ± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠØ©",
      "8) Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù„ÙˆØ­Ø§Øª Ø£Ùˆ Ù†Ù‚Ù„ Ø§Ù„Ù…Ù„ÙƒÙŠØ©",
      "9) Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ù„Ù„Ø§Ø³ØªÙ„Ø§Ù…/Ø·Ù„Ø¨ Ø§Ù„Ø´Ø­Ù†",
      "10) Ø¥ØªÙ…Ø§Ù… Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­"
    ];

    // ---- Auth ----
    loginBtn.onclick = async () => {
      authMsg.textContent = "";
      try {
        const emailVal = email.value.trim();
        const passVal  = password.value;
        if (!emailVal || !passVal) {
          authMsg.innerHTML = "<span class='err'>Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±.</span>";
          return;
        }
        await signInWithEmailAndPassword(auth, emailVal, passVal);
        authMsg.innerHTML = "<span class='ok'>ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­.</span>";
      } catch (err) {
        console.error(err);
        authMsg.innerHTML = "<span class='err'>ØªØ¹Ø°Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ùˆ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª.</span>";
      }
    };

    signupBtn.onclick = async () => {
      authMsg.textContent = "";
      try {
        const emailVal = email.value.trim();
        const passVal  = password.value;
        if (!emailVal || !passVal) {
          authMsg.innerHTML = "<span class='err'>Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨.</span>";
          return;
        }
        await createUserWithEmailAndPassword(auth, emailVal, passVal);
        authMsg.innerHTML = "<span class='ok'>ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.</span>";
      } catch (err) {
        console.error(err);
        authMsg.innerHTML = "<span class='err'>ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…. Ø±Ø¨Ù…Ø§ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©.</span>";
      }
    };

    logoutBtn.onclick = async () => {
      try { await signOut(auth); } catch (err) { console.error(err); }
    };

    onAuthStateChanged(auth, (user) => {
      if (user) {
        whoami.textContent = "Ù…Ø³Ø¬Ù‘Ù„: " + (user.email || "");
        logoutBtn.style.display = "";
        authCard.style.display  = "none";
        tabsBar.style.display   = "flex";
        orderCard.style.display = "";
        erpCard.style.display   = "none";
        ordersListCard.style.display = "none";
        stagesCard.style.display = "";
        tabSearchBtn.classList.add("tab-active");
        tabListBtn.classList.remove("tab-active");
      } else {
        whoami.textContent = "";
        logoutBtn.style.display = "none";
        authCard.style.display  = "";
        tabsBar.style.display   = "none";
        orderCard.style.display = "none";
        erpCard.style.display   = "none";
        ordersListCard.style.display = "none";
        stagesCard.style.display = "none";
      }
    });

    // ---- helpers ----
    function clearErpTable() {
      erpMetaEl.textContent = "";
      erpBody.querySelectorAll("td").forEach(td => td.textContent = "");
    }

    const FIELD_SYNONYMS = {
      CustomerName: ["customerName","CustomerName"],
      CustomerVAT:  ["customerVat","CustomerVAT","customerVAT"],
      Branch:       ["branch","Branch"],
      OrderDate:    ["orderDate","OrderDate"],
      DeliveryDate: ["deliveryDate","DeliveryDate"],
      SalesPerson:  ["salesPerson","SalesPerson"],
      ItemNo:       ["itemNo","ItemNo","no"],
      ItemType:     ["itemType","ItemType","type"],
      ItemCategory: ["itemCategory","ItemCategory","category"],
      ItemModel:    ["itemModel","ItemModel","model"],
      VIN:          ["VIN","vin","item.vin"],
      InteriorColor:["interiorColor","InteriorColor"],
      ExteriorColor:["exteriorColor","ExteriorColor"],
      Dealer:       ["dealer","Dealer"],
      Qty:          ["qty","Qty"],
      UnitPrice:    ["unitPrice","UnitPrice"],
      ItemValue:    ["ItemValue","itemValue","value"],
      TaxCode:      ["taxCode","TaxCode"],
      TaxName:      ["taxName","TaxName"],
      TaxRate:      ["taxRate","TaxRate"],
      TaxValue:     ["taxValue","TaxValue"],
      SubtotalExclVAT:["subtotalExclVat","SubtotalExclVAT","value"], // value ÙƒØ§Ø­ØªÙŠØ§Ø·
      TotalInclVAT: ["totalInclVat","TotalInclVAT"]
    };

    function getFromPath(obj, path) {
      return path.split(".").reduce((acc, key) => (acc && acc[key] !== undefined ? acc[key] : undefined), obj);
    }

    function getFieldFlex(data, fieldKey) {
      const syns = FIELD_SYNONYMS[fieldKey] || [fieldKey];
      for (const key of syns) {
        let val;
        if (key.includes(".")) {
          val = getFromPath(data, key);
        } else {
          if (data[key] !== undefined) return data[key];
          if (data.item && data.item[key] !== undefined) return data.item[key];
          continue;
        }
        if (val !== undefined) return val;
      }
      return undefined;
    }

    function fillErpTable(data) {
      if (!data) {
        erpCard.style.display = "none";
        clearErpTable();
        return;
      }
      erpCard.style.display = "";
      clearErpTable();

      erpBody.querySelectorAll("td").forEach(td => {
        const key = td.dataset.field;
        const val = getFieldFlex(data, key);
        td.textContent = (val !== undefined && val !== null && val !== "") ? val : "â€”";
      });

      const orderNo = data.orderNo || data.OrderNo || currentOrderId || "";
      const vin     = getFieldFlex(data, "VIN") || currentVin || "";

      erpMetaEl.innerHTML =
        "<span class='badge'>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: " + (orderNo || "ØºÙŠØ± Ù…ØªÙˆÙØ±") + "</span>" +
        "<span class='badge'>VIN: " + (vin || "ØºÙŠØ± Ù…ØªÙˆÙØ±") + "</span>";
    }

    // ---- stages ----
    function buildStagesUI(orderData = {}) {
      stagesList.innerHTML = "";
      const stagesObj = orderData.stages || {};
      const current   = orderData.currentStage || 0;

      STAGES.forEach((label, idx) => {
        const stageNumber = idx + 1;
        const key  = "s" + stageNumber;
        const ts   = stagesObj[key];
        const tsStr = ts
          ? new Date(ts.toDate ? ts.toDate() : ts).toLocaleString("ar-SA")
          : null;

        const wrapper = document.createElement("div");
        wrapper.className = "stage";
        if (tsStr) wrapper.classList.add("done");

        const header = document.createElement("div");
        header.className = "stage-header";

        const titleEl = document.createElement("div");
        titleEl.innerHTML = "<strong>" + label + "</strong>";

        const metaEl = document.createElement("div");
        metaEl.innerHTML = tsStr
          ? "<small>ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡: " + tsStr + "</small>"
          : "<small>Ù„Ù… ØªÙÙ†ÙÙ‘Ø° Ø¨Ø¹Ø¯</small>";

        header.appendChild(titleEl);
        header.appendChild(metaEl);

        const actions = document.createElement("div");
        const btn = document.createElement("button");
        btn.className = "btn-outline";
        btn.textContent = "ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡";
        btn.style.fontSize = "12px";
        btn.onclick = () => completeStage(stageNumber);
        actions.appendChild(btn);

        wrapper.appendChild(header);
        wrapper.appendChild(actions);

        if (current === stageNumber) {
          const badge = document.createElement("div");
          badge.className = "hint";
          badge.textContent = "Ù‡Ø°Ù‡ Ù‡ÙŠ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„Ø·Ù„Ø¨.";
          wrapper.appendChild(badge);
        }

        stagesList.appendChild(wrapper);
      });
    }

    async function completeStage(stageNumber) {
      stageMsg.textContent = "";
      if (!currentOrderId) {
        stageMsg.innerHTML = "<span class='err'>Ø§ÙØªØ­ Ø·Ù„Ø¨ Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø±Ø§Ø­Ù„.</span>";
        return;
      }
      try {
        const orderRef = doc(db, TRACK_COLLECTION, currentOrderId);
        await updateDoc(orderRef, {
          currentStage: stageNumber,
          ["stages.s" + stageNumber]: serverTimestamp()
        }).catch(async () => {
          await setDoc(orderRef, {
            orderId: currentOrderId,
            vin: currentVin || "",
            currentStage: stageNumber,
            ["stages.s" + stageNumber]: serverTimestamp()
          }, { merge: true });
        });

        const publicRef = doc(db, TRACK_COLLECTION, currentOrderId, "public", "status");
        await setDoc(publicRef, {
          orderId: currentOrderId,
          vin: currentVin || "",
          currentStage: stageNumber,
          ["stages.s" + stageNumber]: serverTimestamp(),
          updatedAt: serverTimestamp()
        }, { merge: true });

        const snap = await getDoc(orderRef);
        const data = snap.exists() ? snap.data() : {};
        buildStagesUI(data);

        stageMsg.innerHTML = "<span class='ok'>ØªÙ… Ø®ØªÙ… Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø±Ù‚Ù… " + stageNumber + " ÙˆØªØ­Ø¯ÙŠØ« ØµÙØ­Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„.</span>";
      } catch (err) {
        console.error(err);
        stageMsg.innerHTML = "<span class='err'>Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø±Ø­Ù„Ø©.</span>";
      }
    }

    // ---- find by VIN with multiple patterns ----
    async function findErpDocByVin(vinRaw) {
      const vinStr = vinRaw.trim();
      if (!vinStr) return null;
      const candidates = [];
      const isNumber = /^\d+$/.test(vinStr);
      // string patterns
      ["vin","VIN","item.vin"].forEach(field => {
        candidates.push([field, vinStr]);
      });
      if (isNumber) {
        const vinNum = Number(vinStr);
        ["vin","VIN","item.vin"].forEach(field => {
          candidates.push([field, vinNum]);
        });
      }
      for (const [field, value] of candidates) {
        try {
          const q = query(collection(db, ERP_COLLECTION), where(field, "==", value));
          const snap = await getDocs(q);
          if (!snap.empty) return snap.docs[0];
        } catch (err) {
          console.error("VIN query error on field", field, err);
        }
      }
      return null;
    }

    // ---- load order ----
    async function loadOrder() {
      orderMsg.textContent = "";
      stageMsg.textContent = "";
      clearErpTable();
      currentOrderId = null;
      currentVin     = null;

      const idRaw  = orderIdInput.value.trim();
      const vinRaw = vinInput.value.trim();

      if (!idRaw && !vinRaw) {
        orderMsg.innerHTML = "<span class='err'>Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„.</span>";
        erpCard.style.display = "none";
        buildStagesUI({});
        return;
      }

      try {
        let erpSnap = null;
        let erpData = null;
        let erpDocId = null;

        // 1) Ù„Ùˆ ÙƒØªØ¨ ID ÙƒØ§Ù…Ù„
        if (idRaw) {
          const directRef = doc(db, ERP_COLLECTION, idRaw);
          const directSnap = await getDoc(directRef);
          if (directSnap.exists()) {
            erpSnap = directSnap;
            erpData = directSnap.data();
            erpDocId = directSnap.id;
          }
        }

        // 2) Ù„Ùˆ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ØŒ Ø¬Ø±Ù‘Ø¨ OrderNo Ø¨Ø¯ÙˆÙ† _1
        let orderNoBase = idRaw;
        if (orderNoBase && orderNoBase.includes("_")) {
          orderNoBase = orderNoBase.split("_")[0];
        }
        if (!erpData && orderNoBase) {
          const q = query(collection(db, ERP_COLLECTION), where("orderNo", "==", orderNoBase));
          const qsnap = await getDocs(q);
          if (!qsnap.empty) {
            erpSnap = qsnap.docs[0];
            erpData = erpSnap.data();
            erpDocId = erpSnap.id;
          }
        }

        // 3) Ù„Ùˆ Ù…ÙÙŠØ´ Ø±Ù‚Ù… Ø·Ù„Ø¨ Ø£Ùˆ Ù„Ø³Ù‡ Ù…Ø´ Ù„Ø§Ù‚ÙŠÙŠÙ†ØŒ Ø¬Ø±Ù‘Ø¨ VIN
        if (!erpData && vinRaw) {
          const vinDoc = await findErpDocByVin(vinRaw);
          if (vinDoc) {
            erpSnap = vinDoc;
            erpData = vinDoc.data();
            erpDocId = vinDoc.id;
          }
        }

        if (!erpData) {
          orderMsg.innerHTML = "<span class='err'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨ Ù…Ø·Ø§Ø¨Ù‚ ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª ERP.</span>";
          erpCard.style.display = "none";
          buildStagesUI({});
          return;
        }

        // Ø§Ø³ØªÙ†ØªØ§Ø¬ orderId Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ùˆ VIN
        const detectedOrderNo = erpData.orderNo || erpData.OrderNo || erpDocId || idRaw;
        const finalOrderId = detectedOrderNo;
        const finalVin = getFieldFlex(erpData, "VIN") || vinRaw || "";

        currentOrderId = finalOrderId;
        currentVin     = finalVin;

        orderIdInput.value = finalOrderId;
        vinInput.value     = finalVin;

        fillErpTable(erpData);

        // ØªØ¬Ù‡ÙŠØ² ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„ØªØªØ¨Ø¹
        const trackRef = doc(db, TRACK_COLLECTION, finalOrderId);
        const trackSnap = await getDoc(trackRef);
        let trackData = {};
        if (trackSnap.exists()) {
          trackData = trackSnap.data();
        } else {
          trackData = {
            orderId: finalOrderId,
            vin: finalVin || "",
            currentStage: 0,
            stages: {}
          };
          await setDoc(trackRef, trackData, { merge: true });
          const publicRef = doc(db, TRACK_COLLECTION, finalOrderId, "public", "status");
          await setDoc(publicRef, {
            orderId: finalOrderId,
            vin: finalVin || "",
            currentStage: 0,
            stages: {},
            updatedAt: serverTimestamp()
          }, { merge: true });
        }

        buildStagesUI(trackData);
        erpCard.style.display = "";
        stagesCard.style.display = "";

        orderMsg.innerHTML = "<span class='ok'>ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ Ù…Ù† Ù†Ø¸Ø§Ù… ERP ÙˆØ±Ø¨Ø·Ù‡ Ø¨Ø§Ù„ØªØªØ¨Ø¹.</span>";
      } catch (err) {
        console.error(err);
        orderMsg.innerHTML = "<span class='err'>Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨.</span>";
        erpCard.style.display = "none";
        buildStagesUI({});
      }
    }

    loadBtn.onclick = loadOrder;

    clearBtn.onclick = () => {
      orderIdInput.value = "";
      vinInput.value = "";
      orderMsg.textContent = "";
      stageMsg.textContent = "";
      currentOrderId = null;
      currentVin = null;
      clearErpTable();
      erpCard.style.display = "none";
      buildStagesUI({});
    };


    // ---- orders list (tab) ----
    async function loadOrdersList() {
      ordersListBody.innerHTML = "<tr><td class='muted' colspan='6'>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</td></tr>";
      try {
        const q = query(collection(db, ERP_COLLECTION), limit(100));
        const snap = await getDocs(q);
        if (snap.empty) {
          ordersListBody.innerHTML = "<tr><td class='muted' colspan='6'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</td></tr>";
          return;
        }
        const rows = [];
        for (const docSnap of snap.docs) {
          const d = docSnap.data();
          const orderNo = d.orderNo || d.OrderNo || docSnap.id;
          const vinVal  = getFieldFlex(d, "VIN") || "";
          const customerName = getFieldFlex(d, "CustomerName") || "";
          const branch = getFieldFlex(d, "Branch") || "";
          const deliveryDate = getFieldFlex(d, "DeliveryDate") || "";
          let statusLabel = "Ù„Ù… ÙŠØ¨Ø¯Ø£";
          try {
            const tSnap = await getDoc(doc(db, TRACK_COLLECTION, orderNo));
            if (tSnap.exists()) {
              const t = tSnap.data();
              const currentStage = t.currentStage || 0;
              if (currentStage > 0 && currentStage <= STAGES.length) {
                statusLabel = STAGES[currentStage - 1];
              }
            }
          } catch (e) {
            console.error("track read error", e);
          }
          rows.push({ orderNo, vinVal, customerName, branch, deliveryDate, statusLabel });
        }
        ordersListBody.innerHTML = "";
        rows.forEach(r => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><button class="link-btn" data-order="${r.orderNo}">${r.orderNo}</button></td>
            <td>${r.customerName || "â€”"}</td>
            <td>${r.branch || "â€”"}</td>
            <td>${r.vinVal || "â€”"}</td>
            <td>${r.deliveryDate || "â€”"}</td>
            <td>${r.statusLabel || "â€”"}</td>
          `;
          ordersListBody.appendChild(tr);
        });
      } catch (err) {
        console.error(err);
        ordersListBody.innerHTML = "<tr><td class='err' colspan='6'>ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª.</td></tr>";
      }
    }

    function activateTab(which) {
      if (which === "list") {
        orderCard.style.display = "none";
        erpCard.style.display   = "none";
        stagesCard.style.display = "none";
        ordersListCard.style.display = "";
        tabSearchBtn.classList.remove("tab-active");
        tabListBtn.classList.add("tab-active");
        loadOrdersList();
      } else {
        orderCard.style.display = "";
        erpCard.style.display   = currentOrderId ? "" : "none";
        stagesCard.style.display = "";
        ordersListCard.style.display = "none";
        tabSearchBtn.classList.add("tab-active");
        tabListBtn.classList.remove("tab-active");
      }
    }

    tabSearchBtn.addEventListener("click", () => activateTab("search"));
    tabListBtn.addEventListener("click", () => activateTab("list"));

    ordersListBody.addEventListener("click", async (e) => {
      const btn = e.target.closest("button.link-btn");
      if (!btn) return;
      const ord = btn.dataset.order;
      try {
        await navigator.clipboard.writeText(ord);
      } catch (e2) {
        console.warn("clipboard error", e2);
      }
      orderIdInput.value = ord;
      vinInput.value = "";
      activateTab("search");
      loadOrder();
    });
    clearErpTable();
    buildStagesUI({});
  </script>
</body>
</html>








