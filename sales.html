<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MZJ â€“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet" />
  <style>
    :root{
      --brown:#3e2420;
      --beige:#bc8f74;
      --cream:#fff8ef;
      --text:#111827;
      --muted:#6b7280;
      --radius:16px;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:"Tajawal",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#fffdf8 0,#fff3e6 40%,#fbe9da 70%,#f5e3d3 100%);
      color:var(--text);
    }
    .topbar{
      background:var(--brown);
      color:#fff;
      padding:10px 20px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      box-shadow:0 6px 14px rgba(0,0,0,.2);
    }
    .topbar-title{
      font-weight:800;
      letter-spacing:.6px;
      font-size:17px;
    }
    .topbar-right{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:13px;
    }
    .logout{
      border:0;
      padding:6px 12px;
      border-radius:999px;
      background:#fff;
      color:var(--brown);
      cursor:pointer;
      font-family:inherit;
      font-size:12px;
    }
    .wrap{
      max-width:1150px;
      margin:22px auto 36px;
      padding:0 14px;
    }
    .card{
      background:#fff;
      border-radius:var(--radius);
      box-shadow:0 16px 40px rgba(62,36,32,.13);
      padding:18px 18px 20px;
      margin-bottom:18px;
    }
    .title{
      margin:0 0 12px 0;
      display:flex;
      align-items:center;
      gap:8px;
      color:var(--brown);
      font-size:18px;
    }
    .title .icon{
      width:26px;
      height:26px;
      border-radius:999px;
      background:rgba(188,143,116,.16);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:16px;
    }
    .row{
      display:grid;
      grid-template-columns:repeat(12,1fr);
      gap:10px;
    }
    .col-3{grid-column:span 3;}
    .col-4{grid-column:span 4;}
    .col-6{grid-column:span 6;}
    .col-12{grid-column:span 12;}
    label{
      display:block;
      font-size:13px;
      margin-bottom:4px;
      color:var(--muted);
    }
    input{
      width:100%;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      font-family:inherit;
      font-size:14px;
      outline:none;
    }
    input:focus{
      background:#fff;
      border-color:var(--beige);
      box-shadow:0 0 0 1px rgba(188,143,116,.45);
    }
    select{
      width:100%;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      font-family:inherit;
      font-size:14px;
      outline:none;
      appearance:none;
    }
    select:focus{
      background:#fff;
      border-color:var(--beige);
      box-shadow:0 0 0 1px rgba(188,143,116,.45);
    }
    .btn{
      border:0;
      border-radius:999px;
      padding:8px 16px;
      font-family:inherit;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:14px;
      background:var(--brown);
      color:#fff;
    }
    .btn-outline{
      border-radius:999px;
      border:1px solid var(--brown);
      padding:8px 14px;
      font-family:inherit;
      cursor:pointer;
      background:transparent;
      color:var(--brown);
      font-size:13px;
    }
    .btn:disabled,.btn-outline:disabled{
      opacity:.5;
      cursor:not-allowed;
    }
    .muted{color:var(--muted);font-size:13px;}
    .hint{color:var(--muted);font-size:12px;margin-top:4px;}
    .ok{color:#047857;font-weight:700;}
    .err{color:#b91c1c;font-weight:700;}
    .badge{
      display:inline-block;
      padding:3px 9px;
      border-radius:999px;
      background:rgba(188,143,116,.16);
      color:var(--brown);
      font-size:11px;
      margin-left:4px;
    }
    .erp-table-wrap{
      margin-top:8px;
      overflow-x:auto;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    thead{
      background:#f3f4f6;
    }
    th,td{
      padding:6px 8px;
      border-bottom:1px solid #e5e7eb;
      white-space:nowrap;
    }
    th{font-weight:600;color:#374151;text-align:right;}
    td{color:#111827;}
    .grid-2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    .stage{
      background:#fffaf3;
      border-radius:12px;
      padding:10px 12px;
      border:1px dashed rgba(188,143,116,.55);
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .stage.done{
      background:#ecfdf5;
      border-style:solid;
      border-color:#22c55e;
    }
    .stage-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .stage strong{color:var(--brown);font-size:13px;}
    .stage small{font-size:11px;color:var(--muted);}

    .tabs{
      display:none;
      margin:-8px 0 10px;
      gap:8px;
    }
    .tab-btn{
      padding:6px 14px;
      border-radius:999px;
      border:1px solid transparent;
      background:#f3f4f6;
      color:#374151;
      font-size:13px;
      cursor:pointer;
      font-family:inherit;
    }
    .tab-btn.tab-active{
      background:var(--brown);
      color:#fff;
      border-color:var(--brown);
    }
    .link-btn{
      border:0;
      background:none;
      color:#1d4ed8;
      text-decoration:underline;
      cursor:pointer;
      font-size:13px;
      font-family:inherit;
      padding:0;
    }

    .totals-box{
      margin:6px 0 10px;
      padding:8px 10px;
      border-radius:10px;
      background:#fffaf3;
      border:1px solid rgba(188,143,116,.4);
      font-size:13px;
      color:var(--brown);
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }
    .totals-box span{
      white-space:nowrap;
    }

    /* VIN picker box Ø§Ø­ØªØ±Ø§ÙÙŠ */
    .vin-box{
      display:none;
      margin:10px 0 14px;
      padding:10px 12px;
      border-radius:12px;
      background:#fffaf3;
      border:1px solid rgba(188,143,116,.6);
    }
    .vin-box-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:6px;
    }
    .vin-box-title{
      font-size:13px;
      font-weight:600;
      color:var(--brown);
    }
    .vin-chip{
      padding:3px 10px;
      border-radius:999px;
      background:rgba(62,36,32,.06);
      font-size:11px;
      color:var(--muted);
    }

    @media(max-width:900px){
      .row{grid-template-columns:1fr;}
      .col-3,.col-4,.col-6,.col-12{grid-column:span 1;}
      .grid-2{grid-template-columns:1fr;}
      .topbar{flex-direction:column;align-items:flex-start;gap:6px;}
      .tabs{flex-wrap:wrap;}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-title">MZJ â€“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØªØªØ¨Ø¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
    <div class="topbar-right">
      <span id="whoami"></span>
      <button id="logoutBtn" class="logout" style="display:none;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>

  <div class="wrap">

    <!-- Auth -->
    <div class="card" id="authCard">
      <h3 class="title"><span class="icon">ğŸ”</span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
      <div class="row">
        <div class="col-4">
          <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
          <input id="email" type="email" placeholder="user@mzjcars.com" />
        </div>
        <div class="col-4">
          <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
          <input id="password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
        </div>
        <div class="col-4" style="display:flex;align-items:flex-end;gap:8px;">
          <button class="btn" id="loginBtn">Ø¯Ø®ÙˆÙ„</button>
          <button class="btn-outline" id="signupBtn">ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
        </div>
      </div>
      <div id="authMsg" class="muted" style="margin-top:6px;"></div>
      <div class="hint">Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØªØ­Ø¯ÙŠØ« Ù…Ø±Ø§Ø­Ù„Ù‡Ø§.</div>
    </div>

    <!-- Search -->
    <div class="card" id="orderCard" style="display:none;">
      <h3 class="title"><span class="icon">ğŸ“„</span>Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø·Ù„Ø¨</h3>
      <div class="row">
        <div class="col-4">
          <label>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</label>
          <input id="orderId" placeholder="SAL-ORD-2025-01109 Ø£Ùˆ SAL-ORD-2025-01109_1" />
        </div>
        <div class="col-4" style="display:none;">
          <label>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ (VIN)</label>
          <input id="vinInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ (VIN)" />
        </div>
        <div class="col-4" style="display:flex;align-items:flex-end;gap:8px;">
          <button class="btn" id="loadBtn">ÙØªØ­ Ø§Ù„Ø·Ù„Ø¨</button>
          <button class="btn-outline" id="clearBtn">ØªÙØ±ÙŠØº</button>
        </div>
      </div>
      <div id="orderMsg" class="muted" style="margin-top:6px;"></div>
      <div class="hint">Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ø«Ù… Ø§Ø¶ØºØ· ÙØªØ­ Ø§Ù„Ø·Ù„Ø¨.</div>
    </div>

    <!-- Tabs -->
    <div class="tabs" id="tabsBar">
      <button class="tab-btn tab-active" id="tabSearchBtn">Ø¨Ø­Ø« Ø¹Ù† Ø·Ù„Ø¨</button>
      <button class="tab-btn" id="tabListBtn">ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
    </div>

    <!-- ERP details -->
    <div class="card" id="erpCard" style="display:none;">
      <h3 class="title">
        <span class="icon">ğŸ“Š</span>
        ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (ERP)
      </h3>
      <div id="erpMeta" class="muted" style="margin-bottom:6px;"></div>

      <!-- Ø§Ø®ØªÙŠØ§Ø± Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ Ù„Ùˆ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠÙ‡ Ø£ÙƒØ«Ø± Ù…Ù† VIN -->
      <div id="vinPickerBox" class="vin-box">
        <div class="vin-box-header">
          <div class="vin-box-title">Ø§Ø®ØªØ± Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ Ù„Ù„Ø¹Ù…Ù„ Ø¹Ù„ÙŠÙ‡</div>
          <div class="vin-chip" id="vinCountChip"></div>
        </div>
        <select id="vinPicker"></select>
        <div class="hint">Ø£ÙŠ ØªØ­Ø¯ÙŠØ« ÙÙŠ Ù…Ø±Ø§Ø­Ù„ ØªØªØ¨Ø¹ Ø§Ù„Ø·Ù„Ø¨ Ø³ÙŠÙƒÙˆÙ† Ù„Ù‡Ø°Ø§ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ ÙÙ‚Ø·.</div>
      </div>

      <div id="erpTotals" class="totals-box" style="display:none;"></div>
      <div class="erp-table-wrap">
        <table>
          <thead>
          <tr>
            <th>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
            <th>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ Ù„Ù„Ø¹Ù…ÙŠÙ„</th>
            <th>Ø§Ù„ÙØ±Ø¹</th>
            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨</th>
            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…</th>
            <th>Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</th>
            <th>Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù</th>
            <th>Ù†ÙˆØ¹ Ø§Ù„ØµÙ†Ù</th>
            <th>ÙØ¦Ø© Ø§Ù„ØµÙ†Ù</th>
            <th>Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</th>
            <th>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ VIN</th>
            <th>Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ</th>
            <th>Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ</th>
            <th>Ø§Ù„ÙˆÙƒÙŠÙ„</th>
            <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
            <th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th>
            <th>Ù‚ÙŠÙ…Ø© Ø§Ù„ØµÙ†Ù</th>
            <th>ÙƒÙˆØ¯ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</th>
            <th>Ù†ÙˆØ¹ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</th>
            <th>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</th>
            <th>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</th>
            <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</th>
            <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</th>
          </tr>
          </thead>
          <tbody id="erpBody">
          </tbody>
        </table>
      </div>
    </div>

    <!-- Orders list tab -->
    <div class="card" id="ordersListCard" style="display:none;">
      <h3 class="title"><span class="icon">ğŸ“‹</span>ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
      <div class="hint">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ù„ÙØªØ­Ù‡ØŒ ÙˆØ§Ø®ØªÙŠØ§Ø± Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ùˆ ÙƒØ§Ù† Ø£ÙƒØ«Ø± Ù…Ù† Ø³ÙŠØ§Ø±Ø©.</div>
      <div class="erp-table-wrap">
        <table>
          <thead>
          <tr>
            <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
            <th>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
            <th>Ø§Ù„ÙØ±Ø¹</th>
            <th>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ VIN</th>
            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…</th>
            <th>Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ (Ø¢Ø®Ø± Ù…Ø±Ø­Ù„Ø©)</th>
          </tr>
          </thead>
          <tbody id="ordersListBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Stages -->
    <div class="card" id="stagesCard" style="display:none;">
      <h3 class="title"><span class="icon">ğŸš¦</span>Ù…Ø±Ø§Ø­Ù„ ØªØªØ¨Ø¹ Ø§Ù„Ø·Ù„Ø¨</h3>
      <div class="grid-2" id="stagesList"></div>
      <div class="hint" style="margin-top:8px;">
        Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ <strong>ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</strong> Ø£Ù…Ø§Ù… Ø£ÙŠ Ù…Ø±Ø­Ù„Ø© Ù„ÙŠØªÙ… Ø®ØªÙ…Ù‡Ø§ ÙˆØªØ­Ø¯ÙŠØ« ØµÙØ­Ø© ØªØªØ¨Ø¹ Ø§Ù„Ø¹Ù…ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.  
        ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø²Ø± <strong>ØªØ±Ø§Ø¬Ø¹</strong> Ù„Ø¥Ù„ØºØ§Ø¡ Ø£ÙŠ Ù…Ø±Ø­Ù„Ø© Ø«Ù… Ø¥Ø¹Ø§Ø¯Ø© ØªÙ†ÙÙŠØ°Ù‡Ø§ Ù…ØªÙ‰ Ø§Ø­ØªØ¬Øª.
      </div>
      <div class="muted" id="stageMsg" style="margin-top:6px;"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      updateDoc,
      serverTimestamp,
      collection,
      query,
      where,
      getDocs,
      limit
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCorGtT5_Z68jCtLODvqnv0Fb7QW5eR6MQ",
      authDomain: "mzj-tracking.firebaseapp.com",
      projectId: "mzj-tracking",
      storageBucket: "mzj-tracking.firebasestorage.app",
      messagingSenderId: "655452217491",
      appId: "1:655452217491:web:9348d172c47bdd411fad66"
    };

    const ERP_COLLECTION      = "erp_orders";
    const ERP_VINS_COLLECTION = "erp_vins";
    const TRACK_COLLECTION    = "orders";

    const ERP_FIELDS = [
      "CustomerName","CustomerVAT","Branch","OrderDate","DeliveryDate","SalesPerson",
      "ItemNo","ItemType","ItemCategory","ItemModel","VIN","InteriorColor","ExteriorColor","Dealer",
      "Qty","UnitPrice","ItemValue","TaxCode","TaxName","TaxRate","TaxValue","SubtotalExclVAT","TotalInclVAT"
    ];

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI refs
    const authCard   = document.getElementById("authCard");
    const orderCard  = document.getElementById("orderCard");
    const erpCard    = document.getElementById("erpCard");
    const stagesCard = document.getElementById("stagesCard");
    const whoami     = document.getElementById("whoami");
    const logoutBtn  = document.getElementById("logoutBtn");

    const tabsBar      = document.getElementById("tabsBar");
    const tabSearchBtn = document.getElementById("tabSearchBtn");
    const tabListBtn   = document.getElementById("tabListBtn");
    const ordersListCard  = document.getElementById("ordersListCard");
    const ordersListBody  = document.getElementById("ordersListBody");

    const email      = document.getElementById("email");
    const password   = document.getElementById("password");
    const loginBtn   = document.getElementById("loginBtn");
    const signupBtn  = document.getElementById("signupBtn");
    const authMsg    = document.getElementById("authMsg");

    const orderIdInput = document.getElementById("orderId");
    const vinInput     = document.getElementById("vinInput");
    const loadBtn      = document.getElementById("loadBtn");
    const clearBtn     = document.getElementById("clearBtn");
    const orderMsg     = document.getElementById("orderMsg");

    const erpMetaEl    = document.getElementById("erpMeta");
    const erpBody      = document.getElementById("erpBody");
    const erpTotals    = document.getElementById("erpTotals");

    const vinPickerBox = document.getElementById("vinPickerBox");
    const vinPicker    = document.getElementById("vinPicker");
    const vinCountChip = document.getElementById("vinCountChip");

    const stagesList   = document.getElementById("stagesList");
    const stageMsg     = document.getElementById("stageMsg");

    let currentOrderId      = null;
    let currentVin          = null;
    let currentItemNo       = null;
    let currentOrderRecords = [];

    // âœ… Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª
    const STAGES = [
      "1) Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
      "2) Ø¥ÙŠØµØ§Ù„ Ø§Ù„Ø¯ÙØ¹ â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
      "3) Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ù† Ù‚ÙØ¨Ù„ Ù…Ù…Ø«Ù„ÙŠ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø¨Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¬Ø±ÙƒÙŠØ© â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø¹Ø±Ø¶)",
      "4) Ø³Ø¯Ø§Ø¯ Ø±Ø³ÙˆÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
      "5) Ø§Ù„ØªØ£Ù…ÙŠÙ† â€“ Ø´Ø±Ø· Ø§Ù„Ø±Ø¨Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ³ØªÙ… â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
      "6) Ø¥Ø³ØªÙŠÙØ§Ø¡ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
      "7) Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù„ÙˆØ­Ø§Øª Ø£Ùˆ Ù†Ù‚Ù„ Ø§Ù„Ù…Ù„ÙƒÙŠØ© â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø¹Ø±Ø¶)",
      "8) Ø¥Ø³ØªÙŠÙØ§Ø¡ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
      "9) Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ù„Ù„Ø¥Ø³ØªÙ„Ø§Ù… â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø¹Ø±Ø¶)",
      "10) Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­"
    ];

    const FIELD_SYNONYMS = {
      CustomerName: ["CustomerName","customerName"],
      CustomerVAT:  ["CustomerVAT","customerVat","customerVAT"],
      Branch:       ["Branch","branch"],
      OrderDate:    ["OrderDate","orderDate"],
      DeliveryDate: ["DeliveryDate","deliveryDate"],
      SalesPerson:  ["SalesPerson","salesPerson"],

      ItemNo:       ["ItemNo","itemNo","no"],
      ItemType:     ["ItemType","itemType","type"],
      ItemCategory: ["ItemCategory","itemCategory","category"],
      ItemModel:    ["ItemModel","itemModel","model"],

      VIN:          ["VIN","vin"],

      InteriorColor:["InteriorColor","interiorColor"],
      ExteriorColor:["ExteriorColor","exteriorColor"],
      Dealer:       ["Dealer","dealer"],

      Qty:          ["Qty","qty"],
      UnitPrice:    ["UnitPrice","unitPrice"],
      ItemValue:    ["ItemValue","itemValue","value"],

      TaxCode:         ["taxCode","TaxCode"],
      TaxName:         ["taxName","TaxName"],
      TaxRate:         ["taxRate","TaxRate"],
      TaxValue:        ["taxValue","TaxValue"],
      SubtotalExclVAT: ["subtotalExclVAT","SubtotalExclVAT","subtotalExclVat"],
      TotalInclVAT:    ["totalInclVAT","TotalInclVAT","totalInclVat"]
    };

    function buildCandidates(name) {
      const syns = FIELD_SYNONYMS[name] || [name];
      const arr = [];
      syns.forEach(s => {
        if (!s) return;
        arr.push(s);
        arr.push(s.toLowerCase());
        arr.push(s.toUpperCase());
      });
      return Array.from(new Set(arr));
    }

    function lookupIn(obj, candidates) {
      if (!obj) return undefined;
      for (const key of candidates) {
        if (Object.prototype.hasOwnProperty.call(obj, key) && obj[key] !== undefined) {
          return obj[key];
        }
      }
      return undefined;
    }

    function getFieldFlex(fieldName, data) {
      if (!data) return "-";
      const candidates = buildCandidates(fieldName);

      let v = lookupIn(data, candidates);
      if (v !== undefined) return v;

      v = lookupIn(data.item, candidates);
      if (v !== undefined) return v;

      v = lookupIn(data.totals, candidates);
      if (v !== undefined) return v;

      return "-";
    }

    function parseAmountFront(value) {
      if (value === null || value === undefined || value === "-") return null;
      if (typeof value === "number") return value;
      const s = String(value)
        .replace(/[^\d.,\-]/g, "")
        .replace(/,/g, "");
      const n = parseFloat(s);
      return isNaN(n) ? null : n;
    }

    function clearErpTable() {
      erpMetaEl.textContent = "";
      erpBody.innerHTML = "";
      erpTotals.style.display = "none";
      erpTotals.innerHTML = "";
      vinPickerBox.style.display = "none";
      vinPicker.innerHTML = "";
      vinCountChip.textContent = "";
    }

    function resolveItemNoForVin(vin, records){
      if (!records || !records.length) return 1;
      let itemNo = null;

      if (vin) {
        const matched = records.find(r => {
          const v = (getFieldFlex("VIN", r) || "").toString().trim();
          return v && v === vin.toString().trim();
        });
        if (matched) {
          itemNo = getFieldFlex("ItemNo", matched);
        }
      }

      if (itemNo === null || itemNo === "-" || itemNo === "") {
        const first = records[0] || null;
        if (first) itemNo = getFieldFlex("ItemNo", first);
      }

      const parsed = parseInt(itemNo, 10);
      return (!isNaN(parsed) && parsed > 0) ? parsed : 1;
    }

    function fillErpTable(records, preferredVin = ""){
      if (!records || !records.length) {
        erpCard.style.display = "none";
        clearErpTable();
        return;
      }
      erpCard.style.display = "";
      clearErpTable();

      currentOrderRecords = records.slice();

      const first = records[0] || {};
      const orderNo = first.orderNo || first.OrderNo || currentOrderId || "";
      let vinBadgeLabel = "";

      const vins = Array.from(new Set(
        records.map(r => (getFieldFlex("VIN", r) || "").toString().trim()).filter(Boolean)
      ));

      if (vins.length === 1) {
        vinBadgeLabel = "VIN: " + vins[0];
      } else if (vins.length > 1) {
        vinBadgeLabel = "Ø£ÙƒØ«Ø± Ù…Ù† Ù‡ÙŠÙƒÙ„ (" + vins.length + ")";
      } else {
        vinBadgeLabel = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ VIN ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
      }

      erpMetaEl.innerHTML =
        '<span class="badge">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ' + (orderNo || "ØºÙŠØ± Ù…ØªÙˆÙØ±") + '</span>' +
        '<span class="badge">' + vinBadgeLabel + '</span>';

      // ØªØ¹Ø¨Ø¦Ø© Ø¬Ø¯ÙˆÙ„ ERP
      records.forEach(rec => {
        const tr = document.createElement("tr");
        ERP_FIELDS.forEach(field => {
          const td = document.createElement("td");
          let val = getFieldFlex(field, rec);

          if (field === "TaxRate") {
            const num = parseAmountFront(val);
            let pc = num !== null ? (num <= 1 ? num * 100 : num) : 15;
            const pcStr = pc.toString().replace(/\.0+$/, "");
            val = pcStr + " %";
          } else if (field === "TotalInclVAT" || field === "TaxValue" || field === "SubtotalExclVAT") {
            const num = parseAmountFront(val);
            if (num !== null) {
              val = num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " Ø±.Ø³";
            }
          }

          td.textContent = val;
          tr.appendChild(td);
        });
        erpBody.appendChild(tr);
      });

      // Ø¥Ø¯Ø§Ø±Ø© VIN Ù„Ù„Ø¯Ø±ÙˆØ¨ Ø¯Ø§ÙˆÙ†
      let selectedVin = preferredVin && vins.includes(preferredVin) ? preferredVin : null;
      if (!selectedVin && vins.length === 1) {
        selectedVin = vins[0];
      }

      if (vins.length > 1) {
        vinPickerBox.style.display = "block";
        vinPicker.innerHTML = vins.map(v => `<option value="${v}">${v}</option>`).join("");
        vinCountChip.textContent = vins.length + " Ø£Ø±Ù‚Ø§Ù… Ù‡ÙŠØ§ÙƒÙ„ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨";
        if (selectedVin && vins.includes(selectedVin)) {
          vinPicker.value = selectedVin;
        } else {
          vinPicker.value = vins[0];
          selectedVin = vins[0];
        }
      } else if (vins.length === 1) {
        vinPickerBox.style.display = "block";
        vinPicker.innerHTML = `<option value="${vins[0]}">${vins[0]}</option>`;
        vinPicker.disabled = false;
        vinCountChip.textContent = "Ù‡ÙŠÙƒÙ„ ÙˆØ§Ø­Ø¯ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨";
        selectedVin = vins[0];
      } else {
        vinPickerBox.style.display = "none";
      }

      currentVin    = selectedVin || (vins[0] || preferredVin || "");
      currentItemNo = resolveItemNoForVin(currentVin, records);

      // Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨
      const totalCars = records.length;

      let orderSubtotal = parseAmountFront(
        first.orderSubtotalExclVAT ||
        first.orderSubtotalExclVat ||
        first.orderSubtotal
      );

      let orderTotal = parseAmountFront(
        first.orderTotalInclVAT ||
        first.orderTotalInclVat ||
        first.orderTotal
      );

      let subSum = 0;
      let totalSum = 0;
      records.forEach(rec => {
        const subVal = parseAmountFront(
          rec.subtotalExclVAT ||
          rec.SubtotalExclVAT ||
          getFieldFlex("SubtotalExclVAT", rec)
        );
        const totVal = parseAmountFront(
          rec.totalInclVAT ||
          rec.TotalInclVAT ||
          getFieldFlex("TotalInclVAT", rec)
        );
        if (subVal !== null) subSum += subVal;
        if (totVal !== null) totalSum += totVal;
      });

      if (orderSubtotal === null && subSum > 0) {
        orderSubtotal = subSum;
      }

      if (orderTotal === null && totalSum > 0) {
        orderTotal = totalSum;
      }

      if (orderSubtotal !== null && (orderTotal === null || orderTotal < 1000)) {
        if (totalSum > 0) {
          orderTotal = totalSum;
        } else {
          orderTotal = Math.round(orderSubtotal * 1.15 * 100) / 100;
        }
      }

      if (orderSubtotal !== null || orderTotal !== null) {
        const parts = [];
        parts.push(`<span>Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ø·Ù„Ø¨: <strong>${totalCars}</strong></span>`);
        if (orderSubtotal !== null) {
          parts.push(
            `<span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©: <strong>${orderSubtotal.toLocaleString('ar-SA',{minimumFractionDigits:2})} Ø±.Ø³</strong></span>`
          );
        }
        if (orderTotal !== null) {
          parts.push(
            `<span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©: <strong>${orderTotal.toLocaleString('ar-SA',{minimumFractionDigits:2})} Ø±.Ø³</strong></span>`
          );
        }
        erpTotals.innerHTML = parts.join("");
        erpTotals.style.display = "flex";
      } else {
        erpTotals.style.display = "none";
      }

      // ØªØ­Ù…ÙŠÙ„ Ù…Ø±Ø§Ø­Ù„ Ø§Ù„ØªØªØ¨Ø¹ Ù„Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
      loadTrackingForCurrentSelection();
    }

    // STAGES UI
    function buildStagesUI(orderData = {}) {
      stagesList.innerHTML = "";
      const stagesObj = orderData.stages || {};
      const current   = orderData.currentStage || 0;

      STAGES.forEach((label, idx) => {
        const num = idx + 1;
        const key = "s" + num;
        const ts  = stagesObj[key];

        const tsStr = ts
          ? new Date(ts.toDate ? ts.toDate() : ts).toLocaleString("ar-SA")
          : null;

        const wrap = document.createElement("div");
        wrap.className = "stage";
        if (tsStr) wrap.classList.add("done");

        const header = document.createElement("div");
        header.className = "stage-header";

        const tEl = document.createElement("div");
        tEl.innerHTML = "<strong>" + label + "</strong>";

        const meta = document.createElement("div");
        meta.innerHTML = tsStr
          ? "<small>ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡: " + tsStr + "</small>"
          : "<small>Ù„Ù… ØªÙÙ†ÙÙ‘Ø° Ø¨Ø¹Ø¯</small>";

        header.appendChild(tEl);
        header.appendChild(meta);

        const actions = document.createElement("div");
        actions.style.display = "flex";
        actions.style.gap = "6px";

        // Ø²Ø± ØªØ±Ø§Ø¬Ø¹
        const undoBtn = document.createElement("button");
        undoBtn.className = "btn-outline";
        undoBtn.style.fontSize = "12px";
        undoBtn.textContent = "ØªØ±Ø§Ø¬Ø¹";
        undoBtn.disabled = !tsStr;
        undoBtn.onclick = () => revertStage(num);

        // Ø²Ø± ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
        const btn = document.createElement("button");
        btn.className = "btn-outline";
        btn.style.fontSize = "12px";
        btn.textContent = "ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡";
        btn.disabled = !!tsStr;
        btn.onclick = () => completeStage(num);

        actions.appendChild(undoBtn);
        actions.appendChild(btn);

        wrap.appendChild(header);
        wrap.appendChild(actions);

        if (current === num) {
          const b = document.createElement("div");
          b.className = "hint";
          b.textContent = "Ù‡Ø°Ù‡ Ù‡ÙŠ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„Ø·Ù„Ø¨.";
          wrap.appendChild(b);
        }

        stagesList.appendChild(wrap);
      });
    }

    async function completeStage(num) {
      stageMsg.textContent = "";
      if (!currentOrderId || !currentItemNo) {
        stageMsg.innerHTML = "<span class='err'>Ø§Ø®ØªØ± Ø·Ù„Ø¨ ÙˆØ±Ù‚Ù… Ù‡ÙŠÙƒÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø±Ø§Ø­Ù„.</span>";
        return;
      }
      try {
        const baseId = currentOrderId;
        const docId = baseId + "_" + currentItemNo;

        const orderRef = doc(db, TRACK_COLLECTION, docId);
        await updateDoc(orderRef, {
          orderId: baseId,
          vin: currentVin || "",
          itemNo: currentItemNo || 1,
          currentStage: num,
          ["stages.s" + num]: serverTimestamp()
        }).catch(async () => {
          await setDoc(orderRef, {
            orderId: baseId,
            vin: currentVin || "",
            itemNo: currentItemNo || 1,
            currentStage: num,
            ["stages.s" + num]: serverTimestamp()
          }, { merge:true });
        });

        const publicRef = doc(db, TRACK_COLLECTION, docId, "public", "status");
        await setDoc(publicRef, {
          orderId: baseId,
          vin: currentVin || "",
          itemNo: currentItemNo || 1,
          currentStage: num,
          ["stages.s" + num]: serverTimestamp(),
          updatedAt: serverTimestamp()
        }, { merge:true });

        await loadTrackingForCurrentSelection();

        stageMsg.innerHTML = "<span class='ok'>ØªÙ… Ø®ØªÙ… Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø±Ù‚Ù… " + num + " ÙˆØªØ­Ø¯ÙŠØ« ØµÙØ­Ø© Ø§Ù„ØªØªØ¨Ø¹.</span>";
      } catch (e) {
        console.error(e);
        stageMsg.innerHTML = "<span class='err'>Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø±Ø­Ù„Ø©.</span>";
      }
    }

    // âœ… Ø²Ø± "ØªØ±Ø§Ø¬Ø¹" Ù„Ø¥Ù„ØºØ§Ø¡ Ù…Ø±Ø­Ù„Ø© ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ currentStage
    async function revertStage(num) {
      stageMsg.textContent = "";
      if (!currentOrderId || !currentItemNo) {
        stageMsg.innerHTML = "<span class='err'>Ø§Ø®ØªØ± Ø·Ù„Ø¨ ÙˆØ±Ù‚Ù… Ù‡ÙŠÙƒÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù…Ø±Ø­Ù„Ø©.</span>";
        return;
      }
      try {
        const baseId = currentOrderId;
        const docId  = baseId + "_" + currentItemNo;

        const orderRef = doc(db, TRACK_COLLECTION, docId);
        const snap = await getDoc(orderRef);
        if (!snap.exists()) {
          stageMsg.innerHTML = "<span class='err'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±Ø§Ø­Ù„ Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø¹Ø¯.</span>";
          return;
        }

        const data   = snap.data() || {};
        const stages = data.stages || {};
        const key    = "s" + num;

        if (!stages[key]) {
          stageMsg.innerHTML = "<span class='err'>Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù…Ø±Ø­Ù„Ø© ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©.</span>";
          return;
        }

        // Ø­Ø°Ù Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ù…Ù† Ø§Ù„Ù…Ø±Ø§Ø­Ù„
        const newStages = { ...stages };
        delete newStages[key];

        // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙƒØ£Ø¹Ù„Ù‰ Ù…Ø±Ø­Ù„Ø© Ù…ØªØ¨Ù‚ÙŠØ©
        let newCurrent = 0;
        Object.keys(newStages).forEach(k => {
          const m = k.match(/^s(\d+)$/);
          if (m) {
            const n = parseInt(m[1], 10);
            if (!isNaN(n) && n > newCurrent) newCurrent = n;
          }
        });

        await updateDoc(orderRef, {
          stages: newStages,
          currentStage: newCurrent
        });

        const publicRef = doc(db, TRACK_COLLECTION, docId, "public", "status");
        await setDoc(publicRef, {
          orderId: baseId,
          vin: currentVin || "",
          itemNo: currentItemNo || 1,
          stages: newStages,
          currentStage: newCurrent,
          updatedAt: serverTimestamp()
        }, { merge: true });

        await loadTrackingForCurrentSelection();

        stageMsg.innerHTML = "<span class='ok'>ØªÙ… Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø±Ù‚Ù… " + num + " ÙˆØªØ­Ø¯ÙŠØ« ØµÙØ­Ø© Ø§Ù„ØªØªØ¨Ø¹.</span>";
      } catch (e) {
        console.error(e);
        stageMsg.innerHTML = "<span class='err'>Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ø§Ù„Ù…Ø±Ø­Ù„Ø©.</span>";
      }
    }

    async function loadTrackingForCurrentSelection(){
      if (!currentOrderId || !currentItemNo) {
        buildStagesUI({ });
        return;
      }
      try{
        const baseId = currentOrderId;
        const docId  = baseId + "_" + currentItemNo;

        const orderRef = doc(db, TRACK_COLLECTION, docId);
        const trackSnap = await getDoc(orderRef);
        let trackData;
        if (trackSnap.exists()) {
          trackData = trackSnap.data();
        } else {
          trackData = {
            orderId: baseId,
            vin: currentVin || "",
            itemNo: currentItemNo || 1,
            currentStage: 0,
            stages:{}
          };
          await setDoc(orderRef, trackData, {merge:true});
          const publicRef = doc(db, TRACK_COLLECTION, docId, "public", "status");
          await setDoc(publicRef, {
            orderId: baseId,
            vin: currentVin || "",
            itemNo: currentItemNo || 1,
            currentStage: 0,
            stages:{},
            updatedAt: serverTimestamp()
          }, {merge:true});
        }
        buildStagesUI(trackData);
      }catch(e){
        console.error(e);
        buildStagesUI({});
      }
    }

    // AUTH
    loginBtn.onclick = async () => {
      authMsg.textContent = "";
      try{
        const em = email.value.trim();
        const pw = password.value;
        if(!em || !pw){
          authMsg.innerHTML = "<span class='err'>Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±.</span>";
          return;
        }
        await signInWithEmailAndPassword(auth, em, pw);
        authMsg.innerHTML = "<span class='ok'>ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.</span>";
      }catch(e){
        console.error(e);
        authMsg.innerHTML = "<span class='err'>ØªØ¹Ø°Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ùˆ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª.</span>";
      }
    };

    signupBtn.onclick = async () => {
      authMsg.textContent = "";
      try{
        const em = email.value.trim();
        const pw = password.value;
        if(!em || !pw){
          authMsg.innerHTML = "<span class='err'>Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨.</span>";
          return;
        }
        await createUserWithEmailAndPassword(auth, em, pw);
        authMsg.innerHTML = "<span class='ok'>ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.</span>";
      }catch(e){
        console.error(e);
        authMsg.innerHTML = "<span class='err'>ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…. Ø±Ø¨Ù…Ø§ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©.</span>";
      }
    };

    logoutBtn.onclick = async () => {
      try{ await signOut(auth); }catch(e){ console.error(e); }
    };

    onAuthStateChanged(auth, (user)=>{
      if(user){
        whoami.textContent = "Ù…Ø³Ø¬Ù‘Ù„: " + (user.email || "");
        logoutBtn.style.display = "";
        authCard.style.display  = "none";
        tabsBar.style.display   = "flex";

        // Ø£ÙˆÙ„ Ù…Ø§ ÙŠØ¯Ø®Ù„ ÙŠÙØªØ­ Ø¹Ù„Ù‰ ØªØ¨ÙˆÙŠØ¨ "ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª"
        activateTab("list");
      }else{
        whoami.textContent = "";
        logoutBtn.style.display = "none";
        authCard.style.display  = "";
        orderCard.style.display = "none";
        erpCard.style.display   = "none";
        stagesCard.style.display= "none";
        tabsBar.style.display   = "none";
        ordersListCard.style.display = "none";
      }
    });

    async function findByVin(vinRaw) {
      const val = vinRaw.trim();
      if (!val) return null;

      const colRef = collection(db, ERP_COLLECTION);

      let q1 = query(colRef, where("vin","==",val));
      let snap = await getDocs(q1);
      if (!snap.empty) return snap.docs[0];

      const asNum = Number(val);
      if (!Number.isNaN(asNum)) {
        q1 = query(colRef, where("vin","==",asNum));
        snap = await getDocs(q1);
        if (!snap.empty) return snap.docs[0];
      }

      try {
        const vinRef = doc(db, ERP_VINS_COLLECTION, val);
        const vinSnap = await getDoc(vinRef);
        if (vinSnap.exists()) {
          const vData = vinSnap.data();
          const ordNo = vData.lastOrderNo || vData.orderNo || vData.OrderNo || null;
          if (ordNo) {
            const ordRef = doc(db, ERP_COLLECTION, ordNo);
            const ordSnap = await getDoc(ordRef);
            if (ordSnap.exists()) return ordSnap;

            const q2 = query(colRef, where("orderNo","==",ordNo));
            const s2 = await getDocs(q2);
            if (!s2.empty) return s2.docs[0];
          }
        }
      } catch (e) {
        console.error("VIN lookup via erp_vins failed", e);
      }

      return null;
    }

    async function loadOrder(){
      orderMsg.textContent = "";
      stageMsg.textContent = "";
      clearErpTable();
      currentOrderId      = null;
      currentVin          = null;
      currentItemNo       = null;
      currentOrderRecords = [];

      const idRaw  = orderIdInput.value.trim();
      const vinRaw = vinInput.value.trim();

      if(!idRaw && !vinRaw){
        orderMsg.innerHTML = "<span class='err'>Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„.</span>";
        erpCard.style.display = "none";
        buildStagesUI({ });
        return;
      }

      try{
        let erpRecords = [];
        let erpDocId = null;

        if(idRaw){
          const ref = doc(db, ERP_COLLECTION, idRaw);
          const snap = await getDoc(ref);
          if(snap.exists()){
            erpRecords.push(snap.data());
            erpDocId = snap.id;
          }
        }

        let baseOrder = idRaw;
        if(!erpRecords.length && baseOrder){
          if(baseOrder.includes("_")) baseOrder = baseOrder.split("_")[0];
          const q = query(collection(db, ERP_COLLECTION), where("orderNo","==",baseOrder));
          const qsnap = await getDocs(q);
          if(!qsnap.empty){
            erpRecords = qsnap.docs.map(d => d.data());
            erpDocId = qsnap.docs[0].id;
          }
        }

        if(!erpRecords.length && vinRaw){
          const d = await findByVin(vinRaw);
          if(d){
            const data = d.data();
            erpDocId = d.id;
            const ordNo = data.orderNo || data.OrderNo || null;
            if (ordNo) {
              const q2 = query(collection(db, ERP_COLLECTION), where("orderNo","==",ordNo));
              const s2 = await getDocs(q2);
              if (!s2.empty) {
                erpRecords = s2.docs.map(docSnap => docSnap.data());
              } else {
                erpRecords = [data];
              }
            } else {
              erpRecords = [data];
            }
          }
        }

        if(!erpRecords.length){
          orderMsg.innerHTML = "<span class='err'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨ Ù…Ø·Ø§Ø¨Ù‚ ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª ERP.</span>";
          erpCard.style.display = "none";
          buildStagesUI({ });
          return;
        }

        const firstRec = erpRecords[0] || {};
        const detectedOrderNo = firstRec.orderNo || firstRec.OrderNo || (erpDocId || idRaw);

        currentOrderId = detectedOrderNo;

        orderIdInput.value = detectedOrderNo || "";
        const preferredVin =
          vinRaw ||
          (erpRecords.length === 1 ? (getFieldFlex("VIN", firstRec) || "") : "");

        fillErpTable(erpRecords, preferredVin);

        stagesCard.style.display = "";
        ordersListCard.style.display = ordersListCard.style.display;

        orderMsg.innerHTML = "<span class='ok'>ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ±Ø¨Ø·Ù‡ Ø¨Ø§Ù„ØªØªØ¨Ø¹.</span>";
      }catch(e){
        console.error(e);
        orderMsg.innerHTML = "<span class='err'>Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨.</span>";
        erpCard.style.display = "none";
        buildStagesUI({ });
      }
    }

    loadBtn.onclick = loadOrder;

    clearBtn.onclick = () => {
      orderIdInput.value = "";
      vinInput.value = "";
      orderMsg.textContent = "";
      stageMsg.textContent = "";
      currentOrderId      = null;
      currentVin          = null;
      currentItemNo       = null;
      currentOrderRecords = [];
      clearErpTable();
      erpCard.style.display = "none";
      buildStagesUI({ });
    };

    vinPicker.addEventListener("change", () => {
      if (!currentOrderId || !currentOrderRecords.length) return;
      const selected = vinPicker.value;
      currentVin    = selected;
      currentItemNo = resolveItemNoForVin(selected, currentOrderRecords);
      loadTrackingForCurrentSelection();
    });

    // ---- ØªØ¨ÙˆÙŠØ¨ ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ----
    async function loadOrdersList() {
      ordersListBody.innerHTML = "<tr><td class='muted' colspan='6'>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</td></tr>";
      try {
        const q = query(collection(db, ERP_COLLECTION), limit(100));
        const snap = await getDocs(q);
        if (snap.empty) {
          ordersListBody.innerHTML = "<tr><td class='muted' colspan='6'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</td></tr>";
          return;
        }
        const rows = [];
        for (const docSnap of snap.docs) {
          const d = docSnap.data();
          const orderNo = d.orderNo || d.OrderNo || docSnap.id;
          const vinVal  = getFieldFlex("VIN", d) || "";
          const customerName = getFieldFlex("CustomerName", d) || "";
          const branch = getFieldFlex("Branch", d) || "";
          const deliveryDate = getFieldFlex("DeliveryDate", d) || "";

          let statusLabel = "Ù„Ù… ÙŠØ¨Ø¯Ø£";
          try {
            const tSnap = await getDoc(doc(db, TRACK_COLLECTION, orderNo + "_1"));
            if (tSnap.exists()) {
              const t = tSnap.data();
              const currentStage = t.currentStage || 0;
              if (currentStage > 0 && currentStage <= STAGES.length) {
                statusLabel = STAGES[currentStage - 1];
              }
            }
          } catch (e) {
            console.error("track read error", e);
          }
          rows.push({ orderNo, vinVal, customerName, branch, deliveryDate, statusLabel });
        }
        ordersListBody.innerHTML = "";
        rows.forEach(r => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><button class="link-btn" data-order="${r.orderNo}">${r.orderNo}</button></td>
            <td>${r.customerName || "â€”"}</td>
            <td>${r.branch || "â€”"}</td>
            <td>${r.vinVal || "â€”"}</td>
            <td>${r.deliveryDate || "â€”"}</td>
            <td>${r.statusLabel || "â€”"}</td>
          `;
          ordersListBody.appendChild(tr);
        });
      } catch (err) {
        console.error(err);
        ordersListBody.innerHTML = "<tr><td class='err' colspan='6'>ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª.</td></tr>";
      }
    }

    function activateTab(which) {
      if (which === "list") {
        orderCard.style.display = "none";
        erpCard.style.display   = "none";
        stagesCard.style.display= "none";
        ordersListCard.style.display = "";
        tabSearchBtn.classList.remove("tab-active");
        tabListBtn.classList.add("tab-active");
        loadOrdersList();
      } else {
        orderCard.style.display = "";
        erpCard.style.display   = currentOrderId ? "" : "none";
        stagesCard.style.display= "";
        ordersListCard.style.display = "none";
        tabSearchBtn.classList.add("tab-active");
        tabListBtn.classList.remove("tab-active");
      }
    }

    tabSearchBtn.addEventListener("click", () => activateTab("search"));
    tabListBtn.addEventListener("click", () => activateTab("list"));

    ordersListBody.addEventListener("click", async (e) => {
      const btn = e.target.closest("button.link-btn");
      if (!btn) return;
      const ord = btn.dataset.order;
      try { await navigator.clipboard.writeText(ord); } catch(e) { console.warn(e); }
      orderIdInput.value = ord;
      vinInput.value = "";
      activateTab("search");
      loadOrder();
    });

    clearErpTable();
    buildStagesUI({ });
  </script>
</body>
</html>
