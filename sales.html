<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MZJ â€“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet" />
  <style>
    :root{
      --brown:#3e2420;
      --beige:#bc8f74;
      --cream:#fff8ef;
      --text:#111827;
      --muted:#6b7280;
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Tajawal",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#fffdf8 0,#fff3e6 40%,#fbe9da 70%,#f5e3d3 100%);
      color:var(--text);
      line-height:1.7;
    }
    .page{
      max-width:1200px;
      margin:0 auto;
      padding:18px 14px 32px;
    }
    .header{
      display:flex;
      flex-wrap:wrap;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      margin-bottom:14px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .brand-logo{
      width:40px;
      height:40px;
      border-radius:14px;
      background:linear-gradient(135deg,#fbbf77,#bc8f74);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      font-size:20px;
      color:#3e2420;
      box-shadow:0 4px 14px rgba(0,0,0,.35);
    }
    .brand-text{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .brand-text strong{
      font-size:15px;
      color:var(--brown);
    }
    .brand-text span{
      font-size:12px;
      color:var(--muted);
    }
    .header-right{
      text-align:left;
      min-width:180px;
    }
    .status-pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      background:#fff;
      border:1px solid rgba(188,143,116,.5);
      font-size:11px;
      color:var(--brown);
    }
    .status-dot{
      width:8px;
      height:8px;
      border-radius:999px;
      background:#22c55e;
    }
    .header-right small{
      display:block;
      margin-top:4px;
      font-size:11px;
      color:var(--muted);
    }

    .cards-row{
      display:grid;
      grid-template-columns:2.2fr 1.4fr;
      gap:12px;
    }
    @media(max-width:960px){
      .cards-row{
        grid-template-columns:1fr;
      }
    }

    .card{
      background:#fff;
      border-radius:var(--radius);
      box-shadow:0 14px 40px rgba(62,36,32,.12);
      padding:14px 14px 16px;
      margin-bottom:14px;
    }
    .card-header{
      margin-bottom:10px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:8px;
    }
    .title{
      margin:0 0 12px 0;
      display:flex;
      align-items:center;
      gap:8px;
      color:var(--brown);
      font-size:18px;
    }
    .title .icon{
      width:26px;
      height:26px;
      border-radius:999px;
      background:rgba(188,143,116,.16);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:16px;
    }
    .card-subtitle{
      font-size:12px;
      color:var(--muted);
    }
    .section-label{
      font-size:13px;
      color:var(--muted);
      margin-bottom:4px;
      display:flex;
      align-items:center;
      gap:4px;
    }
    .section-label span.dot{
      width:6px;
      height:6px;
      border-radius:999px;
      background:#bc8f74;
    }
    .row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-bottom:10px;
    }
    .col-4{
      flex:1 1 220px;
    }
    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:3px;
    }
    input,select{
      width:100%;
      padding:7px 9px;
      border-radius:10px;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      font-family:inherit;
      font-size:13px;
      outline:none;
      direction:rtl;
    }
    input:focus,select:focus{
      border-color:var(--beige);
      background:#fff;
      box-shadow:0 0 0 1px rgba(188,143,116,.35);
    }
    .btn,.btn-outline{
      border-radius:999px;
      border:0;
      padding:8px 13px;
      font-size:13px;
      font-family:inherit;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }
    .btn{
      background:var(--brown);
      color:#fff;
    }
    .btn-outline{
      border:1px solid var(--brown);
      background:transparent;
      color:var(--brown);
    }
    .btn-sm{
      padding:6px 10px;
      font-size:12px;
    }
    .btn:disabled,.btn-outline:disabled{
      opacity:.5;
      cursor:not-allowed;
    }
    .muted{color:var(--muted);font-size:13px;}
    .hint{color:var(--muted);font-size:12px;margin-top:4px;}
    .ok{color:#047857;font-weight:700;}
    .err{color:#b91c1c;font-weight:700;}
    .badge{
      display:inline-block;
      padding:3px 9px;
      border-radius:999px;
      background:rgba(188,143,116,.16);
      color:var(--brown);
      font-size:11px;
      margin-left:4px;
    }
    .erp-table-wrap{
      margin-top:8px;
      overflow-x:auto;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    thead{
      background:#f3f4f6;
    }
    th,td{
      padding:7px 6px;
      border-bottom:1px solid #f1f2f4;
      text-align:right;
      white-space:nowrap;
    }
    th{
      color:var(--brown);
      font-weight:600;
      font-size:12px;
    }
    tbody tr:nth-child(even){
      background:#f9fafb;
    }
    tbody tr:hover{
      background:#fff7ed;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      padding:3px 8px;
      border-radius:999px;
      font-size:11px;
      background:#e5e7eb;
      color:#374151;
    }
    .tag-success{
      background:#dcfce7;
      color:#166534;
    }
    .tag-warning{
      background:#fef3c7;
      color:#854d0e;
    }
    .tag-info{
      background:#e0f2fe;
      color:#075985;
    }
    .stage{
      background:#fffaf3;
      border-radius:12px;
      padding:10px 12px;
      border:1px dashed rgba(188,143,116,.55);
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .stage.done{
      background:#ecfdf5;
      border-style:solid;
      border-color:#22c55e;
    }
    .stage .stage-btn{
      transition:background-color .2s ease, color .2s ease, border-color .2s ease;
    }
    .stage.done .stage-btn{
      background:#22c55e;
      border-color:#16a34a;
      color:#fff;
      opacity:1;
    }
    .stage-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .stage-header strong{
      font-size:13px;
      color:var(--brown);
    }
    .stage-header small{
      font-size:11px;
      color:var(--muted);
    }
    .stages-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:8px;
    }
    @media(max-width:900px){
      .stages-grid{
        grid-template-columns:1fr;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="header">
      <div class="brand">
        <div class="brand-logo">â˜…</div>
        <div class="brand-text">
          <strong>Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª</strong>
          <span>Ø¥Ø¯Ø§Ø±Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆÙ…Ø±Ø§Ø­Ù„ ØªØªØ¨Ø¹ Ø§Ù„Ø·Ù„Ø¨</span>
        </div>
      </div>
      <div class="header-right">
        <div class="status-pill">
          <span class="status-dot"></span>
          <span>Ù…ØªØµÙ„ Ø¨Ù€ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØªØ¨Ø¹ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ</span>
        </div>
        <small>Ø£ÙŠ ØªØ­Ø¯ÙŠØ« ÙÙŠ Ù…Ø±Ø§Ø­Ù„ Ø§Ù„ØªØªØ¨Ø¹ Ø³ÙŠÙƒÙˆÙ† Ù„Ù‡Ø°Ø§ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ ÙÙ‚Ø·.</small>
      </div>
    </header>

    <!-- Auth -->
    <div class="card" id="authCard">
      <div class="card-header">
        <h3 class="title"><span class="icon">ğŸ”</span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
        <div class="card-subtitle">Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØªØ­Ø¯ÙŠØ« Ù…Ø±Ø§Ø­Ù„ Ø§Ù„ØªØªØ¨Ø¹.</div>
      </div>
      <div class="row">
        <div class="col-4">
          <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
          <input id="email" type="email" placeholder="user@mzjcars.com" />
        </div>
        <div class="col-4">
          <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
          <input id="password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
        </div>
        <div class="col-4" style="display:flex;align-items:flex-end;gap:8px;">
          <button class="btn" id="loginBtn">Ø¯Ø®ÙˆÙ„</button>
          <button class="btn-outline" id="signupBtn">ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
        </div>
      </div>
      <div id="authMsg" class="muted" style="margin-top:6px;"></div>
      <div class="hint">Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØªØ­Ø¯ÙŠØ« Ù…Ø±Ø§Ø­Ù„Ù‡Ø§.</div>
    </div>

    <!-- Search -->
    <div class="card" id="orderCard" style="display:none;">
      <h3 class="title"><span class="icon">ğŸ“„</span>Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø·Ù„Ø¨</h3>
      <div class="row">
        <div class="col-4">
          <label>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</label>
          <input id="orderId" placeholder="SAL-ORD-2025-01109 Ø£Ùˆ SAL-ORD-2025-01109_1" />
        </div>
        <div class="col-4" style="display:none;">
          <label>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ (VIN)</label>
          <input id="vinInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ (VIN)" />
        </div>
        <div class="col-4" style="display:flex;align-items:flex-end;gap:8px;">
          <button class="btn" id="loadOrderBtn">Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨</button>
          <button class="btn-outline btn-sm" id="loadLastOrdersBtn">Ø¹Ø±Ø¶ Ø¢Ø®Ø± 20 Ø·Ù„Ø¨</button>
        </div>
      </div>
      <div id="orderMsg" class="muted"></div>
    </div>

    <!-- ERP Summary & VINS -->
    <div class="cards-row">
      <div>
        <div class="card" id="erpCard" style="display:none;">
          <div class="card-header">
            <div>
              <h3 class="title"><span class="icon">ğŸ§¾</span>Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† ERP</h3>
              <div class="card-subtitle">Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ ÙƒÙ…Ø§ Ù‡ÙŠ ÙÙŠ Ù†Ø¸Ø§Ù… ERP (Ø§Ù„Ø¹Ù…ÙŠÙ„ØŒ Ø§Ù„ÙØ±Ø¹ØŒ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©ØŒ Ø¥Ù„Ø®).</div>
            </div>
          </div>
          <div class="row">
            <div class="col-4">
              <label>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</label>
              <div id="erpOrderId" class="badge">â€”</div>
            </div>
            <div class="col-4">
              <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
              <div id="erpCustomerName" class="badge">â€”</div>
            </div>
            <div class="col-4">
              <label>Ø§Ù„ÙØ±Ø¹</label>
              <div id="erpBranch" class="badge">â€”</div>
            </div>
          </div>
          <div class="row">
            <div class="col-4">
              <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨</label>
              <div id="erpPostingDate" class="badge">â€”</div>
            </div>
            <div class="col-4">
              <label>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨ (Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)</label>
              <div id="erpTotalInclVAT" class="badge">â€”</div>
            </div>
            <div class="col-4">
              <label>Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ ERP</label>
              <div id="erpStatus" class="badge">â€”</div>
            </div>
          </div>
          <div class="hint">Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø±Ø¬Ø¹ ÙÙ‚Ø·ØŒ Ù„Ø§ ÙŠØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ù…Ù† Ù‡Ù†Ø§.</div>
        </div>

        <div class="card" id="vinsCard" style="display:none;">
          <div class="card-header">
            <div>
              <h3 class="title"><span class="icon">ğŸš—</span>Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø·Ù„Ø¨</h3>
              <div class="card-subtitle">Ø§Ø®ØªØ± Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ ØªØ­Ø¯ÙŠØ« Ù…Ø±Ø§Ø­Ù„Ù‡. Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø³ÙŠØªÙ… Ø±Ø¨Ø·Ù‡ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù‡ÙŠÙƒÙ„ ÙÙ‚Ø·.</div>
            </div>
          </div>
          <div class="row">
            <div class="col-4">
              <label>Ø§Ø®ØªØ± Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ Ù„Ù„Ø¹Ù…Ù„ Ø¹Ù„ÙŠÙ‡</label>
              <select id="vinSelect"></select>
            </div>
            <div class="col-4">
              <label>Ø§Ø³Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©</label>
              <div id="vinCarName" class="badge">â€”</div>
            </div>
            <div class="col-4">
              <label>Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø³ÙŠØ§Ø±Ø©</label>
              <div id="vinColors" class="badge">â€”</div>
            </div>
          </div>
          <div id="vinMsg" class="muted"></div>
        </div>
      </div>

      <div>
        <div class="card" id="ordersListCard" style="display:none;">
          <h3 class="title"><span class="icon">ğŸ“‹</span>Ø¢Ø®Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
          <div class="card-subtitle">Ù‚Ø§Ø¦Ù…Ø© Ù…Ø®ØªØµØ±Ø© Ù„Ø£Ø­Ø¯Ø« Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ø·Ù„Ø¨ Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„Ù‡.</div>
          <div class="erp-table-wrap">
            <table>
              <thead>
              <tr>
                <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
                <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                <th>Ø§Ù„ÙØ±Ø¹</th>
                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨</th>
                <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨</th>
                <th>Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ (Ø¢Ø®Ø± Ù…Ø±Ø­Ù„Ø©)</th>
              </tr>
              </thead>
              <tbody id="ordersListBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Stages -->
    <div class="card" id="stagesCard" style="display:none;">
      <h3 class="title"><span class="icon">ğŸš¦</span>Ù…Ø±Ø§Ø­Ù„ ØªØªØ¨Ø¹ Ø§Ù„Ø·Ù„Ø¨</h3>
      <div class="stages-grid" id="stagesList"></div>
      <div class="hint">
        Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ <strong>ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</strong> Ø£Ù…Ø§Ù… Ø£ÙŠ Ù…Ø±Ø­Ù„Ø© Ù„ÙŠØªÙ… Ø®ØªÙ…Ù‡Ø§ ÙˆØªØ­Ø¯ÙŠØ« ØµÙØ­Ø© ØªØªØ¨Ø¹ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù‡ÙŠÙƒÙ„ ÙÙ‚Ø·.  
        ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø²Ø± <strong>ØªØ±Ø§Ø¬Ø¹</strong> Ù„Ø¥Ù„ØºØ§Ø¡ Ø£ÙŠ Ù…Ø±Ø­Ù„Ø© Ø«Ù… Ø¥Ø¹Ø§Ø¯Ø© ØªÙ†ÙÙŠØ°Ù‡Ø§ Ù…ØªÙ‰ Ø§Ø­ØªØ¬Øª.
      </div>
      <div class="muted" id="stageMsg" style="margin-top:6px;"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import {
      getFirestore,
      collection,
      doc,
      getDoc,
      getDocs,
      query,
      where,
      orderBy,
      limit,
      setDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCorGtT5_Z68jCtLODvqnv0Fb7QW5eR6MQ",
      authDomain: "mzj-tracking.firebaseapp.com",
      projectId: "mzj-tracking",
      storageBucket: "mzj-tracking.firebasestorage.app",
      messagingSenderId: "655452217491",
      appId: "1:655452217491:web:9348d172c47bdd411fad66"
    };

    const app  = initializeApp(firebaseConfig);
    const db   = getFirestore(app);
    const auth = getAuth(app);

    const AUTH_EMAIL_HINT = "Ø§Ø³ØªØ®Ø¯Ù… Ø­Ø³Ø§Ø¨ Ù…ÙˆØ¸Ù MZJ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯ ÙÙ‚Ø·.";

    const STAGES = [
      "1) Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
      "2) Ø¥ÙŠØµØ§Ù„ Ø§Ù„Ø¯ÙØ¹ â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
      "3) Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ù† Ù‚ÙØ¨Ù„ Ù…Ù…Ø«Ù„ÙŠ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø¨Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¬Ø±ÙƒÙŠØ© â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø¹Ø±Ø¶)",
      "4) Ø³Ø¯Ø§Ø¯ Ø±Ø³ÙˆÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
      "5) Ø§Ù„ØªØ£Ù…ÙŠÙ† â€“ Ø´Ø±Ø· Ø§Ù„Ø±Ø¨Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ³ØªÙ… â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
      "6) Ø¥Ø³ØªÙŠÙØ§Ø¡ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
      "7) Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù„ÙˆØ­Ø§Øª Ø£Ùˆ Ù†Ù‚Ù„ Ø§Ù„Ù…Ù„ÙƒÙŠØ© â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø¹Ø±Ø¶)",
      "8) Ø¥Ø³ØªÙŠÙØ§Ø¡ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
      "9) Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ù„Ù„Ø¥Ø³ØªÙ„Ø§Ù… â€“ (Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø¹Ø±Ø¶)",
      "10) Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­"
    ];

    const ERP_COLLECTION      = "erp_orders";
    const ERP_VINS_COLLECTION = "erp_vins";
    const TRACK_COLLECTION    = "orders";

    const emailInput     = document.getElementById("email");
    const passwordInput  = document.getElementById("password");
    const loginBtn       = document.getElementById("loginBtn");
    const signupBtn      = document.getElementById("signupBtn");
    const authMsg        = document.getElementById("authMsg");
    const authCard       = document.getElementById("authCard");
    const orderCard      = document.getElementById("orderCard");
    const erpCard        = document.getElementById("erpCard");
    const vinsCard       = document.getElementById("vinsCard");
    const ordersListCard = document.getElementById("ordersListCard");
    const stagesCard     = document.getElementById("stagesCard");

    const orderIdInput      = document.getElementById("orderId");
    const vinInput          = document.getElementById("vinInput");
    const loadOrderBtn      = document.getElementById("loadOrderBtn");
    const loadLastOrdersBtn = document.getElementById("loadLastOrdersBtn");
    const orderMsg          = document.getElementById("orderMsg");

    const erpOrderIdEl     = document.getElementById("erpOrderId");
    const erpCustomerNameEl= document.getElementById("erpCustomerName");
    const erpBranchEl      = document.getElementById("erpBranch");
    const erpPostingDateEl = document.getElementById("erpPostingDate");
    const erpTotalInclVATEl= document.getElementById("erpTotalInclVAT");
    const erpStatusEl      = document.getElementById("erpStatus");

    const vinSelect   = document.getElementById("vinSelect");
    const vinCarName  = document.getElementById("vinCarName");
    const vinColors   = document.getElementById("vinColors");
    const vinMsg      = document.getElementById("vinMsg");

    const ordersListBody = document.getElementById("ordersListBody");
    const stagesList     = document.getElementById("stagesList");
    const stageMsg       = document.getElementById("stageMsg");

    let currentUser   = null;
    let currentOrderId= null;
    let currentVin    = null;
    let currentItemNo = null;

    authMsg.textContent = AUTH_EMAIL_HINT;

    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      if (user) {
        authCard.style.display  = "none";
        orderCard.style.display = "block";
        loadLastOrdersBtn.disabled = false;
      } else {
        authCard.style.display  = "block";
        orderCard.style.display = "none";
        erpCard.style.display   = "none";
        vinsCard.style.display  = "none";
        stagesCard.style.display= "none";
        ordersListCard.style.display = "none";
      }
    });

    async function doLogin(isSignup = false) {
      authMsg.textContent = "";
      const email = (emailInput.value || "").trim();
      const pass  = passwordInput.value;

      if (!email || !pass) {
        authMsg.innerHTML = "<span class='err'>Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±.</span>";
        return;
      }
      try {
        let cred;
        if (isSignup) {
          cred = await createUserWithEmailAndPassword(auth, email, pass);
          authMsg.innerHTML = "<span class='ok'>ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­.</span>";
        } else {
          cred = await signInWithEmailAndPassword(auth, email, pass);
          authMsg.innerHTML = "<span class='ok'>ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­.</span>";
        }
      } catch (e) {
        console.error(e);
        authMsg.innerHTML = "<span class='err'>ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: " + (e.message || "") + "</span>";
      }
    }

    loginBtn.addEventListener("click", () => doLogin(false));
    signupBtn.addEventListener("click", () => doLogin(true));

    function fmtCurrency(v){
      if(v==null) return "â€”";
      const n = typeof v==="number"
        ? v
        : parseFloat(String(v).replace(/[^\d.,-]/g,"").replace(/,/g,""));
      if(!Number.isFinite(n)) return "â€”";
      return n.toLocaleString("ar-SA",{minimumFractionDigits:2,maximumFractionDigits:2})+" Ø±.Ø³";
    }

    function fmtDate(v){
      if(!v) return "â€”";
      try{
        if(v.toDate) return v.toDate().toLocaleString("ar-SA");
        const d = new Date(v);
        return isNaN(d.getTime()) ? "â€”" : d.toLocaleString("ar-SA");
      }catch{
        return "â€”";
      }
    }

    function setOrderSummaryFromERP(data){
      erpOrderIdEl.textContent      = data.OrderNo || data.name || "â€”";
      erpCustomerNameEl.textContent = data.CustomerName || data.customerName || "â€”";
      erpBranchEl.textContent       = data.Branch || data.branch || "â€”";
      erpPostingDateEl.textContent  = (data.PostingDate || data.posting_date || "â€”").toString().slice(0,10);
      erpTotalInclVATEl.textContent = fmtCurrency(data.TotalInclVAT ?? data.grand_total);
      erpStatusEl.textContent       = data.Status || data.status || "â€”";
      erpCard.style.display = "block";
    }

    async function loadOrderFromERP(orderIdRaw){
      const cleanId = (orderIdRaw || "").trim();
      if(!cleanId) return null;
      const baseId = cleanId.split("_")[0];
      const docRef = doc(db, ERP_COLLECTION, baseId);
      const snap   = await getDoc(docRef);
      if(!snap.exists()){
        return null;
      }
      const data = snap.data() || {};
      setOrderSummaryFromERP(data);
      return data;
    }

    async function loadLastOrders(){
      orderMsg.textContent = "Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø£Ø­Ø¯Ø« Ø§Ù„Ø·Ù„Ø¨Ø§Øª...";
      ordersListBody.innerHTML = "";
      ordersListCard.style.display = "block";

      try{
        const colRef = collection(db, ERP_COLLECTION);
        const qRef   = query(colRef, orderBy("PostingDate","desc"), limit(20));
        const qsnap  = await getDocs(qRef);

        if(qsnap.empty){
          ordersListBody.innerHTML = "";
          orderMsg.innerHTML = "<span class='err'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…ØªØ§Ø­Ø©.</span>";
          return;
        }

        qsnap.forEach((docSnap) => {
          const data = docSnap.data() || {};
          const tr   = document.createElement("tr");

          const orderNo  = data.OrderNo || docSnap.id;
          const customer = data.CustomerName || "â€”";
          const branch   = data.Branch || "â€”";
          const date     = (data.PostingDate || "").toString().slice(0,10);
          const total    = fmtCurrency(data.TotalInclVAT ?? data.grand_total);

          const tdOrder  = document.createElement("td");
          const tdCust   = document.createElement("td");
          const tdBranch = document.createElement("td");
          const tdDate   = document.createElement("td");
          const tdTotal  = document.createElement("td");
          const tdStatus = document.createElement("td");

          tdOrder.textContent  = orderNo;
          tdCust.textContent   = customer;
          tdBranch.textContent = branch;
          tdDate.textContent   = date;
          tdTotal.textContent  = total;

          const statusSpan = document.createElement("span");
          statusSpan.className = "tag tag-info";
          statusSpan.textContent = "â€”";
          tdStatus.appendChild(statusSpan);

          tr.appendChild(tdOrder);
          tr.appendChild(tdCust);
          tr.appendChild(tdBranch);
          tr.appendChild(tdDate);
          tr.appendChild(tdTotal);
          tr.appendChild(tdStatus);

          tr.style.cursor = "pointer";
          tr.addEventListener("click", () => {
            orderIdInput.value = orderNo;
            loadOrderById();
          });

          ordersListBody.appendChild(tr);
        });

        orderMsg.textContent = "";
      }catch(e){
        console.error(e);
        orderMsg.innerHTML = "<span class='err'>ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª.</span>";
      }
    }

    async function loadOrderById(){
      orderMsg.textContent = "";
      erpCard.style.display   = "none";
      vinsCard.style.display  = "none";
      stagesCard.style.display= "none";
      vinSelect.innerHTML     = "";
      stagesList.innerHTML    = "";
      stageMsg.textContent    = "";

      const rawId = (orderIdInput.value || "").trim();
      if(!rawId){
        orderMsg.innerHTML = "<span class='err'>Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨.</span>";
        return;
      }

      const baseId = rawId.split("_")[0];
      currentOrderId = baseId;
      currentVin     = null;
      currentItemNo  = null;

      try{
        const erpData = await loadOrderFromERP(baseId);
        if(!erpData){
          orderMsg.innerHTML = "<span class='err'>Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ ERP.</span>";
          return;
        }

        await loadVinsForOrder(baseId);
        orderMsg.innerHTML = "<span class='ok'>ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨. Ø§Ø®ØªØ± Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ Ù„ØªØ­Ø¯ÙŠØ« Ù…Ø±Ø§Ø­Ù„Ù‡.</span>";
      }catch(e){
        console.error(e);
        orderMsg.innerHTML = "<span class='err'>Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨.</span>";
      }
    }

    async function loadVinsForOrder(orderBase){
      vinSelect.innerHTML = "";
      vinsCard.style.display = "none";
      stagesCard.style.display = "none";
      vinMsg.textContent = "";

      try{
        const colRef = collection(db, ERP_VINS_COLLECTION);
        const qRef   = query(colRef, where("lastOrderNo","==",orderBase));
        const qsnap  = await getDocs(qRef);

        if(qsnap.empty){
          vinMsg.innerHTML = "<span class='err'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‡ÙŠØ§ÙƒÙ„ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ erp_vins.</span>";
          vinsCard.style.display = "block";
          return;
        }

        const vinDocs = [];
        qsnap.forEach((docSnap)=>{
          const data = docSnap.data() || {};
          vinDocs.push({ id: docSnap.id, data });
        });

        vinSelect.innerHTML = "";
        vinDocs.forEach((row)=>{
          const vin   = row.id;
          const ld    = row.data.lastData || {};
          const itemNo= row.data.lastItemNo || ld.itemNo || 1;
          const label = vin;
          const opt   = document.createElement("option");
          opt.value   = vin+"::"+itemNo;
          opt.textContent = label;
          opt.dataset.carName = ld.itemModel || ld.itemName || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
          opt.dataset.colors  = (ld.exteriorColor || "â€”") + " / " + (ld.interiorColor || "â€”");
          vinSelect.appendChild(opt);
        });

        vinsCard.style.display = "block";
        vinMsg.textContent = "Ø§Ø®ØªØ± Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ Ù„ØªØ­Ø¯ÙŠØ« Ù…Ø±Ø§Ø­Ù„Ù‡ ÙÙŠ ØµÙØ­Ø© Ø§Ù„ØªØªØ¨Ø¹.";

        if(vinSelect.options.length>0){
          vinSelect.selectedIndex = 0;
          onVinChange();
        }
      }catch(e){
        console.error(e);
        vinMsg.innerHTML = "<span class='err'>Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‡ÙŠØ§ÙƒÙ„.</span>";
        vinsCard.style.display = "block";
      }
    }

    async function readBestTrackingDoc(){
      const ids = getTrackingDocIds();
      for(const id of ids){
        const ref = doc(db, TRACK_COLLECTION, id, "public", "status");
        const snap = await getDoc(ref);
        if(snap.exists()){
          return { docId:id, data:snap.data() || {} };
        }
      }
      return { docId:null, data:null };
    }

    function getTrackingDocIds() {
      if (!currentOrderId) return [];
      const base = currentOrderId;
      const vinClean = (currentVin || "").toString().trim();

      const ids = [];
      if (vinClean) {
        ids.push(`${base}_VIN_${vinClean}`);
      } else {
        ids.push(base);
      }
      return ids;
    }

    async function writeTrackingToAllIds(payload, merge = true) {
      const ids = getTrackingDocIds();
      if (!ids.length) return;
      for (const id of ids) {
        const ref = doc(db, TRACK_COLLECTION, id);
        try {
          if (merge)
            await setDoc(ref, payload, { merge: true });
          else
            await setDoc(ref, payload);
          const publicRef = doc(db, TRACK_COLLECTION, id, "public", "status");
          await setDoc(publicRef, payload, { merge: true });
        } catch (e) {
          console.warn("write fail", id, e);
        }
      }
    }

    const FIELD_SYNONYMS = {
      CustomerName: ["CustomerName","customerName"],
      CustomerVAT:  ["CustomerVAT","customerVat","customerVAT"],
      Branch:       ["Branch","branch"],
      OrderDate:    ["OrderDate","orderDate"],
      DeliveryDate: ["DeliveryDate","deliveryDate"],
      SalesPerson:  ["SalesPerson","salesPerson"],

      ItemNo:       ["ItemNo","itemNo","no"],
      ItemType:     ["ItemType","itemType","type"],
      ItemCategory: ["ItemCategory","itemCategory","category"],
      ItemModel:    ["ItemModel","itemModel","model"],

      VIN:          ["VIN","vin"],

      InteriorColor:["InteriorColor","interiorColor"],
      ExteriorColor:["ExteriorColor","exteriorColor"],

      TotalInclVAT: ["TotalInclVAT","totalInclVAT","grand_total"]
    };

    function getField(obj, key){
      const syns = FIELD_SYNONYMS[key] || [key];
      for(const k of syns){
        if(obj && Object.prototype.hasOwnProperty.call(obj,k) && obj[k]!=null){
          return obj[k];
        }
      }
      return null;
    }

    function buildStagesUI(orderData = {}) {
      stagesList.innerHTML = "";
      const stagesObj = orderData.stages || {};
      const current   = orderData.currentStage || 0;

      STAGES.forEach((label, idx) => {
        const num = idx + 1;
        const key = "s" + num;
        const ts  = stagesObj[key];

        const tsStr = ts
          ? new Date(ts.toDate ? ts.toDate() : ts).toLocaleString("ar-SA")
          : null;

        const wrap = document.createElement("div");
        wrap.className = "stage";
        if (tsStr) wrap.classList.add("done");

        const header = document.createElement("div");
        header.className = "stage-header";

        const tEl = document.createElement("div");
        tEl.innerHTML = "<strong>" + label + "</strong>";

        const meta = document.createElement("div");
        meta.innerHTML = tsStr
          ? "<small>ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡: " + tsStr + "</small>"
          : "<small>Ù„Ù… ØªÙÙ†ÙÙ‘Ø° Ø¨Ø¹Ø¯</small>";

        header.appendChild(tEl);
        header.appendChild(meta);

        const actions = document.createElement("div");
        actions.style.display = "flex";
        actions.style.gap = "6px";

        const undoBtn = document.createElement("button");
        undoBtn.className = "btn-outline stage-btn";
        undoBtn.style.fontSize = "12px";
        undoBtn.textContent = "ØªØ±Ø§Ø¬Ø¹";
        undoBtn.disabled = !tsStr;
        undoBtn.onclick = () => revertStage(num);

        const btn = document.createElement("button");
        btn.className = "btn-outline stage-btn";
        btn.style.fontSize = "12px";
        btn.textContent = "ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡";
        btn.disabled = !!tsStr;
        btn.onclick = () => completeStage(num);

        actions.appendChild(undoBtn);
        actions.appendChild(btn);

        wrap.appendChild(header);
        wrap.appendChild(actions);

        if (current === num) {
          const b = document.createElement("div");
          b.className = "hint";
          b.textContent = "Ù‡Ø°Ù‡ Ù‡ÙŠ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„Ø·Ù„Ø¨.";
          wrap.appendChild(b);
        }

        stagesList.appendChild(wrap);
      });
    }

    async function completeStage(num) {
      stageMsg.textContent = "";
      if (!currentOrderId) {
        stageMsg.innerHTML = "<span class='err'>Ø§Ø®ØªØ± Ø·Ù„Ø¨ ÙˆØ±Ù‚Ù… Ù‡ÙŠÙƒÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø±Ø§Ø­Ù„.</span>";
        return;
      }
      try {
        const payload = {
          orderId: currentOrderId,
          vin: currentVin || "",
          itemNo: currentItemNo || 1,
          currentStage: num,
          ["stages.s" + num]: serverTimestamp(),
          updatedAt: serverTimestamp()
        };

        await writeTrackingToAllIds(payload, true);
        await loadTrackingForCurrentSelection();

        stageMsg.innerHTML = "<span class='ok'>ØªÙ… Ø®ØªÙ… Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø±Ù‚Ù… " + num + " ÙˆØªØ­Ø¯ÙŠØ« ØµÙØ­Ø© Ø§Ù„ØªØªØ¨Ø¹.</span>";
      } catch (e) {
        console.error(e);
        stageMsg.innerHTML = "<span class='err'>Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø±Ø­Ù„Ø©.</span>";
      }
    }

    async function revertStage(num) {
      stageMsg.textContent = "";
      if (!currentOrderId) {
        stageMsg.innerHTML = "<span class='err'>Ø§Ø®ØªØ± Ø·Ù„Ø¨ ÙˆØ±Ù‚Ù… Ù‡ÙŠÙƒÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù…Ø±Ø­Ù„Ø©.</span>";
        return;
      }
      try {
        const { docId, data } = await readBestTrackingDoc();
        if (!docId || !data) {
          stageMsg.innerHTML = "<span class='err'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±Ø§Ø­Ù„ Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø¹Ø¯.</span>";
          return;
        }

        const stages = data.stages || {};
        const key    = "s" + num;
        if (!stages[key]) {
          stageMsg.innerHTML =
            "<span class='err'>Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø­Ù„Ø© ØºÙŠØ± Ù…ÙØ³Ø¬Ù„Ø© ÙƒÙ…ÙƒØªÙ…Ù„Ø©ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡Ø§.</span>";
          return;
        }

        const newStages = { ...stages };
        delete newStages[key];

        let newCurrent = 0;
        Object.keys(newStages).forEach(k => {
          const m = k.match(/^s(\d+)$/);
          if (m) {
            const n = parseInt(m[1], 10);
            if (!isNaN(n) && n > newCurrent) newCurrent = n;
          }
        });

        const payload = {
          orderId: currentOrderId,
          vin: currentVin || "",
          itemNo: currentItemNo || 1,
          stages: newStages,
          currentStage: newCurrent,
          updatedAt: serverTimestamp()
        };

        await writeTrackingToAllIds(payload, true);
        await loadTrackingForCurrentSelection();

        stageMsg.innerHTML = "<span class='ok'>ØªÙ… Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø±Ù‚Ù… " + num + " ÙˆØªØ­Ø¯ÙŠØ« ØµÙØ­Ø© Ø§Ù„ØªØªØ¨Ø¹.</span>";
      } catch (e) {
        console.error(e);
        stageMsg.innerHTML = "<span class='err'>Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ø§Ù„Ù…Ø±Ø­Ù„Ø©.</span>";
      }
    }

    async function loadTrackingForCurrentSelection(){
      stagesList.innerHTML = "";
      stagesCard.style.display = "none";
      stageMsg.textContent = "";
      if(!currentOrderId || !currentVin){
        return;
      }
      try{
        const { data } = await readBestTrackingDoc();
        buildStagesUI(data || {});
        stagesCard.style.display = "block";
      }catch(e){
        console.error(e);
        stageMsg.innerHTML = "<span class='err'>Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ù…Ø±Ø§Ø­Ù„ Ø§Ù„ØªØªØ¨Ø¹.</span>";
      }
    }

    function onVinChange(){
      const val = vinSelect.value || "";
      if(!val){
        currentVin    = null;
        currentItemNo = null;
        stagesCard.style.display = "none";
        return;
      }
      const [vin,itemNoStr] = val.split("::");
      currentVin    = vin;
      currentItemNo = parseInt(itemNoStr || "1",10) || 1;

      const opt = vinSelect.options[vinSelect.selectedIndex];
      vinCarName.textContent = opt.dataset.carName || "â€”";
      vinColors.textContent  = opt.dataset.colors  || "â€”";

      loadTrackingForCurrentSelection();
    }

    async function findERPOrderByVin(val){
      const colRef = collection(db, ERP_VINS_COLLECTION);
      let q1 = query(colRef, where("vin","==",val));
      let snap = await getDocs(q1);
      if (!snap.empty) return snap.docs[0];

      const asNum = Number(val);
      if (!Number.isNaN(asNum)) {
        q1 = query(colRef, where("vin","==",asNum));
        snap = await getDocs(q1);
        if (!snap.empty) return snap.docs[0];
      }

      try {
        const vinRef = doc(db, ERP_VINS_COLLECTION, val);
        const vinSnap = await getDoc(vinRef);
        if (vinSnap.exists()) {
          return vinSnap;
        }
      } catch(e){
        console.error(e);
      }
      return null;
    }

    async function loadOrderByVin(){
      orderMsg.textContent = "";
      const vinVal = (vinInput.value || "").trim();
      if(!vinVal){
        orderMsg.innerHTML = "<span class='err'>Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„.</span>";
        return;
      }

      try{
        const vinSnap = await findERPOrderByVin(vinVal);
        if(!vinSnap){
          orderMsg.innerHTML = "<span class='err'>Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù‡ÙŠÙƒÙ„ ÙÙŠ erp_vins.</span>";
          return;
        }
        const vinData = vinSnap.data()||{};
        const lastOrderNo = vinData.lastOrderNo;
        if(!lastOrderNo){
          orderMsg.innerHTML = "<span class='err'>Ù‡Ø°Ø§ Ø§Ù„Ù‡ÙŠÙƒÙ„ ØºÙŠØ± Ù…Ø±ØªØ¨Ø· Ø¨Ø£ÙŠ Ø·Ù„Ø¨ Ù…Ø¨ÙŠØ¹Ø§Øª.</span>";
          return;
        }
        orderIdInput.value = lastOrderNo;
        await loadOrderById();
      }catch(e){
        console.error(e);
        orderMsg.innerHTML = "<span class='err'>Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„.</span>";
      }
    }

    orderIdInput.addEventListener("keydown",(e)=>{
      if(e.key==="Enter") loadOrderById();
    });
    vinInput.addEventListener("keydown",(e)=>{
      if(e.key==="Enter") loadOrderByVin();
    });

    loadOrderBtn.addEventListener("click", loadOrderById);
    loadLastOrdersBtn.addEventListener("click", loadLastOrders);
    vinSelect.addEventListener("change", onVinChange);
  </script>
</body>
</html>
