







<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ØªØªØ¨Ø¹ Ø·Ù„Ø¨Ùƒ - Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: "Tajawal", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f6f4f0;
      color: #3e2420;
    }
    .page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 24px 12px 40px;
    }
    .card {
      width: 100%;
      max-width: 720px;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      padding: 20px 18px 24px;
      box-sizing: border-box;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 18px;
    }
    .brand-mark {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: linear-gradient(135deg, #3e2420, #bc8f74);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 700;
      font-size: 20px;
    }
    .brand-text-title {
      font-weight: 700;
      font-size: 18px;
      color: #3e2420;
    }
    .brand-text-sub {
      font-size: 13px;
      color: #7b6a63;
    }

    .search-section {
      margin-bottom: 18px;
      background: #fff8ef;
      border-radius: 12px;
      padding: 12px 14px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    .search-section label {
      font-size: 13px;
      color: #5b4035;
      font-weight: 600;
    }
    .search-input-wrap {
      flex: 1 1 200px;
      display: flex;
      gap: 8px;
    }
    .search-input-wrap input {
      flex: 1;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #d4c4b8;
      font-size: 14px;
      outline: none;
    }
    .search-input-wrap input:focus {
      border-color: #bc8f74;
      box-shadow: 0 0 0 2px rgba(188,143,116,0.25);
    }
    .btn {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.2s;
    }
    .btn-primary {
      background: linear-gradient(135deg, #3e2420, #bc8f74);
      color: #fff;
      box-shadow: 0 4px 14px rgba(62,36,32,0.35);
    }
    .btn-primary:active {
      transform: translateY(1px);
      box-shadow: 0 2px 8px rgba(62,36,32,0.35);
    }

    .status-bar {
      margin-top: 4px;
      font-size: 13px;
      color: #7b6a63;
      min-height: 18px;
    }

    .section-title {
      font-size: 15px;
      font-weight: 700;
      margin: 14px 0 8px;
      display: flex;
      align-items: center;
      gap: 6px;
      color: #3e2420;
    }
    .section-title span.icon-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #bc8f74;
      display: inline-block;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 8px 12px;
      margin-bottom: 6px;
    }
    .info-item {
      padding: 8px 10px;
      border-radius: 10px;
      background: #faf3ea;
      border: 1px solid #e4d6c8;
    }
    .info-label {
      font-size: 11px;
      color: #7b6a63;
      margin-bottom: 3px;
    }
    .info-value {
      font-size: 13px;
      font-weight: 600;
      color: #3e2420;
      word-break: break-word;
    }

    .car-box {
      margin-top: 8px;
      border-radius: 12px;
      background: linear-gradient(135deg, #3e2420 0%, #5b4035 45%, #bc8f74 100%);
      padding: 12px 14px;
      color: #fff;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    .car-main {
      font-size: 14px;
      font-weight: 700;
    }
    .car-meta {
      font-size: 12px;
      opacity: 0.9;
    }

    .timeline {
      margin-top: 10px;
      padding-top: 8px;
      border-top: 1px solid #e5d6c7;
    }
    .timeline-title {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 6px;
    }
    .timeline-steps {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .timeline-step {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 8px 0;
    }
    .timeline-step:not(:last-child) {
      border-bottom: 1px dashed #e0d0c2;
    }
    .step-icon {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 2px solid #bc8f74;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      flex-shrink: 0;
    }
    .step-icon.done {
      background: #bc8f74;
      color: #fff;
    }
    .step-body {
      flex: 1;
    }
    .step-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 2px;
    }
    .step-sub {
      font-size: 11px;
      color: #7b6a63;
    }

    .empty-state {
      padding: 14px 10px 6px;
      font-size: 13px;
      color: #7b6a63;
    }

    /* Tabs for multiple cars */
    .cars-tabs {
      margin: 6px 0 4px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .car-tab {
      border-radius: 999px;
      border: 1px solid #e4d6c8;
      background: #f9f2ea;
      color: #5b4035;
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer;
      font-family: inherit;
      transition: background 0.15s ease, color 0.15s ease, border-color 0.15s ease;
    }
    .car-tab.active {
      background: #3e2420;
      color: #fff;
      border-color: #3e2420;
    }

    /* Status summary + progress */
    .status-summary {
      font-size: 12px;
      color: #7b6a63;
      margin-top: 4px;
      margin-bottom: 8px;
      line-height: 1.6;
    }
    .status-summary strong {
      color: #3e2420;
    }
    .progress-wrapper {
      margin: 4px 0 10px;
    }
    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: #5b4035;
      margin-bottom: 4px;
    }
    .progress-percent-strong {
      font-weight: 700;
    }
    .progress-bar {
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: #f0e3d6;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, #bc8f74, #3e2420);
      width: 0%;
      transition: width 0.3s ease;
    }

    @media (max-width: 480px) {
      .card {
        padding: 16px 14px 20px;
      }
      .brand-text-title {
        font-size: 16px;
      }
      .search-section {
        padding: 10px 10px;
      }
    }
  
    /* âœ… Finished/Archived order notice (public tracking) */
    .archived-notice{
      margin-top: 10px;
      padding: 14px 14px;
      border-radius: 14px;
      background: #fff8ef;
      border: 1px solid #e4d6c8;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    }
    .archived-notice .title{
      font-size: 16px;
      font-weight: 800;
      color: #3e2420;
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom: 6px;
    }
    .archived-notice .msg{
      font-size: 13px;
      color: #5b4035;
      line-height: 1.8;
    }
    .archived-notice .meta{
      margin-top: 8px;
      font-size: 12px;
      color: #7b6a63;
      line-height: 1.8;
    }

  </style>

<script>
function formatTimestamp(ts) {
  if (!ts) return "-";
  let date;
  if (typeof ts.toDate === "function") {
    date = ts.toDate();
  } else if (ts.seconds) {
    date = new Date(ts.seconds * 1000);
  } else {
    date = new Date(ts);
  }
  if (isNaN(date.getTime())) return "-";
  return date.toLocaleString("ar-SA", {
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit"
  });
}

// helper to safely set time text
function applyStepTime(el, ts) {
  if (!el) return;
  el.innerHTML = 'ØªÙ… ÙÙŠ: <strong>' + formatTimestamp(ts) + '</strong>';
}

// ========== Archived detection (from PUBLIC status doc only) ==========
function isArchivedStatus(statusData) {
  const s = statusData || {};
  return (
    s.isArchived === true ||
    s.archived === true ||
    s.inArchive === true ||
    s.status === "archived" ||
    s.orderStatus === "archived" ||
    s.state === "archived"
  );
}

function getArchivedAtFromStatus(statusData) {
  const s = statusData || {};
  return s.archivedAt || s.archiveAt || s.archived_at || s.archive_at || null;
}

function buildArchivedHtml(statusData) {
  const at = getArchivedAtFromStatus(statusData);
  const atTxt = at ? formatTimestamp(at) : "";
  return `
    <div class="archived-notice">
      <div class="title">âœ… Ø§Ù„Ø·Ù„Ø¨ Ù…Ù†ØªÙ‡ÙŠ</div>
      <div class="msg">
        ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ£Ø±Ø´ÙØªÙ‡ Ø¨Ù†Ø¬Ø§Ø­.
      </div>
      <div class="meta">
        ${atTxt ? `ØªØ§Ø±ÙŠØ® Ø§Ù„Ø£Ø±Ø´ÙØ©: <strong>${atTxt}</strong>` : ``}
      </div>
    </div>
  `;
}

</script>

</head>
<body>
  <div class="page">
    <div class="card">
      <!-- Brand header -->
      <div class="brand">
        <div class="brand-mark">â˜…</div>
        <div>
          <div class="brand-text-title">ØªØªØ¨Ø¹ Ø·Ù„Ø¨Ùƒ</div>
          <div class="brand-text-sub">Ù…Ø¹ Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øªâ€¦ Ø£Ù†Øª Ù†Ø¬Ù… Ø§Ù„Ø·Ø±ÙŠÙ‚ âœ¨</div>
        </div>
      </div>

      <!-- Search -->
      <div class="search-section">
        <div>
          <label for="vinInput">Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„:</label>
        </div>
        <div class="search-input-wrap">
          <input id="vinInput" type="text" placeholder="Ù…Ø«Ø§Ù„: 045087 Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„" />
          <button id="searchBtn" class="btn btn-primary">
            ğŸ” ØªØªØ¨Ø¹
          </button>
        </div>
        <div class="status-bar" id="statusBar"></div>
      </div>

      <!-- Result -->
      <div id="resultContainer">
        <div class="empty-state">
          Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ ÙˆØ§Ø¶ØºØ· "ØªØªØ¨Ø¹" Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø·Ù„Ø¨Ùƒ ÙˆØ­Ø§Ù„Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©.
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK v9 (Modules) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
    import {
      getFirestore,
      doc,
      getDoc,
      collection,
      query,
      where,
      getDocs
    } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore.js";

    // ========= 1) Ø¥Ø¹Ø¯Ø§Ø¯ Firebase =========
    const firebaseConfig = {
      apiKey: "AIzaSyCorGtT5_Z68jCtLODvqnv0Fb7QW5eR6MQ",
      authDomain: "mzj-tracking.firebaseapp.com",
      projectId: "mzj-tracking",
      storageBucket: "mzj-tracking.firebasestorage.app",
      messagingSenderId: "655452217491",
      appId: "1:655452217491:web:9348d172c47bdd411fad66"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // ========= 2) Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙØ­Ø© =========
    const vinInput       = document.getElementById("vinInput");
    const searchBtn      = document.getElementById("searchBtn");
    const statusBar      = document.getElementById("statusBar");
    const resultContainer = document.getElementById("resultContainer");

    function setStatus(msg, isError = false) {
      statusBar.textContent = msg || "";
      statusBar.style.color = isError ? "#b00020" : "#7b6a63";
    }

    function renderEmptyState() {
      resultContainer.innerHTML = `
        <div class="empty-state">
          Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ ÙˆØ§Ø¶ØºØ· "ØªØªØ¨Ø¹" Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø·Ù„Ø¨Ùƒ ÙˆØ­Ø§Ù„Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©.
        </div>
      `;
    }

    // ====== Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ø·Ù„Ø¨ (10 Ø®Ø·ÙˆØ§Øª) ======
    const STAGES = [
      {
        title: "Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
        sub: "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨Ùƒ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­."
      },
      {
        title: "Ø¥ÙŠØµØ§Ù„ Ø§Ù„Ø¯ÙØ¹ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
        sub: "ÙŠØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ù…Ø¨Ù„Øº Ø§Ù„Ø¯ÙØ¹Ø© Ø£Ùˆ ØªØ±ØªÙŠØ¨ Ø®ÙŠØ§Ø± Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨."
      },
      {
        title: "Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ù† Ù‚ÙØ¨Ù„ Ù…Ù…Ø«Ù„ÙŠ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø¨Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¬Ø±ÙƒÙŠØ© (Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø¹Ø±Ø¶)",
        sub: "Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ØªØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù„Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠØ©."
      },
      {
        title: "Ø³Ø¯Ø§Ø¯ Ø±Ø³ÙˆÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
        sub: "ÙŠØªÙ… Ø³Ø¯Ø§Ø¯ Ø±Ø³ÙˆÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø±Ø³Ù…ÙŠØ© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ø±ÙƒØ¨Ø©."
      },
      {
        title: "Ø§Ù„ØªØ£Ù…ÙŠÙ† â€“ Ø´Ø±Ø· Ø§Ù„Ø±Ø¨Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ³ØªÙ… (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
        sub: "Ø¥ØµØ¯Ø§Ø± ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„ØªØ£Ù…ÙŠÙ† ÙˆØ±Ø¨Ø·Ù‡Ø§ Ø¨Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±ÙˆØ±."
      },
      {
        title: "Ø§Ø³ØªÙŠÙØ§Ø¡ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
        sub: "Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª ÙˆØ§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„ØªØ³Ø¬ÙŠÙ„."
      },
      {
        title: "Ø§Ø³ØªÙŠÙØ§Ø¡ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
        sub: "Ø¥ØµØ¯Ø§Ø± Ù„ÙˆØ­Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ø£Ùˆ Ø¥ØªÙ…Ø§Ù… Ø¥Ø¬Ø±Ø§Ø¡ Ù†Ù‚Ù„ Ø§Ù„Ù…Ù„ÙƒÙŠØ©."

      },
      {
        title: "Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù„ÙˆØ­Ø§Øª Ø£Ùˆ Ù†Ù‚Ù„ Ø§Ù„Ù…Ù„ÙƒÙŠØ© (Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø¹Ø±Ø¶)",
        sub: "ØªØ­ÙˆÙŠÙ„ ÙˆØªØ¬ÙŠÙŠØ± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠØ© Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯."

      },
      {
        title: "Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ù„Ù„Ø§Ø³ØªÙ„Ø§Ù… (Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø¹Ø±Ø¶)",
        sub: "Ø³ÙŠØ§Ø±ØªÙƒ Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø§Ø³ØªÙ„Ø§Ù… Ù…Ù† Ø§Ù„Ù…Ø¹Ø±Ø¶ Ø£Ùˆ Ù„Ø·Ù„Ø¨ Ø§Ù„Ø´Ø­Ù† Ù„Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©."
      },
      {
        title: "Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­",
        sub: "ØªÙ… ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø³ÙŠØ§Ø±Ø© ÙˆØ¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­. Ù†ØªÙ…Ù†Ù‰ Ù„Ùƒ Ø±Ø­Ù„Ø© Ø³Ø¹ÙŠØ¯Ø©."
      }
    ];

    // ====== Helpers Ø£Ø±Ù‚Ø§Ù… ======
    function parseAmountFront(value) {
      if (value === null || value === undefined || value === "-") return null;
      if (typeof value === "number") return value;
      const s = String(value)
        .replace(/[^\d.,\-]/g, "")
        .replace(/,/g, "");
      const n = parseFloat(s);
      return isNaN(n) ? null : n;
    }

    function formatAmount(val) {
      if (val === null || val === undefined || val === "") return "-";
      if (typeof val === "number") {
        return val.toLocaleString("ar-SA", { minimumFractionDigits: 2 });
      }
      const n = parseAmountFront(val);
      if (n === null) return val;
      return n.toLocaleString("ar-SA", { minimumFractionDigits: 2 });
    }

    // ====== Normalize Totals (Firestore keys Ø§Ø®ØªÙ„Ø§ÙØ§Øª) ======
    function normalizeTotals(totals) {
      const t = totals || {};

      // Ù‚ÙŠÙ… Ø§Ù„Ø³ÙŠØ§Ø±Ø© (Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù€ item)
      const carSubtotal =
        t.carSubtotalExclVAT ??
        t.subtotalExclVAT ??
        t.SubtotalExclVAT ??
        t.carSubtotalBeforeTax ??
        t.carSubtotal ??
        "";

      const carTax =
        t.carTaxValue ??
        t.taxValue ??
        t.TaxValue ??
        "";

      const carTotal =
        t.carTotalInclVAT ??
        t.totalInclVAT ??
        t.TotalInclVAT ??
        t.carGrandTotal ??
        t.carTotal ??
        "";

      const taxName = t.taxName ?? t.TaxName ?? "Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ©";
      const taxRate = t.taxRate ?? t.TaxRate ?? 0.15;

      // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨ (Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯)
      const orderSubtotal = t.subtotalBeforeTax ?? t.orderSubtotalBeforeTax ?? "";
      const orderTotal = t.grandTotal ?? t.orderGrandTotal ?? "";

      // Ù„Ùˆ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø³ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯Ø© Ù†Ø­Ø³Ø¨Ù‡Ø§
      let orderTax = t.taxValue ?? t.orderTaxValue ?? "";
      const oSub = parseAmountFront(orderSubtotal);
      const oTot = parseAmountFront(orderTotal);
      if ((orderTax === "" || orderTax === null || orderTax === undefined) && oSub !== null && oTot !== null) {
        orderTax = oTot - oSub;
      }

      return {
        carSubtotal,
        carTax,
        carTotal,
        taxName,
        taxRate,
        orderSubtotal,
        orderTax,
        orderTotal,
        registrationFee: (t.registrationFee ?? t.RegistrationFee ?? t.registration_fees ?? t.registrationFees ?? 0)
      };
    }

    // ====== Timeline + Progress ======
    function buildTimelineHtml(statusData) {
      const track     = statusData || {};
      const stagesMap = track.stages || {};
      const updatedAt = track.updatedAt
        ? new Date(track.updatedAt.toDate ? track.updatedAt.toDate() : track.updatedAt).toLocaleString("ar-SA")
        : "";

      let doneCount = 0;
      for (let i = 1; i <= STAGES.length; i++) {
        const doneTs = stagesMap["s" + i];
        if (doneTs) doneCount++;
      }
      const progress = Math.round((doneCount / STAGES.length) * 100);

      let currentStageLabel;
      if (doneCount === 0) {
        currentStageLabel = "Ù„Ù… ÙŠØ¨Ø¯Ø£ Ø¨Ø¹Ø¯";
      } else if (doneCount >= STAGES.length) {
        currentStageLabel = "ØªÙ… Ø¥ØªÙ…Ø§Ù… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø§Ø­Ù„";
      } else {
        currentStageLabel = "ØªÙ… ØªÙ†ÙÙŠØ° " + doneCount + " Ù…Ù† " + STAGES.length + " Ù…Ø±Ø§Ø­Ù„";
      }

      return `
        <div class="status-summary">
          <div>Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <strong>${currentStageLabel}</strong></div>
          <div>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« Ù„Ù„Ø­Ø§Ù„Ø©: <span>${updatedAt || "-"}</span></div>
        </div>
        <div class="progress-wrapper">
          <div class="progress-header">
            <span>Ù†Ø³Ø¨Ø© Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</span>
            <span class="progress-percent-strong">${progress}%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" style="width:${progress}%;"></div>
          </div>
        </div>
        <div class="timeline">
          <div class="timeline-title">Ø®Ø·ÙˆØ§Øª Ø·Ù„Ø¨Ùƒ Ù…Ù† Ø£ÙˆÙ„ Ø­Ø¬Ø² Ø­ØªÙ‰ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©</div>
          <ul class="timeline-steps">
            ${STAGES.map((step, idx) => {
              const stepIndex = idx + 1;
              const doneTs = stagesMap["s" + stepIndex];
              const isDone = !!doneTs;
              const tsLabel = doneTs ? formatTimestamp(doneTs) : "";
              return `
                <li class="timeline-step">
                  <div class="step-icon ${isDone ? "done" : ""}">
                    ${isDone ? "âœ“" : stepIndex}
                  </div>
                  <div class="step-body">
                    <div class="step-title">${step.title}</div>
                    <div class="step-sub">
                      ${step.sub}
                      ${tsLabel ? ` â€” <span>ØªÙ… ÙÙŠ: ${tsLabel}</span>` : ""}
                    </div>
                  </div>
                </li>
              `;
            }).join("")}
          </ul>
        </div>
      `;
    }

    function updateStatusUIForCar(statusData) {
      const timelineArea = resultContainer.querySelector("#timelineArea");
      if (!timelineArea) return;

      // âœ… If archived (order finished) show a clear message instead of timeline
      if (isArchivedStatus(statusData)) {
        timelineArea.innerHTML = buildArchivedHtml(statusData || {});
        return;
      }

      timelineArea.innerHTML = buildTimelineHtml(statusData || {});
    }

    // ====== Multi-car UI ======
    function renderMultiResult(orderInfo, cars, activeIndex) {
      if (!cars || !cars.length) {
        renderEmptyState();
        return;
      }
      if (activeIndex < 0 || activeIndex >= cars.length) activeIndex = 0;

      function renderCarBox(car) {
        return `
          <div class="car-box">
            <div class="car-main">
              ${car.label || "-"}
            </div>
            <div class="car-meta">
              Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„: ${car.vin || "-"}
            </div>
            <div class="car-meta">
              Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ: ${car.extColor || "-"} â€“ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ: ${car.intColor || "-"}
            </div>
            <div class="car-meta">
              Ø§Ù„ÙˆÙƒÙŠÙ„: ${car.dealer || "-"}
            </div>
            <div class="car-meta">
              Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©: ${formatAmount(car.subtotal)} Ø±.Ø³
            </div>
            <div class="car-meta">
              Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©${car.taxName ? " (" + car.taxName + ")" : ""}: ${formatAmount(car.taxValue)} Ø±.Ø³
            </div>
            <div class="car-meta">
              Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©: ${formatAmount((parseAmountFront(car.total) || 0) + (parseAmountFront(car.regFeePerCar) || 0))} Ø±.Ø³
            </div>
          </div>
        `;
      }

      const orderTotal = cars.reduce((sum, car) => {
        const v = parseAmountFront(car.total);
        return sum + (v || 0);
      }, 0);

      const orderHeaderHtml = `
        <div class="section-title">
          <span class="icon-dot"></span>
          <span>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨</span>
        </div>
        <div class="info-grid">
          <div class="info-item">
            <div class="info-label">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</div>
            <div class="info-value">${orderInfo.orderNo || "-"}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
            <div class="info-value">${orderInfo.customerName || "-"}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Ø§Ù„ÙØ±Ø¹</div>
            <div class="info-value">${orderInfo.branch || "-"}</div>
          </div>
<div class="info-item">
            <div class="info-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</div>
            <div class="info-value">${(() => { const base = (orderInfo.orderTotal !== undefined && orderInfo.orderTotal !== "" ? orderInfo.orderTotal : orderTotal); const baseNum = parseAmountFront(base); const reg = parseAmountFront(orderInfo.registrationFee) || 0; if (baseNum === null) return ((orderInfo.orderTotal !== undefined && orderInfo.orderTotal !== "" ? formatAmount(orderInfo.orderTotal) + " Ø±.Ø³" : (orderTotal ? formatAmount(orderTotal) + " Ø±.Ø³" : "-"))); return formatAmount(baseNum + reg) + " Ø±.Ø³"; })()}</div>
          </div>
        </div>
      `;

      const tabsHtml = `
        <div class="section-title">
          <span class="icon-dot"></span>
          <span>Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨</span>
        </div>
        <div class="cars-tabs">
          ${cars
            .map(
              (car, idx) => `
            <button class="car-tab ${
              idx === activeIndex ? "active" : ""
            }" data-idx="${idx}">
              Ø³ÙŠØ§Ø±Ø© ${idx + 1} â€“ ${(car.label || car.vin || "").slice(0, 40)}
            </button>
          `
            )
            .join("")}
        </div>
        <div id="carDetailsArea">
          ${renderCarBox(cars[activeIndex])}
        </div>
      `;

      const timelineWrapper = `
        <div class="section-title">
          <span class="icon-dot"></span>
          <span>Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</span>
        </div>
        <div id="timelineArea"></div>
      `;

      resultContainer.innerHTML = `
        <div>
          ${orderHeaderHtml}
          ${tabsHtml}
          ${timelineWrapper}
        </div>
      `;

      const tabs = resultContainer.querySelectorAll(".car-tab");
      const carDetailsArea = resultContainer.querySelector("#carDetailsArea");

      updateStatusUIForCar(cars[activeIndex].statusData || {});

      tabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          const idx = parseInt(tab.getAttribute("data-idx"), 10);
          tabs.forEach((t) => t.classList.remove("active"));
          tab.classList.add("active");
          carDetailsArea.innerHTML = renderCarBox(cars[idx]);
          updateStatusUIForCar(cars[idx].statusData || {});
        });
      });
    }

    // ====== Ø¹Ø±Ø¶ Ø³ÙŠØ§Ø±Ø© ÙˆØ§Ø­Ø¯Ø© (Fallback Ø²ÙŠ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©) ======
    function renderSingleCar(vinData, statusData) {
      const d = vinData || {};
      const payload = d.lastData || {};
      const item    = payload.item || {};
      const totalsRaw  = payload.totals || {};
      const totals = normalizeTotals(totalsRaw);

      const vin = d.vin || payload.vin || "";

      const carType     = item.type     || "";
      const carCategory = item.category || "";
      const carModel    = item.model    || "";
      const label       = [carType, carCategory, carModel].filter(Boolean).join(" ");

      const extColor = item.exteriorColor || item.extColor || "";
      const intColor = item.interiorColor || item.intColor || "";
      const dealer   = item.dealer || payload.dealer || "";

      const subtotal = totals.carSubtotal;
      const total    = totals.carTotal;
      const taxName  = totals.taxName;
      const taxValue = totals.carTax;

      const customerName = payload.customerName || "";
      const branch       = payload.branch || "";
      const orderNo      = d.lastOrderNo || payload.orderNo || "";

      const car = {
        vin,
        label,
        extColor,
        intColor,
        dealer,
        subtotal,
        total,
        taxName,
        taxValue,
        regFeePerCar: (parseAmountFront(totalsRaw.registrationFee ?? totalsRaw.RegistrationFee ?? totalsRaw.registration_fees ?? totalsRaw.registrationFees ?? 0) || 0),
        statusData
      };

      const orderInfo = {
        orderNo,
        customerName,
        branch
      };

      renderMultiResult(orderInfo, [car], 0);
    }

    // ====== Build order & cars Ù…Ù† erp_vins (Ù„Ù…Ø§ Ù†Ø¬ÙŠØ¨ Ù…Ø¬Ù…ÙˆØ¹Ø© VINS Ù„Ù†ÙØ³ Ø§Ù„Ø·Ù„Ø¨) ======
    function buildOrderFromVinDocs(vinDocs, rawKey) {
      const firstRow   = vinDocs[0];
      const firstData  = firstRow.data || firstRow;
      const payload0   = firstData.lastData || {};
      const totals0Raw = payload0.totals || {};
      const totals0    = normalizeTotals(totals0Raw);

      // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø±Ø³ÙˆÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (Ù‚Ø¯ ØªÙƒÙˆÙ† Ø®Ø§Ø±Ø¬ totals Ø£Ùˆ ÙÙŠ ÙˆØ«Ø§Ø¦Ù‚ Ø£Ø®Ø±Ù‰ Ø¶Ù…Ù† Ù†ÙØ³ Ø§Ù„Ø·Ù„Ø¨)
      const deriveRegFeeTotal = (dataObj) => {
        if (!dataObj) return 0;
        const ld = dataObj.lastData || {};
        const t  = (ld.totals || {});
        const candidates = [
          t.registrationFee, t.RegistrationFee, t.registration_fees, t.registrationFees,
          ld.registrationFee, ld.RegistrationFee, ld.registration_fees, ld.registrationFees,
          ld.registrationFeeTotal, ld.registration_fee_total,
          dataObj.registrationFee, dataObj.RegistrationFee, dataObj.registration_fees, dataObj.registrationFees
        ];
        // parseAmountFront Ù…ÙˆØ¬ÙˆØ¯ Ø¹Ù†Ø¯Ù†Ø§ ÙÙŠ Ø§Ù„Ù…Ù„Ù
        let best = 0;
        candidates.forEach(v => {
          const n = parseAmountFront(v);
          if (n !== null && n > best) best = n;
        });
        return best;
      };

      // Ù†Ø§Ø®Ø° Ø£ÙƒØ¨Ø± Ù‚ÙŠÙ…Ø© Ø±Ø³ÙˆÙ… ØªØ³Ø¬ÙŠÙ„ Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¯Ø§Ø®Ù„ Ø£ÙŠ Ù‡ÙŠÙƒÙ„ ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø·Ù„Ø¨ (Ø£Ø­ÙŠØ§Ù†Ø§Ù‹ ØªØªÙƒØ±Ø±/ØªØ®ØªÙ„Ù)
      let regFeeTotal = 0;
      vinDocs.forEach(row => {
        const d = row.data || row;
        const val = deriveRegFeeTotal(d);
        if (val > regFeeTotal) regFeeTotal = val;
      });

      const orderNo = firstData.lastOrderNo || payload0.orderNo || rawKey || "";

      const orderInfo = {
        orderNo,
        customerName: payload0.customerName || "",
        branch: payload0.branch || "",
        orderSubtotal: totals0.orderSubtotal,
        orderTax: totals0.orderTax,
        orderTotal: totals0.orderTotal,
        registrationFee: regFeeTotal
            };

      const cars = vinDocs.map((row, idx) => {
        const data    = row.data || row;
        const payload = data.lastData || {};
        const item    = payload.item || {};
        const totalsRaw  = payload.totals || {};
        const totals = normalizeTotals(totalsRaw);

        const vin =
          row.id ||
          data.vin ||
          item.vin ||
          "";

        const itemNo =
          data.lastItemNo ||
          payload.itemNo ||
          (idx + 1);

        const carType     = item.type     || "";
        const carCategory = item.category || "";
        const carModel    = item.model    || "";

        const extColor = item.exteriorColor || item.extColor || "";
        const intColor = item.interiorColor || item.intColor || "";
        const dealer   = item.dealer || payload.dealer || "";

        const subtotal = totals.carSubtotal;
        const total    = totals.carTotal;
        const taxName  = totals.taxName;
        const taxValue = totals.carTax;

        return {
          vin,
          itemNo,
          label: [carType, carCategory, carModel].filter(Boolean).join(" "),
          carType,
          carCategory,
          carModel,
          extColor,
          intColor,
          dealer,
          subtotal,
          total,
          taxName,
          taxValue,
          statusData: null
        };
      });


      // ØªÙˆØ²ÙŠØ¹ Ø±Ø³ÙˆÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ø§Ù„Ù‡ÙŠØ§ÙƒÙ„ (Ø¥Ù† ÙˆÙØ¬Ø¯Øª)
      const totalRegFee = parseAmountFront(orderInfo.registrationFee) || 0;
      const perCarRegFee = (totalRegFee > 0 && cars.length) ? (totalRegFee / cars.length) : 0;
      cars.forEach(c => { c.regFeePerCar = perCarRegFee; });


      // Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª (Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)
      // Ù„Ùˆ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠÙ‡ Ø£ÙƒØ«Ø± Ù…Ù† Ø³ÙŠØ§Ø±Ø©: Ù†Ø¬Ù…Ø¹ Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙƒÙ„ Ø³ÙŠØ§Ø±Ø© (Ø¨Ø¯Ù„ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ totals.grandTotal Ø§Ù„Ù„ÙŠ Ù…Ù…ÙƒÙ† ÙŠÙƒÙˆÙ† ØºÙŠØ± Ø¯Ù‚ÙŠÙ‚)
      const carsTotalSum = cars.reduce((sum, c) => sum + (parseAmountFront(c.total) || 0), 0);
      if (carsTotalSum > 0) {
        orderInfo.orderTotal = carsTotalSum;
      }

      // Ù†Ø­Ø¯Ø¯ Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø§Ù„Ù†Ø´Ø·Ø© Ù„Ùˆ Ø§Ù„Ù„ÙŠ Ù…ÙƒØªÙˆØ¨ ÙƒØ§Ù† VIN
      let activeIndex = 0;
      if (rawKey) {
        const normalized = rawKey.replace(/\s+/g, "").toLowerCase();
        const foundIdx = cars.findIndex(
          (c) => (c.vin || "").replace(/\s+/g, "").toLowerCase() === normalized
        );
        if (foundIdx >= 0) activeIndex = foundIdx;
      }

      return { orderInfo, cars, activeIndex };
    }

    // ====== Helpers: ØªÙˆÙ„ÙŠØ¯ Ø£Ø´ÙƒØ§Ù„ Ù…Ø®ØªÙ„ÙØ© Ù„Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ ======
    function buildOrderCandidates(rawOrder) {
      const cands = new Set();

      const trimmed = rawOrder.trim();
      if (!trimmed) return [];

      cands.add(trimmed);

      // Ø±Ù‚Ù… Ø¨Ø¯ÙˆÙ† Ø£ØµÙØ§Ø± Ø¨Ø¯Ø§ÙŠØ©
      const digitsOnly = trimmed.replace(/[^\d]/g, "");
      if (digitsOnly) {
        cands.add(digitsOnly);
        cands.add(digitsOnly.replace(/^0+/, "") || "0");

        // pad Ù„Ø£Ø·ÙˆØ§Ù„ Ø´Ø§Ø¦Ø¹Ø©
        const t = digitsOnly.replace(/^0+/, "") || digitsOnly;
        cands.add(t.padStart(5, "0"));
        cands.add(t.padStart(6, "0"));

        // Prefix Ù…Ø­ØªÙ…Ù„ SO-
        cands.add("SO-" + t);
        cands.add("SO-" + t.padStart(5, "0"));
        cands.add("SO-" + t.padStart(6, "0"));
      }

      return Array.from(cands);
    }

    // ========= handleSearch: ÙŠØ¯Ø¹Ù… Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ + VIN =========
    async function handleSearch() {
      const rawKey = (vinInput.value || "").trim();
      if (!rawKey) {
        setStatus("Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø£ÙˆÙ„Ø§Ù‹.", true);
        renderEmptyState();
        return;
      }

      setStatus("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø±ØªØ¨Ø· Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…â€¦");

      try {
        const vinsCol = collection(db, "erp_vins");

        // (A) Ø¬Ø±Ù‘Ø¨ Ø£ÙˆÙ„Ø§Ù‹ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± ÙƒÙ€ Document ID Ø¯Ø§Ø®Ù„ erp_vins (Ø£Ø³Ø±Ø¹ ÙˆØ£Ø¶Ù…Ù†)
        // Ù‡Ø°Ø§ ÙŠØºØ·ÙŠ: VIN Ù†ÙØ³Ù‡ (Ù…Ø«Ø§Ù„: 045093) Ø£Ùˆ Ø±Ù‚Ù… Ù‡ÙŠÙƒÙ„/Ø±Ù‚Ù… Ø¯Ø§Ø®Ù„ÙŠ Ù…Ø­ÙÙˆØ¸ ÙƒÙ€ doc id (Ù…Ø«Ø§Ù„: 510187)
        try {
          const directRef  = doc(db, "erp_vins", rawKey);
          const directSnap = await getDoc(directRef);
          if (directSnap.exists()) {
            const vinData      = directSnap.data();
            const orderBase    = vinData.lastOrderNo || vinData.orderNo || (vinData.lastData && vinData.lastData.orderNo) || "";
            const itemNoForVin = vinData.lastItemNo || vinData.itemNo || (vinData.lastData && vinData.lastData.itemNo) || 1;

            // Ø­Ø§Ù„Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            let vinStatus = null;
            if (orderBase) {
              try {
                const newDocId      = `${orderBase}_${itemNoForVin}`;
                const newStatusRef  = doc(db, "orders", newDocId, "public", "status");
                const newStatusSnap = await getDoc(newStatusRef);
                if (newStatusSnap.exists()) vinStatus = newStatusSnap.data();
              } catch (eNew) {
                console.error("Error fetching status for VIN:", eNew);
              }
            }

            // Ù„Ùˆ ÙÙŠÙ‡ OrderNo Ù†Ø­Ø§ÙˆÙ„ Ù†Ø¬ÙŠØ¨ Ø¨Ø§Ù‚ÙŠ Ø³ÙŠØ§Ø±Ø§Øª Ù†ÙØ³ Ø§Ù„Ø·Ù„Ø¨
            let handledMulti = false;
            if (orderBase) {
              try {
                const qByOrder = query(vinsCol, where("lastOrderNo", "==", orderBase));
                const qsnap    = await getDocs(qByOrder);

                if (!qsnap.empty) {
                  const vinDocs = qsnap.docs.map((d) => ({ id: d.id, data: d.data() }));

                  if (vinDocs.length > 1) {
                    const builtMulti = buildOrderFromVinDocs(vinDocs, rawKey);
                    const orderInfo  = builtMulti.orderInfo;
                    const cars       = builtMulti.cars;

                    // Ù†Ø¬ÙŠØ¨ Ø­Ø§Ù„Ø© ÙƒÙ„ Ø³ÙŠØ§Ø±Ø©
                    for (const car of cars) {
                      const itemNo = car.itemNo || 1;
                      if (!orderInfo.orderNo) continue;
                      try {
                        const carDocId      = `${orderInfo.orderNo}_${itemNo}`;
                        const carStatusRef  = doc(db, "orders", carDocId, "public", "status");
                        const carStatusSnap = await getDoc(carStatusRef);
                        if (carStatusSnap.exists()) car.statusData = carStatusSnap.data();

                      // ğŸ”¹ Ø¬Ù„Ø¨ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù…Ù† orders/{orderNo}_{itemNo}
                      const carOrderRef  = doc(db, "orders", carDocId);
                      const carOrderSnap = await getDoc(carOrderRef);
                      if (carOrderSnap.exists()) {
                        car.vin = (carOrderSnap.data().vin || car.vin || "");
                      }
                      } catch (csErr) {
                        console.error("Error fetching car status (multi VIN):", csErr);
                      }
                    }

                    renderMultiResult(orderInfo, cars, builtMulti.activeIndex);
                    setStatus(`ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨. Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ${cars.length} Ø³ÙŠØ§Ø±Ø©.`);
                    handledMulti = true;
                  }
                }
              } catch (multiErr) {
                console.error("Error fetching multi-car order:", multiErr);
              }
            }

            // Ù„Ùˆ Ù…ÙÙŠØ´ ØªØ¹Ø¯Ø¯ Ø³ÙŠØ§Ø±Ø§Øª â†’ Ù†Ø¹Ø±Ø¶ Ø³ÙŠØ§Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
            if (!handledMulti) {
              setStatus("ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨. ÙŠØªÙ… Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø©.");
              renderSingleCar({ ...vinData, vin: (vinData.vin || (vinData.lastData && vinData.lastData.vin) || rawKey) }, vinStatus);
            }
            return; // âœ… Ø§Ù†ØªÙ‡ÙŠÙ†Ø§ Ù„Ø£Ù†Ù†Ø§ Ù„Ù‚ÙŠÙ†Ø§ doc Ù…Ø¨Ø§Ø´Ø±
          }
        } catch (directErr) {
          console.error("Direct erp_vins doc lookup failed:", directErr);
        }

        // (B) Ù„Ùˆ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ ÙƒÙ€ doc id â†’ Ø¬Ø±Ù‘Ø¨Ù‡ ÙƒÙ€ Ø±Ù‚Ù… Ø·Ù„Ø¨ (Ø¨Ø­Ø« Ø¨Ø§Ù„Ù…Ø³Ø§ÙˆØ§Ø© ÙÙ‚Ø· Ù„ØªØ¬Ù†Ø¨ Ø£ÙŠ ØªØ¹Ù„ÙŠÙ‚)
        // Ù†Ø¬Ø±Ø¨ Ø¹Ù„Ù‰ lastOrderNo Ø«Ù… Ø¹Ù„Ù‰ lastData.orderNo
        const orderCands = buildOrderCandidates(rawKey);
        let vinDocsOrder = [];

        for (const cand of orderCands) {
          const q1 = query(vinsCol, where("lastOrderNo", "==", cand));
          const s1 = await getDocs(q1);
          if (!s1.empty) {
            vinDocsOrder = s1.docs.map((d) => ({ id: d.id, data: d.data() }));
            break;
          }
        }

        if (!vinDocsOrder.length) {
          for (const cand of orderCands) {
            const q2 = query(vinsCol, where("lastData.orderNo", "==", cand));
            const s2 = await getDocs(q2);
            if (!s2.empty) {
              vinDocsOrder = s2.docs.map((d) => ({ id: d.id, data: d.data() }));
              break;
            }
          }
        }

        if (!vinDocsOrder.length) {
          setStatus("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø·Ù„Ø¨ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…. ØªØ£ÙƒØ¯ Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ ÙˆØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.", true);
          renderEmptyState();
          return;
        }

        const built     = buildOrderFromVinDocs(vinDocsOrder, rawKey);
        const orderInfo = built.orderInfo;
        const cars      = built.cars;

        // Ù†Ø¬ÙŠØ¨ Ø­Ø§Ù„Ø© ÙƒÙ„ Ø³ÙŠØ§Ø±Ø© Ù…Ù† orders/{orderNo}_{itemNo}/public/status
        for (const car of cars) {
          const itemNo = car.itemNo || 1;
          if (!orderInfo.orderNo) continue;
          try {
            const docId      = `${orderInfo.orderNo}_${itemNo}`;
            const statusRef  = doc(db, "orders", docId, "public", "status");
            const statusSnap = await getDoc(statusRef);
            if (statusSnap.exists()) car.statusData = statusSnap.data();

            // ğŸ”¹ Ø¬Ù„Ø¨ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù…Ù† orders/{orderNo}_{itemNo}
            const orderItemRef  = doc(db, "orders", docId);
            const orderItemSnap = await getDoc(orderItemRef);
            if (orderItemSnap.exists()) {
              car.vin = (orderItemSnap.data().vin || car.vin || "");
            }
          } catch (csErr) {
            console.error("Error fetching car status (by order):", csErr);
          }
        }

        renderMultiResult(orderInfo, cars, built.activeIndex);
        setStatus(`ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨. Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ${cars.length} Ø³ÙŠØ§Ø±Ø©.`);

      } catch (err) {
        console.error("Error in handleSearch:", err);
        // Ø§Ø¹Ø±Ø¶ Ø³Ø¨Ø¨ Ø¨Ø³ÙŠØ· Ù„Ùˆ ÙƒØ§Ù†Øª Ù…Ø´ÙƒÙ„Ø© ØµÙ„Ø§Ø­ÙŠØ§Øª
        const msg = (err && err.code === 'permission-denied')
          ? "Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙ„Ø§Ø­ÙŠØ§Øª Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Permission Denied). Ø±Ø§Ø¬Ø¹ Ù‚ÙˆØ§Ø¹Ø¯ Firestore."
          : "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ø§Ù‹.";
        setStatus(msg, true);
        renderEmptyState();
      }

    }

    // Ø±Ø¨Ø· Ø²Ø± Ø§Ù„ØªØªØ¨Ø¹ Ø¨Ø²Ø± Ø§Ù„Ø¨Ø­Ø« ÙˆØ¨Ø²Ø± Ø¥Ù†ØªØ± ÙÙŠ Ø®Ø§Ù†Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
    searchBtn.addEventListener("click", () => handleSearch());
    vinInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        handleSearch();
      }
    });

    // ====== ØªØ´ØºÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ù€ URL ======
    (function autoFromUrl() {
      const params = new URLSearchParams(window.location.search);
      // Ù‡Ù†Ø¹ØªØ¨Ø± Ø£ÙŠ Ù‚ÙŠÙ…Ø© Ù‡Ù†Ø§ Ù…Ù† Ø¯ÙˆÙ„ Ù‡ÙŠ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ø£Ùˆ VIN
      const keyFromUrl =
        params.get("vin") ||
        params.get("order") ||
        params.get("orderNo") ||
        params.get("o");

      if (keyFromUrl) {
        vinInput.value = keyFromUrl.trim();
        handleSearch();
      }
    })();
  </script>
</body>
</html>

